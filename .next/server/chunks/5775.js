"use strict";exports.id=5775,exports.ids=[5775],exports.modules={36759:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{A:()=>h,X:()=>g});var e=c(86165),f=a([e]);e=(f.then?(await f)():f)[0];class g{static async createSession(a,b,c,d,f,g=new Date(Date.now()+2592e6)){try{let h=await (0,e.Ug)("SELECT create_session($1::TEXT, $2::TEXT, $3::TEXT, $4::TEXT, $5::TEXT, $6::TIMESTAMP) as session_id",[a,b,c,d,f,g],5e3);if(h.rows&&h.rows.length>0)return{sessionId:h.rows[0].session_id,userId:a,ipAddress:d,userAgent:f,isActive:!0,createdAt:new Date,lastActiveAt:new Date,expiresAt:g};return null}catch(b){return console.error("Error creating session:",b),console.warn("Session creation failed, but allowing login to continue"),{sessionId:"fallback-session-"+Date.now(),userId:a,ipAddress:d,userAgent:f,isActive:!0,createdAt:new Date,lastActiveAt:new Date,expiresAt:g}}}static async validateSession(a){try{let b=await (0,e.Ug)("SELECT * FROM validate_session($1::TEXT)",[a],5e3);if(b.rows&&b.rows.length>0){let a=b.rows[0];if(!a.isValid)return null;return{sessionId:a.sessionId,userId:a.userId,ipAddress:a.ipAddress,userAgent:a.userAgent,isActive:a.isValid,createdAt:new Date(a.createdAt),lastActiveAt:new Date(a.lastUsedAt),expiresAt:new Date(a.expiresAt)}}return null}catch(a){return console.error("Error validating session:",a),null}}static async revokeSession(a){try{let b=await (0,e.Ug)("SELECT revoke_session($1) as revoked",[a],5e3);return b.rows?.[0]?.revoked===!0}catch(a){return console.error("Error revoking session:",a),!1}}static async revokeAllUserSessions(a){try{let b=await (0,e.Ug)("SELECT revoke_all_user_sessions($1) as revoked_count",[a],5e3);return b.rows?.[0]?.revoked_count||0}catch(a){return console.error("Error revoking all user sessions:",a),0}}static async revokeOtherSessions(a,b){try{let c=await (0,e.Ug)("SELECT revoke_other_sessions($1, $2) as revoked_count",[a,b],5e3);return c.rows?.[0]?.revoked_count||0}catch(a){return console.error("Error revoking other sessions:",a),0}}static async getUserSessions(a){try{let b=await (0,e.Ug)("SELECT * FROM get_user_sessions($1::TEXT)",[a],5e3);if(b.rows&&b.rows.length>0)return b.rows.map(b=>({sessionId:b.sessionId,userId:a,ipAddress:b.ipAddress,userAgent:b.userAgent,isActive:b.isActive,createdAt:new Date(b.createdAt),lastActiveAt:new Date(b.lastUsedAt),expiresAt:new Date(b.expiresAt)}));return[]}catch(a){return console.error("Error getting user sessions:",a),[]}}static async cleanupExpiredSessions(){try{let a=await (0,e.Ug)("SELECT cleanup_expired_sessions() as cleaned_count",[],1e4);return a.rows?.[0]?.cleaned_count||0}catch(a){return console.error("Error cleaning up expired sessions:",a),0}}static async getSessionStats(){try{let a=await (0,e.Ug)("SELECT * FROM get_session_stats()",[],5e3);if(a.rows&&a.rows.length>0){let b=a.rows[0];return{activeSessions:b.active_sessions||0,uniqueUsers:b.unique_users||0,sessionsLast24h:b.sessions_last_24h||0}}return{activeSessions:0,uniqueUsers:0,sessionsLast24h:0}}catch(a){return console.error("Error getting session stats:",a),{activeSessions:0,uniqueUsers:0,sessionsLast24h:0}}}static generateSessionId(){return c(55511).randomBytes(32).toString("hex")}static extractSessionId(a){if(!a)return null;try{let b=c(43759).decode(a);return b?.sessionId||null}catch(b){return a}}static async validateRequestSession(a,b){try{let c=null;if(a?.startsWith("Bearer ")?c=this.extractSessionId(a.substring(7)):b&&(c=this.extractSessionId(b)),!c)return{isValid:!1};let d=await this.validateSession(c);if(!d)return{isValid:!1};return{isValid:!0,session:d,userId:d.userId}}catch(a){return console.error("Error validating request session:",a),{isValid:!1}}}}let h=g;d()}catch(a){d(a)}})},69865:(a,b,c)=>{c.d(b,{Lw:()=>f});var d=c(85171);let e=null;async function f(a,b=[]){let c=function(){if(!e){let a=process.env.DATABASE_URL;if(!a)throw Error("DATABASE_URL is not defined in environment variables");console.log("\uD83D\uDE80 Initializing Neon Serverless SQL connection"),e=(0,d.lw)(a)}return e}();try{console.log(`ðŸ” Executing Neon query: ${a.substring(0,100)}...`);let d=await c.query(a,b),e=Array.isArray(d)?d:[d];return console.log(`âœ… Neon query completed, returned ${e.length} rows`),e}catch(c){throw console.error("âŒ Neon query failed:",c.message),console.error("Query:",a),console.error("Params:",b),c}}},75775:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{Xp:()=>k,ZT:()=>l,_d:()=>m});var e=c(45592),f=c(94307);c(69865);var g=c(8216),h=c(36759),i=c(55511),j=a([f,g,h]);async function k(a,b={}){let c=a.cookies.get("token")?.value,d=a.headers.get("authorization"),j=d?.split(" ")[1],l=c||j;if(!l)return e.NextResponse.json({error:"Access token required"},{status:401});try{let a=(0,f.nr)(l);if(!a||!a.userId||!a.email)return e.NextResponse.json({error:"Invalid token payload"},{status:403});if(b.validateSession){let b=(0,i.createHash)("sha256").update(l).digest("hex"),c=await h.A.validateSession(b);if(!c||!c.isActive)return e.NextResponse.json({error:"Session expired or revoked"},{status:401});let d=await (0,g.Zy)('SELECT id, email, "isActive" FROM "User" WHERE id = $1',[a.userId]);if(!d||!d.isActive)return e.NextResponse.json({error:"User account is inactive"},{status:403})}return{user:{userId:a.userId,email:a.email,isAdmin:a.isAdmin||!1}}}catch(a){return e.NextResponse.json({error:"Invalid or expired token"},{status:403})}}function l(a){return a&&a.isAdmin?{isAdmin:!0}:e.NextResponse.json({error:"Admin access required"},{status:403})}async function m(a){let b=a.cookies.get("token")?.value,c=a.headers.get("authorization"),d=c?.split(" ")[1],e=b||d;if(!e)return{success:!1};try{let a=(0,f.nr)(e);if(!a||!a.userId)return{success:!1};return{success:!0,userId:a.userId}}catch(a){return{success:!1}}}[f,g,h]=j.then?(await j)():j,d()}catch(a){d(a)}})},94307:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{Er:()=>m,HU:()=>o,IY:()=>r,aR:()=>s,b9:()=>n,cC:()=>p,nr:()=>q});var e=c(5486),f=c.n(e),g=c(43759),h=c.n(g),i=c(55511),j=c.n(i),k=c(8216),l=a([k]);async function m(a){return await f().hash(a,10)}async function n(a,b){return await f().compare(a,b)}function o(a,b="24h"){if(!process.env.JWT_SECRET)throw Error("JWT_SECRET is not defined in environment variables");let c=process.env.JWT_SECRET||"fallback-secret";return h().sign(a,c,{expiresIn:b})}function p(a){if(!process.env.JWT_REFRESH_SECRET)throw Error("JWT_REFRESH_SECRET is not defined in environment variables");let b={...a,type:"refresh"},c=process.env.JWT_REFRESH_SECRET||"fallback-refresh-secret";return h().sign(b,c,{expiresIn:"7d"})}function q(a){try{if(!process.env.JWT_SECRET)throw Error("JWT_SECRET is not defined in environment variables");let b=h().verify(a,process.env.JWT_SECRET);if("string"==typeof b)return null;return b}catch(a){return null}}function r(){return j().randomBytes(32).toString("hex")}async function s(){let a=await (0,k.Rn)(async a=>{let b=await (0,k.Zy)('SELECT * FROM "ReferralCounter" WHERE "counterType" = \'NSCREF\'',[]);return b=b?await (0,k.Zy)(`UPDATE "ReferralCounter" SET "currentValue" = "currentValue" + 1 
         WHERE "counterType" = 'NSCREF' RETURNING *`,[]):await (0,k.Zy)(`INSERT INTO "ReferralCounter" ("counterType", "currentValue") 
         VALUES ('NSCREF', 1001) RETURNING *`,[])}),b=`NSCREF${a.currentValue}`;if(await (0,k.Zy)('SELECT * FROM "User" WHERE "referralCode" = $1',[b])){let b=Math.floor(1e3*Math.random()).toString().padStart(3,"0");return`NSCREF${a.currentValue}_${b}`}return b}k=(l.then?(await l)():l)[0],d()}catch(a){d(a)}})}};