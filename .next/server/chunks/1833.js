"use strict";exports.id=1833,exports.ids=[1833,6984],exports.modules={22374:(a,b,c)=>{c.d(b,{Ab:()=>h,DS:()=>i,PK:()=>k,Xe:()=>e,jj:()=>f,oL:()=>j,q_:()=>g});var d=c(40686);function e(a,b){return a*({NEO:.03,NEURAL:.04,ORACLE:.05,TEST_1:.03,TEST_2:.04,TEST_3:.05})[b]}function f(a){if(1===a)return d.Rn.TEST_1;if(2===a)return d.Rn.TEST_2;if(3===a)return d.Rn.TEST_3;if(a>=500&&a<=3e3)return d.Rn.NEO;if(a>=5e3&&a<=1e4)return d.Rn.NEURAL;if(a>=25e3&&a<=5e4)return d.Rn.ORACLE;throw Error("Invalid package amount")}function g(a){return({NEO:50,NEURAL:100,ORACLE:150,TEST_1:1,TEST_2:2,TEST_3:3})[a]}function h(a){return .1*a}function i(a){if(!a)return!0;let b=new Date;return b.setDate(b.getDate()-30),a<=b}function j(a,b){let c=new Date(a||b);return c.setDate(c.getDate()+30),c}function k(a){return[1,2,3,500,1e3,3e3,5e3,1e4,25e3,5e4].includes(a)}},31833:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{DI:()=>m,calculateReferralEarnings:()=>j,distributeReferralEarningsOnChain:()=>l});var e=c(8216),f=c(86165);c(22374);var g=c(74771),h=c(36984),i=a([e,f]);async function j(a,b,c){try{await (0,f.Ug)("SELECT calculate_referral_earnings($1, $2, $3)",[a,b,c],1e4),console.log(`✅ Referral earnings calculated for package ${a}, amount: ${c}`)}catch(a){throw console.error("❌ Error calculating referral earnings:",a),Error(`Failed to calculate referral earnings: ${a}`)}}async function k(a){let b=[],c=a;for(let a=0;a<6;a++){let a=await (0,e.Zy)('SELECT "referredBy" FROM "User" WHERE "id" = $1',[c]);if(!a||!a.referredBy)break;let d=await (0,e.Zy)('SELECT * FROM "User" WHERE "referralCode" = $1',[a.referredBy]);if(!d)break;b.push(d.id),c=d.id}return b}async function l(a,b="BEP20"){let c=`
    SELECT e.*, t.id as "transactionId", t.type as "transactionType", u.id as "userId", u.email, u."walletAddress", u.network
    FROM "Earning" e
    JOIN "Transaction" t ON e."transactionId" = t.id
    JOIN "User" u ON e."userId" = u.id
    WHERE e."packageId" = $1
      AND e.status = 'PAID'
      AND (t."txHash" IS NULL OR t."txHash" = '')
  `,{rows:d}=await (0,e.P)(c,[a]),f=0,i=0,j=0,m="true"===process.env.ENABLE_ONCHAIN_DISTRIBUTION&&"true"!==process.env.WEB3_DISABLED&&"true"!==process.env.NEXT_PUBLIC_WEB3_DISABLED;for(let a of d)try{let c=a.walletAddress,d=Number(a.amount);if(!c||d<=0){await (0,e.g7)('UPDATE "Transaction" SET status = $1, "updatedAt" = $2 WHERE id = $3',["FAILED",new Date,a.transactionId]),await (0,e.g7)('UPDATE "Earning" SET status = $1, "updatedAt" = $2 WHERE id = $3',["FAILED",new Date,a.id]),i++;continue}if(m){let f=await (0,h.RN)(c,d,a.network||b);await (0,e.g7)('UPDATE "Transaction" SET "txHash" = $1, status = $2, "updatedAt" = $3 WHERE id = $4',[f,"COMPLETED",new Date,a.transactionId]),await (0,e.g7)('UPDATE "Earning" SET status = $1, "updatedAt" = $2 WHERE id = $3',["PAID_ONCHAIN",new Date,a.id])}else await (0,e.g7)('UPDATE "Earning" SET status = $1, "updatedAt" = $2 WHERE id = $3',["PAID_OFFCHAIN",new Date,a.id]),await (0,e.g7)('UPDATE "Transaction" SET status = $1, "updatedAt" = $2 WHERE id = $3',["COMPLETED",new Date,a.transactionId]);f++,j+=Number(a.amount)}catch(b){console.error("[Referral] Failed to distribute earning",b,a),i++;try{await (0,e.g7)('UPDATE "Transaction" SET status = $1, "updatedAt" = $2 WHERE id = $3',["FAILED",new Date,a.transactionId]),await (0,e.g7)('UPDATE "Earning" SET status = $1, "updatedAt" = $2 WHERE id = $3',["FAILED",new Date,a.id])}catch(a){console.error("[Referral] Failed to mark transaction/earning as FAILED",a)}}try{let c=await (0,e.Zy)('SELECT p.*, u.id as "purchaserId" FROM "Package" p JOIN "User" u ON p."userId" = u.id WHERE p.id = $1',[a]);if(c){let d=c.purchaserId,f=Number(c.amount),i=await k(d),l=[200,75,50,25,15,10],n=0;for(let a=0;a<Math.min(6,i.length);a++){let b=l[a]/1e4;n+=f*b}let o=Number(n.toFixed(8))-Number(j.toFixed(8));if(o>0){let c=await (0,e.Zy)('SELECT address FROM "PlatformWallet" WHERE network = $1 LIMIT 1',[b]),d=c?.address||process.env.PLATFORM_WALLET_ADDRESS;if(m&&d)try{let c=await (0,h.RN)(d,o,b);await (0,e.g7)('INSERT INTO "Transaction" (id, "userId", type, amount, status, description, "txHash", network, "createdAt", "updatedAt") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)',[(0,g.A)(),null,"PLATFORM_COLLECT",o,"COMPLETED",`Collected lost referral commissions for package ${a}`,c,b,new Date,new Date])}catch(c){console.error("[Referral] Failed to transfer lost commissions to platform wallet",c),await (0,e.g7)('INSERT INTO "Transaction" (id, "userId", type, amount, status, description, network, "createdAt", "updatedAt") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)',[(0,g.A)(),null,"PLATFORM_COLLECT",o,"PENDING",`Failed immediate transfer of lost referral commissions for package ${a}`,b,new Date,new Date])}else await (0,e.g7)('INSERT INTO "Transaction" (id, "userId", type, amount, status, description, network, "createdAt", "updatedAt") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)',[(0,g.A)(),null,"PLATFORM_COLLECT",o,"PENDING",`Lost referral commissions queued for manual processing for package ${a}`,b,new Date,new Date])}}}catch(a){console.error("[Referral] Failed to compute/send lost commissions",a)}return{success:f,failed:i}}async function m(a,b=6){try{let c=await (0,f.Ug)("SELECT * FROM get_referral_tree($1, $2)",[a,b],5e3);if(0===c.rows.length)return{id:a,children:[]};let d=function(a,b){let c={};a.forEach(a=>{c[a.level]||(c[a.level]=[]),c[a.level].push({id:a.id,username:a.username,email:a.email,referralCode:a.referralCode,createdAt:a.createdAt,level:a.level,children:[]})});let d=c[1]?.find(a=>a.id===b);return d?(c[2]&&(d.children=c[2]||[]),d):{id:b,children:[]}}(c.rows,a);return console.log(`✅ Retrieved referral tree for ${a} with ${c.rows.length} nodes`),d}catch(c){return console.error("❌ Error getting optimized referral tree:",c),console.log("⚠️  Falling back to original method..."),n(a,b)}}async function n(a,b=6,c=1){if(c>b)return null;let d=await (0,e.Zy)('SELECT id, username, email, "referralCode", "createdAt" FROM "User" WHERE id = $1',[a]);if(!d)return null;let f=await (0,e.P)('SELECT id, username, email, "createdAt" FROM "User" WHERE "referredBy" = $1',[d.referralCode]),g={...d,level:c,children:[]};for(let a of f){let d=await n(a.id,b,c+1);d&&g.children.push(d)}return g}[e,f]=i.then?(await i)():i,d()}catch(a){d(a)}})},36984:(a,b,c)=>{c.d(b,{RN:()=>k,RV:()=>e,kE:()=>h,verifyBep20Transaction:()=>f,verifyTrc20Transaction:()=>g});var d=c(40686);function e(a){return a===d.lg.BEP20?process.env.ADMIN_WALLET_BSC||"":process.env.ADMIN_WALLET_TRON||""}async function f(a,b,c){return!0}async function g(a,b,c){return!0}async function h(a,b=d.lg.BEP20,c,e){return!0}async function i(a,b){return`OFFCHAIN_BEP20_${Date.now()}`}async function j(a,b){return`OFFCHAIN_TRC20_${Date.now()}`}async function k(a,b,c){return c===d.lg.BEP20?await i(a,b):await j(a,b)}},40686:(a,b,c)=>{c.d(b,{II:()=>i,Rn:()=>g,lg:()=>h});var d,e,f,g=((d={}).NEO="NEO",d.NEURAL="NEURAL",d.ORACLE="ORACLE",d.TEST_1="TEST_1",d.TEST_2="TEST_2",d.TEST_3="TEST_3",d),h=((e={}).BEP20="BEP20",e.TRC20="TRC20",e),i=((f={}).ROI_ONLY="ROI_ONLY",f.CAPITAL="CAPITAL",f.FULL_AMOUNT="FULL_AMOUNT",f)}};