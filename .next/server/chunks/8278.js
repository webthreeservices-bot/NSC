"use strict";exports.id=8278,exports.ids=[8278],exports.modules={16853:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{U9:()=>m,Zy:()=>e.Zy,nV:()=>i,t6:()=>j,vt:()=>k,yo:()=>l});var e=c(67015),f=a([e]);function g(a){let b=[],c=[];return Object.entries(a).forEach(([a,d],e)=>{null===d?b.push(`"${a}" IS NULL`):"object"==typeof d?Object.entries(d).forEach(([d,e])=>{switch(d){case"lt":b.push(`"${a}" < $${c.length+1}`),c.push(e);break;case"gt":b.push(`"${a}" > $${c.length+1}`),c.push(e);break;case"lte":b.push(`"${a}" <= $${c.length+1}`),c.push(e);break;case"gte":b.push(`"${a}" >= $${c.length+1}`),c.push(e);break;case"in":b.push(`"${a}" = ANY($${c.length+1})`),c.push(Array.isArray(e)?e:[e]);break;default:console.warn(`Unsupported operator: ${d}`)}}):(b.push(`"${a}" = $${c.length+1}`),c.push(d))}),{sql:b.length>0?"WHERE "+b.join(" AND "):"",params:c}}function h(a){return a&&0!==Object.keys(a).length?Object.entries(a).filter(([a,b])=>b).map(([a])=>`"${a}"`).join(", "):"*"}async function i(a,b={}){let c,{where:d,select:f,orderBy:j,take:k,skip:l}=b,m=g(d||{}),n=h(f),o=function(a){if(!a)return"";let b=Object.entries(a).map(([a,b])=>`"${a}" ${b.toUpperCase()}`).join(", ");return b?`ORDER BY ${b}`:""}(j),p=(c=[],void 0!==k&&c.push(`LIMIT ${k}`),void 0!==l&&c.push(`OFFSET ${l}`),c.join(" ")),q=`
    SELECT ${n}
    FROM "${a}"
    ${m.sql}
    ${o}
    ${p}
  `.trim();return(0,e.P)(q,m.params)}async function j(a,b){let{where:c,select:d}=b,f=g(c),i=h(d),j=`
    SELECT ${i}
    FROM "${a}"
    ${f.sql}
    LIMIT 1
  `.trim();return(0,e.Zy)(j,f.params)}async function k(a,b){let{data:c}=b,d=Object.keys(c).map(a=>`"${a}"`).join(", "),f=Object.keys(c).map((a,b)=>`$${b+1}`).join(", "),g=Object.values(c),h=`
    INSERT INTO "${a}" (${d})
    VALUES (${f})
    RETURNING *
  `.trim(),i=await (0,e.Zy)(h,g);if(!i)throw Error(`Failed to create record in ${a}`);return i}async function l(a,b){let{where:c,data:d}=b,f=g(c),h=Object.keys(d).map((a,b)=>`"${a}" = $${b+1}`).join(", "),i=[...Object.values(d),...f.params],j=`
    UPDATE "${a}"
    SET ${h}
    ${f.sql}
    RETURNING *
  `.trim(),k=await (0,e.Zy)(j,i);if(!k)throw Error(`Failed to update record in ${a}`);return k}async function m(a,b={}){let{where:c}=b,d=g(c||{}),f=`
    SELECT COUNT(*) as count
    FROM "${a}"
    ${d.sql}
  `.trim(),h=await (0,e.BR)(f,d.params);return h?parseInt(h,10):0}e=(f.then?(await f)():f)[0],d()}catch(a){d(a)}})},67015:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{BR:()=>i,P:()=>g,Zy:()=>h});var e=c(86165),f=a([e]);async function g(a,b){try{return(await e.Ay.query(a,b)).rows}catch(c){throw console.error("Query error:",{sql:a,params:b,error:c}),c}}async function h(a,b){let c=await g(a,b);return c.length>0?c[0]:null}async function i(a,b){let c=await g(a,b);if(0===c.length)return null;let d=c[0];return Object.values(d)[0]}e=(f.then?(await f)():f)[0];d()}catch(a){d(a)}})},68278:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.d(b,{KL:()=>j,S6:()=>n,XL:()=>l,aN:()=>i,qU:()=>k,xm:()=>m});var e=c(5932),f=c(74771),g=c(16853),h=a([g]);async function i(a){var b,c,d,h;let{userId:i,purpose:j,amount:k,network:l,metadata:m={}}=a;if(k<=0)throw Error("Invalid payment amount");let n=function(a){if("BEP20"===a)return process.env.ADMIN_WALLET_BSC||"";if("TRC20"===a)return process.env.ADMIN_WALLET_TRON||"";throw Error("Invalid network")}(l),o=new Date(Date.now()+18e5),p=function(a,b,c){if("BEP20"===a){let a=process.env.USDT_CONTRACT_BSC;return`ethereum:${b}@56?value=0&token=${a}&amount=${c}`}if("TRC20"===a){let a=process.env.USDT_CONTRACT_TRON;return`tron:${b}?amount=${c}&token=${a}`}return b}(l,n,k),q=await e.toDataURL(p,{errorCorrectionLevel:"H",type:"image/png",width:400,margin:2,color:{dark:"#000000",light:"#FFFFFF"}}),r=await (0,g.vt)("PaymentRequest",{data:{id:(0,f.A)(),userId:i,purpose:j,amount:k,network:l,depositAddress:n,qrCodeData:q,status:"PENDING",expiresAt:o,metadata:m,createdAt:new Date,updatedAt:new Date}}),s=Math.floor((o.getTime()-Date.now())/1e3),t=function(a){if("BEP20"===a)return{name:"Binance Smart Chain (BSC)",token:"USDT (BEP20)",decimals:18,confirmationsRequired:3,chainId:56,explorer:"https://bscscan.com"};if("TRC20"===a)return{name:"TRON",token:"USDT (TRC20)",decimals:6,confirmationsRequired:19,chainId:null,explorer:"https://tronscan.org"};throw Error("Invalid network")}(l),u=(b=l,c=n,d=k,h=r.id,{step1:`Open your crypto wallet and select ${"BEP20"===b?"BEP20 (BSC)":"TRC20 (TRON)"} network`,step2:`Scan the QR code or copy the deposit address: ${c}`,step3:`Send exactly ${d} USDT to the address`,step4:"Wait for confirmation. You can track the status on this page."});return{id:r.id,userId:r.userId,purpose:r.purpose,amount:Number(r.amount),network:r.network,depositAddress:r.depositAddress,qrCode:q,qrCodeImageUrl:`/api/payments/${r.id}/qr`,status:r.status,expiresAt:r.expiresAt,expiresIn:s,instructions:u,networkInfo:t,metadata:r.metadata}}async function j(a){let b=await (0,g.t6)("PaymentRequest",{where:{id:a}});if(!b)throw Error("Payment request not found");"PENDING"===b.status&&new Date>new Date(b.expiresAt)&&(await (0,g.yo)("PaymentRequest",{where:{id:a},data:{status:"EXPIRED",updatedAt:new Date}}),b.status="EXPIRED");let c=null;if(b.txHash){let a=await (0,g.t6)("TransactionConfirmation",{where:{txHash:b.txHash}});a&&(c={txHash:a.txHash,confirmations:a.confirmations,requiredConfirmations:a.requiredConfirmations,isConfirmed:a.isConfirmed,progress:Math.min(100,a.confirmations/a.requiredConfirmations*100)})}return{id:b.id,status:b.status,amount:Number(b.amount),amountReceived:b.amountReceived?Number(b.amountReceived):null,network:b.network,txHash:b.txHash,confirmations:b.confirmations,confirmationInfo:c,expiresAt:b.expiresAt,completedAt:b.completedAt,createdAt:b.createdAt}}async function k(a,b){let c={userId:a};return b&&(c.status=b),(await (0,g.nV)("PaymentRequest",{where:c,orderBy:{createdAt:"desc"}})).map(a=>({id:a.id,purpose:a.purpose,amount:Number(a.amount),network:a.network,status:a.status,txHash:a.txHash,confirmations:a.confirmations,expiresAt:a.expiresAt,completedAt:a.completedAt,createdAt:a.createdAt}))}async function l(a,b){let d=await (0,g.t6)("PaymentRequest",{where:{id:a}});if(!d)throw Error("Payment request not found");if("PENDING"!==d.status)throw Error("Payment request is not pending");let{verifyBep20Transaction:e,verifyTrc20Transaction:h}=await c.e(6984).then(c.bind(c,36984)),i=!1;try{if("BEP20"===d.network)i=await e(b,Number(d.amount),d.depositAddress);else if("TRC20"===d.network)i=await h(b,Number(d.amount),d.depositAddress);else throw Error("Unsupported network");if(!i)throw Error("Transaction verification failed or does not match required criteria");return await (0,g.yo)("PaymentRequest",{where:{id:a},data:{status:"AWAITING_ADMIN_APPROVAL",txHash:b,updatedAt:new Date}}),await (0,g.vt)("TransactionConfirmation",{data:{id:(0,f.A)(),paymentRequestId:d.id,txHash:b,network:d.network,confirmations:0,requiredConfirmations:"BEP20"===d.network?3:19,blockNumber:0,amount:Number(d.amount),fromAddress:"",toAddress:d.depositAddress,isConfirmed:!1,lastCheckedAt:new Date,createdAt:new Date,updatedAt:new Date}}),{success:!0,message:"Payment verification initiated",confirmations:0}}catch(a){throw Error(`Payment verification failed: ${a instanceof Error?a.message:"Unknown error"}`)}}async function m(){let a=new Date,b=await (0,g.nV)("PaymentRequest",{where:{status:"PENDING",expiresAt:{lt:a}}});for(let a of b)await (0,g.yo)("PaymentRequest",{where:{id:a.id},data:{status:"EXPIRED",updatedAt:new Date}});return console.log(`Expired ${b.length} old payment requests`),b.length}async function n(a){let b=a?{userId:a}:{},[c,d,e,f,h,i]=await Promise.all([(0,g.U9)("PaymentRequest",{where:b}),(0,g.U9)("PaymentRequest",{where:{...b,status:"PENDING"}}),(0,g.U9)("PaymentRequest",{where:{...b,status:"CONFIRMING"}}),(0,g.U9)("PaymentRequest",{where:{...b,status:"COMPLETED"}}),(0,g.U9)("PaymentRequest",{where:{...b,status:"EXPIRED"}}),(0,g.U9)("PaymentRequest",{where:{...b,status:"FAILED"}})]),j=(await (0,g.nV)("PaymentRequest",{where:{...b,status:"COMPLETED"},select:{amount:!0}})).reduce((a,b)=>a+Number(b.amount),0);return{total:c,pending:d,confirming:e,completed:f,expired:h,failed:i,totalAmount:j,successRate:c>0?(f/c*100).toFixed(2):"0.00"}}g=(h.then?(await h)():h)[0],d()}catch(a){d(a)}})}};