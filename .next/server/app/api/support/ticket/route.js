"use strict";(()=>{var a={};a.id=2794,a.ids=[2794],a.modules={261:a=>{a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:a=>{a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},27910:a=>{a.exports=require("stream")},28354:a=>{a.exports=require("util")},29294:a=>{a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},32359:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{handler:()=>z,patchFetch:()=>y,routeModule:()=>A,serverHooks:()=>D,workAsyncStorage:()=>B,workUnitAsyncStorage:()=>C});var e=c(19225),f=c(84006),g=c(8317),h=c(99373),i=c(34775),j=c(98564),k=c(48575),l=c(261),m=c(54365),n=c(90771),o=c(73461),p=c(67798),q=c(92280),r=c(62018),s=c(45696),t=c(47929),u=c(86439),v=c(37527),w=c(57953),x=a([w]);w=(x.then?(await x)():x)[0];let A=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/support/ticket/route",pathname:"/api/support/ticket",filename:"route",bundlePath:"app/api/support/ticket/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"C:\\Users\\LENOVO\\Desktop\\nsc-test\\vercel-download\\src\\app\\api\\support\\ticket\\route.ts",nextConfigOutput:"",userland:w}),{workAsyncStorage:B,workUnitAsyncStorage:C,serverHooks:D}=A;function y(){return(0,g.patchFetch)({workAsyncStorage:B,workUnitAsyncStorage:C})}async function z(a,b,c){A.isDev&&(0,h.addRequestMeta)(a,"devRequestTimingInternalsEnd",process.hrtime.bigint());let d="/api/support/ticket/route";"/index"===d&&(d="/");let e=await A.prepare(a,b,{srcPage:d,multiZoneDraftMode:!1});if(!e)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:g,params:w,nextConfig:x,parsedUrl:y,isDraftMode:z,prerenderManifest:B,routerServerContext:C,isOnDemandRevalidate:D,revalidateOnlyGenerated:E,resolvedPathname:F,clientReferenceManifest:G,serverActionsManifest:H}=e,I=(0,l.normalizeAppPath)(d),J=!!(B.dynamicRoutes[I]||B.routes[F]),K=async()=>((null==C?void 0:C.render404)?await C.render404(a,b,y,!1):b.end("This page could not be found"),null);if(J&&!z){let a=!!B.routes[F],b=B.dynamicRoutes[I];if(b&&!1===b.fallback&&!a){if(x.experimental.adapterPath)return await K();throw new u.NoFallbackError}}let L=null;!J||A.isDev||z||(L=F,L="/index"===L?"/":L);let M=!0===A.isDev||!J,N=J&&!M;H&&G&&(0,j.setReferenceManifestsSingleton)({page:d,clientReferenceManifest:G,serverActionsManifest:H,serverModuleMap:(0,k.createServerModuleMap)({serverActionsManifest:H})});let O=a.method||"GET",P=(0,i.getTracer)(),Q=P.getActiveScopeSpan(),R={params:w,prerenderManifest:B,renderOpts:{experimental:{authInterrupts:!!x.experimental.authInterrupts},cacheComponents:!!x.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:x.cacheLife,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>A.onRequestError(a,b,d,C)},sharedContext:{buildId:g}},S=new m.NodeNextRequest(a),T=new m.NodeNextResponse(b),U=n.NextRequestAdapter.fromNodeNextRequest(S,(0,n.signalFromNodeResponse)(b));try{let e=async a=>A.handle(U,R).finally(()=>{if(!a)return;a.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let c=P.getRootSpanAttributes();if(!c)return;if(c.get("next.span_type")!==o.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${c.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=c.get("next.route");if(e){let b=`${O} ${e}`;a.setAttributes({"next.route":e,"http.route":e,"next.span_name":b}),a.updateName(b)}else a.updateName(`${O} ${d}`)}),g=!!(0,h.getRequestMeta)(a,"minimalMode"),j=async h=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!g&&D&&E&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let d=await e(h);a.fetchMetrics=R.renderOpts.fetchMetrics;let i=R.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=R.renderOpts.collectedTags;if(!J)return await (0,q.I)(S,T,d,R.renderOpts.pendingWaitUntil),null;{let a=await d.blob(),b=(0,r.toNodeOutgoingHttpHeaders)(d.headers);j&&(b[t.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==R.renderOpts.collectedRevalidate&&!(R.renderOpts.collectedRevalidate>=t.INFINITE_CACHE)&&R.renderOpts.collectedRevalidate,e=void 0===R.renderOpts.collectedExpire||R.renderOpts.collectedExpire>=t.INFINITE_CACHE?void 0:R.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:d.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:e}}}}catch(b){throw(null==f?void 0:f.isStale)&&await A.onRequestError(a,b,{routerKind:"App Router",routePath:d,routeType:"route",revalidateReason:(0,p.c)({isStaticGeneration:N,isOnDemandRevalidate:D})},C),b}},l=await A.handleResponse({req:a,nextConfig:x,cacheKey:L,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:B,isRoutePPREnabled:!1,isOnDemandRevalidate:D,revalidateOnlyGenerated:E,responseGenerator:k,waitUntil:c.waitUntil,isMinimalMode:g});if(!J)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});g||b.setHeader("x-nextjs-cache",D?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),z&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,r.fromNodeOutgoingHttpHeaders)(l.value.headers);return g&&J||m.delete(t.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,s.getCacheControlHeader)(l.cacheControl)),await (0,q.I)(S,T,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};Q?await j(Q):await P.withPropagatedContext(a.headers,()=>P.trace(o.BaseServerSpan.handleRequest,{spanName:`${O} ${d}`,kind:i.SpanKind.SERVER,attributes:{"http.method":O,"http.target":a.url}},j))}catch(b){if(b instanceof u.NoFallbackError||await A.onRequestError(a,b,{routerKind:"App Router",routePath:I,routeType:"route",revalidateReason:(0,p.c)({isStaticGeneration:N,isOnDemandRevalidate:D})}),J)throw b;return await (0,q.I)(S,T,new Response(null,{status:500})),null}}d()}catch(a){d(a)}})},44870:a=>{a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:a=>{a.exports=require("crypto")},57953:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{GET:()=>l,POST:()=>k,dynamic:()=>m,revalidate:()=>n});var e=c(45592),f=c(8216),g=c(86165),h=c(86848),i=a([f,g]);[f,g]=i.then?(await i)():i;let m="force-dynamic",n=0,o=h.Ik({subject:h.Yj().min(5,"Subject must be at least 5 characters"),category:h.k5(["general","technical","payment","withdrawal","account","referral"]),message:h.Yj().min(10,"Message must be at least 10 characters")});async function j(a){let b=a.headers.get("Authorization");if(!b||!b.startsWith("Bearer "))return null;let d=b.substring(7);try{let a=c(43759),b=process.env.JWT_SECRET;if(!b)return console.error("JWT_SECRET not configured"),null;return a.verify(d,b).userId}catch(a){return console.error("Token verification error:",a),null}}async function k(a){let b=null;try{b=await a.json()}catch(a){return console.error("Body parsing error:",a),e.NextResponse.json({error:"Invalid request body"},{status:400})}try{let c=await j(a);if(!c)return e.NextResponse.json({error:"Unauthorized. Please log in."},{status:401});let d=o.safeParse(b);if(!d.success)return e.NextResponse.json({error:"Validation failed",details:d.error.errors},{status:400});let{subject:h,category:i,message:k}=d.data;try{if(!await (0,f.Zy)('SELECT id, email, "fullName", username FROM "User" WHERE id = $1',[c]))return e.NextResponse.json({error:"User not found"},{status:404})}catch(a){return console.error("Database error fetching user:",a),e.NextResponse.json({error:"Service temporarily unavailable"},{status:503})}try{await g.Ay.query(`
        CREATE TABLE IF NOT EXISTS "SupportTicket" (
          "id" TEXT PRIMARY KEY DEFAULT uuid_generate_v4()::text,
          "userId" TEXT NOT NULL,
          "subject" TEXT NOT NULL,
          "category" TEXT NOT NULL,
          "message" TEXT NOT NULL,
          "status" TEXT NOT NULL DEFAULT 'OPEN',
          "priority" TEXT NOT NULL DEFAULT 'NORMAL',
          "assignedTo" TEXT,
          "response" TEXT,
          "createdAt" TIMESTAMP NOT NULL DEFAULT NOW(),
          "updatedAt" TIMESTAMP NOT NULL DEFAULT NOW(),
          "resolvedAt" TIMESTAMP
        )
      `);let b=`ticket_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,d=(await g.Ay.query(`INSERT INTO "SupportTicket" 
         ("id", "userId", "subject", "category", "message", "status", "priority", "createdAt", "updatedAt")
         VALUES ($1, $2, $3, $4, $5, 'OPEN', 'NORMAL', NOW(), NOW())
         RETURNING *`,[b,c,h,i,k])).rows[0];try{await g.Ay.query(`INSERT INTO "UserActivityLog" 
           ("id", "userId", "action", "details", "ipAddress", "createdAt")
           VALUES ($1, $2, $3, $4, $5, NOW())`,[`activity_${Date.now()}`,c,"SUPPORT_TICKET_CREATED",JSON.stringify({ticketId:b,category:i,subject:h}),a.headers.get("x-forwarded-for")||a.headers.get("x-real-ip")||"unknown"])}catch(a){console.error("Failed to log activity:",a)}return e.NextResponse.json({success:!0,message:"Support ticket submitted successfully",ticket:{id:d.id,subject:d.subject,category:d.category,status:d.status,createdAt:d.createdAt}})}catch(a){if(console.error("Database error creating ticket:",a),a.message?.includes("timeout"))return e.NextResponse.json({error:"Request timeout. Please try again."},{status:503});return e.NextResponse.json({error:"Failed to create support ticket. Please try again."},{status:500})}}catch(b){console.error("Support ticket creation error:",b);let a="Failed to create support ticket";return b.message?.includes("timeout")?a="Request timeout. Please check your connection and try again.":b.message?.includes("connect")&&(a="Service temporarily unavailable. Please try again later."),e.NextResponse.json({error:a},{status:500})}}async function l(a){try{let b=await j(a);if(!b)return e.NextResponse.json({error:"Unauthorized. Please log in."},{status:401});let c=await g.Ay.query(`SELECT * FROM "SupportTicket" 
       WHERE "userId" = $1 
       ORDER BY "createdAt" DESC 
       LIMIT 50`,[b]);return e.NextResponse.json({success:!0,tickets:c.rows})}catch(a){return console.error("Error fetching tickets:",a),e.NextResponse.json({error:"Failed to fetch support tickets"},{status:500})}}d()}catch(a){d(a)}})},63033:a=>{a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},64939:a=>{a.exports=import("pg")},79428:a=>{a.exports=require("buffer")},86439:a=>{a.exports=require("next/dist/shared/lib/no-fallback-error.external")}};var b=require("../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[134,1813,3759,6848,1204],()=>b(b.s=32359));module.exports=c})();