*** File: 00_MASTER_SCHEMA.sql (changes: 3450)
- 23: \echo '============================================================================'
+ 23: 
- 24: \echo 'NSC Bot Platform - Complete Database Schema Installation'
+ 24: 
- 25: \echo '============================================================================'
+ 25: -- Begin included: 01_enums.sql
- 26: 
+ 26: -- ============================================================================
- 27: \echo 'Step 1/9: Creating ENUM types...'
+ 27: -- ENUM TYPES - All enumerated types used in the platform
- 28: \i database-schema/01_enums.sql
+ 28: -- ============================================================================
- 30: \echo 'Step 2/9: Creating core tables (User, Package, Bot)...'
+ 30: -- User roles
- 31: \i database-schema/02_core_tables.sql
+ 31: DO $$ BEGIN
- 32: 
+ 32:   CREATE TYPE "UserRole" AS ENUM ('USER', 'ADMIN', 'SUPER_ADMIN');
- 33: \echo 'Step 3/9: Creating financial tables (Transaction, Withdrawal, Payment)...'
+ 33: EXCEPTION
- 34: \i database-schema/03_financial_tables.sql
+ 34:   WHEN duplicate_object THEN null;
- 35: 
+ 35: END $$;
- 36: \echo 'Step 4/9: Creating system tables (Settings, Logs, Sessions)...'
+ 36: 
- 37: \i database-schema/04_system_tables.sql
+ 37: -- Package types
- 38: 
+ 38: DO $$ BEGIN
- 39: \echo 'Step 5/9: Creating PostgreSQL functions...'
+ 39:   CREATE TYPE "PackageType" AS ENUM ('NEO', 'NEURAL', 'ORACLE');
- 40: \i database-schema/05_functions.sql
+ 40: EXCEPTION
- 41: 
+ 41:   WHEN duplicate_object THEN null;
- 42: \echo 'Step 6/9: Creating triggers...'
+ 42: END $$;
- 43: \i database-schema/06_triggers.sql
+ 43: 
- 44: 
+ 44: -- Package status lifecycle
- 45: \echo 'Step 7/9: Creating views...'
+ 45: DO $$ BEGIN
- 46: \i database-schema/07_views.sql
+ 46:   CREATE TYPE "PackageStatus" AS ENUM (
- 47: 
+ 47:     'PENDING',      -- Payment pending
- 48: \echo 'Step 8/9: Inserting initial/seed data...'
+ 48:     'ACTIVE',       -- Active and earning ROI
- 49: \i database-schema/08_initial_data.sql
+ 49:     'EXPIRED',      -- 12 months completed
- 50: 
+ 50:     'WITHDRAWN',    -- Capital withdrawn
- 51: \echo 'Step 9/9: Creating optimization indexes...'
+ 51:     'CANCELLED',    -- Cancelled by admin
- 52: \i database-schema/09_indexes_optimization.sql
+ 52:     'COMPLETED'     -- Fully completed
- 53: 
+ 53:   );
- 54: \echo '============================================================================'
+ 54: EXCEPTION
- 55: \echo 'Schema installation complete!'
+ 55:   WHEN duplicate_object THEN null;
- 56: \echo '============================================================================'
+ 56: END $$;
- 58: -- Run verification queries
+ 58: -- Transaction types (comprehensive list from all 94 API endpoints)
- 59: \echo 'Verifying installation...'
+ 59: DO $$ BEGIN
- 60: SELECT 
+ 60:   CREATE TYPE "TransactionType" AS ENUM (
- 61:   'Tables' as object_type,
+ 61:     'DEPOSIT',           -- User deposit
- 62:   COUNT(*) as count
+ 62:     'WITHDRAWAL',        -- User withdrawal
- 63: FROM information_schema.tables 
+ 63:     'BOT_FEE',          -- Bot activation fee
- 64: WHERE table_schema = 'public'
+ 64:     'BOT_ACTIVATION',   -- Bot activation transaction
- 65: UNION ALL
+ 65:     'ROI_PAYMENT',      -- Monthly ROI payment
- 66: SELECT 
+ 66:     'REFERRAL_BONUS',   -- Direct referral bonus
- 67:   'Functions',
+ 67:     'LEVEL_INCOME',     -- Multi-level income
- 68:   COUNT(*)
+ 68:     'CAPITAL_RETURN',   -- Capital return on expiry
- 69: FROM information_schema.routines
+ 69:     'PACKAGE_PURCHASE', -- Package purchase
- 70: WHERE routine_schema = 'public'
+ 70:     'ADMIN_CREDIT',     -- Manual credit by admin
- 71: UNION ALL
+ 71:     'ADMIN_DEBIT'       -- Manual debit by admin
- 72: SELECT
+ 72:   );
- 73:   'Indexes',
+ 73: EXCEPTION
- 74:   COUNT(*)
+ 74:   WHEN duplicate_object THEN null;
- 75: FROM pg_indexes
+ 75: END $$;
- 76: WHERE schemaname = 'public';
+ 76: 
- 77: 
+ 77: -- Transaction status
- 78: \echo 'Installation verified. Check counts above.'
+ 78: DO $$ BEGIN
- 79: 
+ 79:   CREATE TYPE "TransactionStatus" AS ENUM (
- 80: 
+ 80:     'PENDING',      -- Initiated
- 81: 
+ 81:     'CONFIRMING',   -- Blockchain confirmation in progress
- 82: 
+ 82:     'COMPLETED',    -- Successfully completed
- 83: 
+ 83:     'FAILED',       -- Transaction failed
- 84: 
+ 84:     'REJECTED'      -- Rejected by admin
- 85: 
+ 85:   );
- 86: 
+ 86: EXCEPTION
- 87: 
+ 87:   WHEN duplicate_object THEN null;
- 88: 
+ 88: END $$;
- 90: 
+ 90: -- Earning types
- 91: 
+ 91: DO $$ BEGIN
- 92: 
+ 92:   CREATE TYPE "EarningType" AS ENUM (
- 93: 
+ 93:     'DIRECT_REFERRAL',  -- Direct referral (Level 0) - 2%
- 94: 
+ 94:     'LEVEL_INCOME',     -- Level 1-6 income
- 95: 
+ 95:     'REFERRAL',         -- Generic referral
- 96: 
+ 96:     'ROI',              -- ROI payment
- 97: 
+ 97:     'DIRECT',           -- Direct earning
- 98: 
+ 98:     'BONUS'             -- Special bonus
- 99: 
+ 99:   );
- 100: 
+ 100: EXCEPTION
- 101: 
+ 101:   WHEN duplicate_object THEN null;
- 102: 
+ 102: END $$;
- 104: 
+ 104: -- Withdrawal status
- 105: 
+ 105: DO $$ BEGIN
- 106: 
+ 106:   CREATE TYPE "WithdrawalStatus" AS ENUM (
- 107: 
+ 107:     'PENDING',      -- Waiting for admin approval
- 108: 
+ 108:     'APPROVED',     -- Approved by admin
- 109: 
+ 109:     'PROCESSING',   -- Being processed
- 110: 
+ 110:     'COMPLETED',    -- Sent to user
- 111: 
+ 111:     'REJECTED',     -- Rejected by admin
- 112: 
+ 112:     'CANCELLED'     -- Cancelled by user/admin
- 113: 
+ 113:   );
- 114: 
+ 114: EXCEPTION
- 115: 
+ 115:   WHEN duplicate_object THEN null;
- 116: 
+ 116: END $$;
- 118: 
+ 118: -- Withdrawal types
- 119: 
+ 119: DO $$ BEGIN
- 120: 
+ 120:   CREATE TYPE "WithdrawalType" AS ENUM (
- 121: 
+ 121:     'ROI_ONLY',      -- Only ROI earnings
- 122: 
+ 122:     'CAPITAL',       -- Capital + ROI
- 123: 
+ 123:     'CAPITAL_ONLY',  -- Only capital
- 124: 
+ 124:     'FULL_AMOUNT'    -- Everything available
- 125: 
+ 125:   );
- 126: 
+ 126: EXCEPTION
- 127: 
+ 127:   WHEN duplicate_object THEN null;
- 128: 
+ 128: END $$;
- 130: 
+ 130: -- KYC status
- 131: 
+ 131: DO $$ BEGIN
- 132: 
+ 132:   CREATE TYPE "KYCStatus" AS ENUM (
- 133: 
+ 133:     'PENDING',       -- Not submitted or under review
- 134: 
+ 134:     'SUBMITTED',     -- Submitted for review
- 135: 
+ 135:     'APPROVED',      -- Verified
- 136: 
+ 136:     'REJECTED',      -- Rejected
- 137: 
+ 137:     'RESUBMIT'       -- Need to resubmit
- 138: 
+ 138:   );
- 139: 
+ 139: EXCEPTION
- 140: 
+ 140:   WHEN duplicate_object THEN null;
- 141: 
+ 141: END $$;
- 143: 
+ 143: -- Payment request status
- 144: 
+ 144: DO $$ BEGIN
- 145: 
+ 145:   CREATE TYPE "PaymentStatus" AS ENUM (
- 146: 
+ 146:     'PENDING',       -- Waiting for payment
- 147: 
+ 147:     'CONFIRMING',    -- Payment received, confirming
- 148: 
+ 148:     'AWAITING_ADMIN_APPROVAL', -- Awaiting admin approval after on-chain verification
- 149: 
+ 149:     'COMPLETED',     -- Confirmed and processed
- 150: 
+ 150:     'FAILED',        -- Payment failed
- 151: 
+ 151:     'EXPIRED',       -- Payment window expired
- 152: 
+ 152:     'CANCELLED'      -- Cancelled
- 153: 
+ 153:   );
- 154: 
+ 154: EXCEPTION
- 155: 
+ 155:   WHEN duplicate_object THEN null;
- 156: 
+ 156: END $$;
- 158: 
+ 158: -- Notification types
- 159: 
+ 159: DO $$ BEGIN
- 160: 
+ 160:   CREATE TYPE "NotificationType" AS ENUM (
- 161: 
+ 161:     'INFO',
- 162: 
+ 162:     'SUCCESS',
- 163: 
+ 163:     'WARNING',
- 164: 
+ 164:     'ERROR',
- 165: 
+ 165:     'PAYMENT',
- 166: 
+ 166:     'WITHDRAWAL',
- 167: 
+ 167:     'REFERRAL',
- 168: 
+ 168:     'ROI',
- 169: 
+ 169:     'KYC',
- 170: 
+ 170:     'SECURITY'
- 171: 
+ 171:   );
- 172: 
+ 172: EXCEPTION
- 173: 
+ 173:   WHEN duplicate_object THEN null;
- 174: 
+ 174: END $$;
- 176: 
+ 176: -- Support ticket status
- 177: 
+ 177: DO $$ BEGIN
- 178: 
+ 178:   CREATE TYPE "TicketStatus" AS ENUM (
- 179: 
+ 179:     'OPEN',
- 180: 
+ 180:     'IN_PROGRESS',
- 181: 
+ 181:     'WAITING_USER',
- 182: 
+ 182:     'WAITING_ADMIN',
- 183: 
+ 183:     'RESOLVED',
- 184: 
+ 184:     'CLOSED',
- 185: 
+ 185:     'REOPENED'
- 186: 
+ 186:   );
- 187: 
+ 187: EXCEPTION
- 188: 
+ 188:   WHEN duplicate_object THEN null;
- 189: 
+ 189: END $$;
- 191: 
+ 191: -- Support ticket priority
- 192: 
+ 192: DO $$ BEGIN
- 193: 
+ 193:   CREATE TYPE "TicketPriority" AS ENUM (
- 194: 
+ 194:     'LOW',
- 195: 
+ 195:     'MEDIUM',
- 196: 
+ 196:     'HIGH',
- 197: 
+ 197:     'URGENT',
- 198: 
+ 198:     'CRITICAL'
- 199: 
+ 199:   );
- 200: 
+ 200: EXCEPTION
- 201: 
+ 201:   WHEN duplicate_object THEN null;
- 202: 
+ 202: END $$;
- 204: 
+ 204: -- Admin action types (from admin APIs)
- 205: 
+ 205: DO $$ BEGIN
- 206: 
+ 206:   CREATE TYPE "AdminActionType" AS ENUM (
- 207: 
+ 207:     'APPROVE_WITHDRAWAL',
- 208: 
+ 208:     'REJECT_WITHDRAWAL',
- 209: 
+ 209:     'APPROVE_PACKAGE',
- 210: 
+ 210:     'REJECT_PACKAGE',
- 211: 
+ 211:     'UPDATE_SETTING',
- 212: 
+ 212:     'APPROVE_KYC',
- 213: 
+ 213:     'REJECT_KYC',
- 214: 
+ 214:     'BLOCK_USER',
- 215: 
+ 215:     'UNBLOCK_USER',
- 216: 
+ 216:     'CREDIT_BALANCE',
- 217: 
+ 217:     'DEBIT_BALANCE',
- 218: 
+ 218:     'TRIGGER_ROI',
- 219: 
+ 219:     'TRIGGER_EXPIRATION',
- 220: 
+ 220:     'UPDATE_USER',
- 221: 
+ 221:     'DELETE_USER',
- 222: 
+ 222:     'VIEW_STATISTICS',
- 223: 
+ 223:     'EXPORT_DATA'
- 224: 
+ 224:   );
- 225: 
+ 225: EXCEPTION
- 226: 
+ 226:   WHEN duplicate_object THEN null;
- 227: 
+ 227: END $$;
- 229: 
+ 229: -- Blockchain networks
- 230: 
+ 230: DO $$ BEGIN
- 231: 
+ 231:   CREATE TYPE "Network" AS ENUM (
- 232: 
+ 232:     'BEP20',   -- Binance Smart Chain
- 233: 
+ 233:     'TRC20',   -- TRON
- 234: 
+ 234:     'ERC20',   -- Ethereum
- 235: 
+ 235:     'POLYGON', -- Polygon
- 236: 
+ 236:     'MANUAL'   -- Manual bank transfer
- 237: 
+ 237:   );
- 238: 
+ 238: EXCEPTION
- 239: 
+ 239:   WHEN duplicate_object THEN null;
- 240: 
+ 240: END $$;
- 242: 
+ 242: -- ROI payment status
- 243: 
+ 243: DO $$ BEGIN
- 244: 
+ 244:   CREATE TYPE "RoiPaymentStatus" AS ENUM (
- 245: 
+ 245:     'PENDING',
- 246: 
+ 246:     'PROCESSING',
- 247: 
+ 247:     'COMPLETED',
- 248: 
+ 248:     'FAILED',
- 249: 
+ 249:     'SKIPPED'
- 250: 
+ 250:   );
- 251: 
+ 251: EXCEPTION
- 252: 
+ 252:   WHEN duplicate_object THEN null;
- 253: 
+ 253: END $$;
- 255: 
+ 255: -- Bot status
- 256: 
+ 256: DO $$ BEGIN
- 257: 
+ 257:   CREATE TYPE "BotStatus" AS ENUM (
- 258: 
+ 258:     'PENDING',    -- Waiting for admin approval
- 259: 
+ 259:     'AWAITING_ADMIN_APPROVAL', -- Awaiting admin approval after on-chain verification
- 260: 
+ 260:     'ACTIVE',
- 261: 
+ 261:     'EXPIRED',
- 262: 
+ 262:     'INACTIVE',
- 263: 
+ 263:     'SUSPENDED'
- 264: 
+ 264:   );
- 265: 
+ 265: EXCEPTION
- 266: 
+ 266:   WHEN duplicate_object THEN null;
- 267: 
+ 267: END $$;
- 269: 
+ 269: -- Session status
- 270: 
+ 270: DO $$ BEGIN
- 271: 
+ 271:   CREATE TYPE "SessionStatus" AS ENUM (
- 272: 
+ 272:     'ACTIVE',
- 273: 
+ 273:     'EXPIRED',
- 274: 
+ 274:     'REVOKED',
- 275: 
+ 275:     'INVALID'
- 276: 
+ 276:   );
- 277: 
+ 277: EXCEPTION
- 278: 
+ 278:   WHEN duplicate_object THEN null;
- 279: 
+ 279: END $$;
- 281: 
+ 281: -- Cron job status
- 282: 
+ 282: DO $$ BEGIN
- 283: 
+ 283:   CREATE TYPE "CronJobStatus" AS ENUM (
- 284: 
+ 284:     'IDLE',
- 285: 
+ 285:     'RUNNING',
- 286: 
+ 286:     'COMPLETED',
- 287: 
+ 287:     'FAILED',
- 288: 
+ 288:     'DISABLED'
- 289: 
+ 289:   );
- 290: 
+ 290: EXCEPTION
- 291: 
+ 291:   WHEN duplicate_object THEN null;
- 292: 
+ 292: END $$;
- 295: 
+ 295: -- End included: 01_enums.sql
- 298: 
+ 298: -- Begin included: 02_core_tables.sql
- 299: 
+ 299: -- ============================================================================
- 300: 
+ 300: -- CORE TABLES - Main application entities
- 301: 
+ 301: -- ============================================================================
- 303: 
+ 303: -- ----------------------------------------------------------------------------
- 304: 
+ 304: -- User Table - Main user entity (supports all auth & profile APIs)
- 305: 
+ 305: -- ----------------------------------------------------------------------------
- 306: 
+ 306: CREATE TABLE IF NOT EXISTS "User" (
- 307: 
+ 307:   "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
- 308: 
+ 308:   
- 309: 
+ 309:   -- Authentication
- 310: 
+ 310:   "email" TEXT NOT NULL UNIQUE,
- 311: 
+ 311:   "password" TEXT NOT NULL,
- 312: 
+ 312:   "username" TEXT UNIQUE,
- 313: 
+ 313:   "fullName" TEXT,
- 314: 
+ 314:   "phone" TEXT,
- 315: 
+ 315:   
- 316: 
+ 316:   -- Referral system
- 317: 
+ 317:   "referralCode" TEXT NOT NULL UNIQUE,
- 318: 
+ 318:   "referredBy" TEXT, -- Stores referralCode of referrer
- 319: 
+ 319:   "referrerId" TEXT, -- Alternative: Direct user ID
- 320: 
+ 320:   
- 321: 
+ 321:   -- Wallet addresses (supports all payment networks)
- 322: 
+ 322:   "bep20Address" TEXT,
- 323: 
+ 323:   "trc20Address" TEXT,
- 324: 
+ 324:   "erc20Address" TEXT,
- 325: 
+ 325:   "polygonAddress" TEXT,
- 326: 
+ 326:   "walletAddress" TEXT, -- Primary/default
- 327: 
+ 327:   
- 328: 
+ 328:   -- Email verification
- 329: 
+ 329:   "isEmailVerified" BOOLEAN NOT NULL DEFAULT false,
- 330: 
+ 330:   "emailVerificationToken" TEXT,
- 331: 
+ 331:   "emailVerificationExpiry" TIMESTAMP,
- 332: 
+ 332:   
- 333: 
+ 333:   -- Two-factor authentication (2FA APIs)
- 334: 
+ 334:   "twoFactorEnabled" BOOLEAN NOT NULL DEFAULT false,
- 335: 
+ 335:   "twoFactorSecret" TEXT,
- 336: 
+ 336:   "twoFactorBackupCodes" TEXT[],
- 337: 
+ 337:   
- 338: 
+ 338:   -- KYC verification (KYC APIs)
- 339: 
+ 339:   "kycStatus" "KYCStatus" NOT NULL DEFAULT 'PENDING',
- 340: 
+ 340:   "kycSubmittedAt" TIMESTAMP,
- 341: 
+ 341:   "kycApprovedAt" TIMESTAMP,
- 342: 
+ 342:   "kycRejectedAt" TIMESTAMP,
- 343: 
+ 343:   "kycRejectionReason" TEXT,
- 344: 
+ 344:   
- 345: 
+ 345:   -- Account status
- 346: 
+ 346:   "isAdmin" BOOLEAN NOT NULL DEFAULT false,
- 347: 
+ 347:   "isActive" BOOLEAN NOT NULL DEFAULT true,
- 348: 
+ 348:   "isBlocked" BOOLEAN NOT NULL DEFAULT false,
- 349: 
+ 349:   "blockReason" TEXT,
- 350: 
+ 350:   "blockedAt" TIMESTAMP,
- 351: 
+ 351:   "blockedBy" TEXT,
- 352: 
+ 352:   "role" "UserRole" NOT NULL DEFAULT 'USER',
- 353: 
+ 353:   
- 354: 
+ 354:   -- Login security (brute-force protection)
- 355: 
+ 355:   "lastLogin" TIMESTAMP,
- 356: 
+ 356:   "lastLoginIp" TEXT,
- 357: 
+ 357:   "failedLoginAttempts" INTEGER DEFAULT 0,
- 358: 
+ 358:   "accountLockedUntil" TIMESTAMP,
- 359: 
+ 359:   "lastFailedLoginAt" TIMESTAMP,
- 360: 
+ 360:   
- 361: 
+ 361:   -- Password reset
- 362: 
+ 362:   "passwordResetToken" TEXT,
- 363: 
+ 363:   "passwordResetExpiry" TIMESTAMP,
- 364: 
+ 364:   
- 365: 
+ 365:   -- Profile
- 366: 
+ 366:   "avatar" TEXT,
- 367: 
+ 367:   "dateOfBirth" DATE,
- 368: 
+ 368:   "country" TEXT,
- 369: 
+ 369:   "city" TEXT,
- 370: 
+ 370:   "address" TEXT,
- 371: 
+ 371:   "zipCode" TEXT,
- 372: 
+ 372:   
- 373: 
+ 373:   -- Preferences
- 374: 
+ 374:   "language" TEXT DEFAULT 'en',
- 375: 
+ 375:   "timezone" TEXT DEFAULT 'UTC',
- 376: 
+ 376:   "currency" TEXT DEFAULT 'USDT',
- 377: 
+ 377:   "emailNotifications" BOOLEAN DEFAULT true,
- 378: 
+ 378:   "smsNotifications" BOOLEAN DEFAULT false,
- 379: 
+ 379:   
- 380: 
+ 380:   -- Legal acceptance
- 381: 
+ 381:   "acceptedTermsAt" TIMESTAMP,
- 382: 
+ 382:   "acceptedPrivacyAt" TIMESTAMP,
- 383: 
+ 383:   "termsVersion" TEXT,
- 384: 
+ 384:   "privacyVersion" TEXT,
- 385: 
+ 385:   
- 386: 
+ 386:   -- Timestamps
- 387: 
+ 387:   "createdAt" TIMESTAMP NOT NULL DEFAULT NOW(),
- 388: 
+ 388:   "updatedAt" TIMESTAMP NOT NULL DEFAULT NOW(),
- 389: 
+ 389:   "lastActiveAt" TIMESTAMP
- 390: 
+ 390: );
- 392: 
+ 392: -- User indexes
- 393: 
+ 393: CREATE INDEX IF NOT EXISTS "idx_user_email" ON "User"("email");
- 394: 
+ 394: CREATE INDEX IF NOT EXISTS "idx_user_referralCode" ON "User"("referralCode");
- 395: 
+ 395: CREATE INDEX IF NOT EXISTS "idx_user_referredBy" ON "User"("referredBy");
- 396: 
+ 396: CREATE INDEX IF NOT EXISTS "idx_user_isActive" ON "User"("isActive");
- 397: 
+ 397: CREATE INDEX IF NOT EXISTS "idx_user_isBlocked" ON "User"("isBlocked");
- 398: 
+ 398: CREATE INDEX IF NOT EXISTS "idx_user_role" ON "User"("role");
- 399: 
+ 399: CREATE INDEX IF NOT EXISTS "idx_user_kycStatus" ON "User"("kycStatus");
- 400: 
+ 400: CREATE INDEX IF NOT EXISTS "idx_user_createdAt" ON "User"("createdAt" DESC);
- 401: 
+ 401: CREATE INDEX IF NOT EXISTS "idx_user_lastLogin" ON "User"("lastLogin" DESC);
- 403: 
+ 403: -- ----------------------------------------------------------------------------
- 404: 
+ 404: -- ReferralCounter - Auto-incrementing referral codes
- 405: 
+ 405: -- ----------------------------------------------------------------------------
- 406: 
+ 406: CREATE TABLE IF NOT EXISTS "ReferralCounter" (
- 407: 
+ 407:   "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
- 408: 
+ 408:   "counterType" TEXT NOT NULL UNIQUE,
- 409: 
+ 409:   "currentValue" INTEGER NOT NULL DEFAULT 1000,
- 410: 
+ 410:   "prefix" TEXT DEFAULT 'NSCREF',
- 411: 
+ 411:   "updatedAt" TIMESTAMP NOT NULL DEFAULT NOW()
- 412: 
+ 412: );
- 414: 
+ 414: INSERT INTO "ReferralCounter" ("id", "counterType", "currentValue", "prefix")
- 415: 
+ 415: VALUES (gen_random_uuid()::text, 'NSCREF', 1000, 'NSCREF')
- 416: 
+ 416: ON CONFLICT ("counterType") DO NOTHING;
- 418: 
+ 418: -- ----------------------------------------------------------------------------
- 419: 
+ 419: -- Package Table - User investment packages
- 420: 
+ 420: -- ----------------------------------------------------------------------------
- 421: 
+ 421: CREATE TABLE IF NOT EXISTS "Package" (
- 422: 
+ 422:   "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
- 423: 
+ 423:   "userId" TEXT NOT NULL REFERENCES "User"("id") ON DELETE CASCADE,
- 424: 
+ 424:   
- 425: 
+ 425:   -- Package details
- 426: 
+ 426:   "amount" DECIMAL(20, 8) NOT NULL,
- 427: 
+ 427:   "packageType" "PackageType" NOT NULL,
- 428: 
+ 428:   "roiPercentage" DECIMAL(5, 2) NOT NULL,
- 429: 
+ 429:   "status" "PackageStatus" NOT NULL DEFAULT 'PENDING',
- 430: 
+ 430:   "network" "Network",
- 431: 
+ 431:   
- 432: 
+ 432:   -- Payment tracking
- 433: 
+ 433:   "depositTxHash" TEXT,
- 434: 
+ 434:   "paymentRequestId" TEXT,
- 435: 
+ 435:   
- 436: 
+ 436:   -- Date tracking
- 437: 
+ 437:   "investmentDate" TIMESTAMP,
- 438: 
+ 438:   "purchaseDate" TIMESTAMP,
- 439: 
+ 439:   "activatedAt" TIMESTAMP,
- 440: 
+ 440:   "expiryDate" TIMESTAMP,
- 441: 
+ 441:   "expiredAt" TIMESTAMP,
- 442: 
+ 442:   
- 443: 
+ 443:   -- ROI tracking
- 444: 
+ 444:   "lastRoiDate" TIMESTAMP,
- 445: 
+ 445:   "nextRoiDate" TIMESTAMP,
- 446: 
+ 446:   "totalRoiPaid" DECIMAL(20, 8) NOT NULL DEFAULT 0,
- 447: 
+ 447:   "roiPaidCount" INTEGER NOT NULL DEFAULT 0,
- 448: 
+ 448:   "totalEarnings" DECIMAL(20, 8) DEFAULT 0,
- 449: 
+ 449:   
- 450: 
+ 450:   -- Expiration flags
- 451: 
+ 451:   "isExpired" BOOLEAN NOT NULL DEFAULT false,
- 452: 
+ 452:   "capitalReturned" BOOLEAN NOT NULL DEFAULT false,
- 453: 
+ 453:   "capitalReturnedAt" TIMESTAMP,
- 454: 
+ 454:   
- 455: 
+ 455:   -- Admin actions
- 456: 
+ 456:   "approvedBy" TEXT,
- 457: 
+ 457:   "approvedAt" TIMESTAMP,
- 458: 
+ 458:   "rejectedBy" TEXT,
- 459: 
+ 459:   "rejectedAt" TIMESTAMP,
- 460: 
+ 460:   "rejectionReason" TEXT,
- 461: 
+ 461:   
- 462: 
+ 462:   -- Metadata
- 463: 
+ 463:   "notes" TEXT,
- 464: 
+ 464:   "metadata" JSONB,
- 465: 
+ 465:   
- 466: 
+ 466:   -- Timestamps
- 467: 
+ 467:   "createdAt" TIMESTAMP NOT NULL DEFAULT NOW(),
- 468: 
+ 468:   "updatedAt" TIMESTAMP NOT NULL DEFAULT NOW()
- 469: 
+ 469: );
- 471: 
+ 471: -- Package indexes
- 472: 
+ 472: CREATE INDEX IF NOT EXISTS "idx_package_userId" ON "Package"("userId");
- 473: 
+ 473: CREATE INDEX IF NOT EXISTS "idx_package_status" ON "Package"("status");
- 474: 
+ 474: CREATE INDEX IF NOT EXISTS "idx_package_packageType" ON "Package"("packageType");
- 475: 
+ 475: CREATE INDEX IF NOT EXISTS "idx_package_nextRoiDate" ON "Package"("nextRoiDate");
- 476: 
+ 476: CREATE INDEX IF NOT EXISTS "idx_package_expiryDate" ON "Package"("expiryDate");
- 477: 
+ 477: CREATE INDEX IF NOT EXISTS "idx_package_isExpired" ON "Package"("isExpired");
- 478: 
+ 478: CREATE INDEX IF NOT EXISTS "idx_package_investmentDate" ON "Package"("investmentDate");
- 479: 
+ 479: CREATE INDEX IF NOT EXISTS "idx_package_createdAt" ON "Package"("createdAt" DESC);
- 481: 
+ 481: -- ----------------------------------------------------------------------------
- 482: 
+ 482: -- BotActivation Table - Bot activations
- 483: 
+ 483: -- ----------------------------------------------------------------------------
- 484: 
+ 484: CREATE TABLE IF NOT EXISTS "BotActivation" (
- 485: 
+ 485:   "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
- 486: 
+ 486:   "userId" TEXT NOT NULL REFERENCES "User"("id") ON DELETE CASCADE,
- 487: 
+ 487:   "packageId" TEXT REFERENCES "Package"("id") ON DELETE SET NULL,
- 488: 
+ 488:   
- 489: 
+ 489:   -- Bot details
- 490: 
+ 490:   "botType" "PackageType" NOT NULL,
- 491: 
+ 491:   "activationFee" DECIMAL(20, 8) NOT NULL,
- 492: 
+ 492:   "status" "BotStatus" NOT NULL DEFAULT 'ACTIVE',
- 493: 
+ 493:   "network" "Network",
- 494: 
+ 494:   
- 495: 
+ 495:   -- Payment tracking
- 496: 
+ 496:   "paymentTxHash" TEXT,
- 497: 
+ 497:   "paymentRequestId" TEXT,
- 498: 
+ 498:   
- 499: 
+ 499:   -- Date tracking (CRITICAL: code uses both)
- 500: 
+ 500:   "activationDate" TIMESTAMP,
- 501: 
+ 501:   "activatedAt" TIMESTAMP,
- 502: 
+ 502:   "expiryDate" TIMESTAMP,
- 503: 
+ 503:   "expiredAt" TIMESTAMP,
- 504: 
+ 504:   
- 505: 
+ 505:   -- Expiration tracking
- 506: 
+ 506:   "isExpired" BOOLEAN NOT NULL DEFAULT false,
- 507: 
+ 507:   "capitalReturned" BOOLEAN NOT NULL DEFAULT false,
- 508: 
+ 508:   
- 509: 
+ 509:   -- Earnings tracking
- 510: 
+ 510:   "totalEarnings" DECIMAL(20, 8) DEFAULT 0,
- 511: 
+ 511:   
- 512: 
+ 512:   -- Admin
- 513: 
+ 513:   "approvedBy" TEXT,
- 514: 
+ 514:   "approvedAt" TIMESTAMP,
- 515: 
+ 515:   
- 516: 
+ 516:   -- Metadata
- 517: 
+ 517:   "notes" TEXT,
- 518: 
+ 518:   "metadata" JSONB,
- 519: 
+ 519:   
- 520: 
+ 520:   -- Timestamps
- 521: 
+ 521:   "createdAt" TIMESTAMP NOT NULL DEFAULT NOW(),
- 522: 
+ 522:   "updatedAt" TIMESTAMP NOT NULL DEFAULT NOW()
- 523: 
+ 523: );
- 525: 
+ 525: -- BotActivation indexes
- 526: 
+ 526: CREATE INDEX IF NOT EXISTS "idx_botactivation_userId" ON "BotActivation"("userId");
- 527: 
+ 527: CREATE INDEX IF NOT EXISTS "idx_botactivation_packageId" ON "BotActivation"("packageId");
- 528: 
+ 528: CREATE INDEX IF NOT EXISTS "idx_botactivation_status" ON "BotActivation"("status");
- 529: 
+ 529: CREATE INDEX IF NOT EXISTS "idx_botactivation_botType" ON "BotActivation"("botType");
- 530: 
+ 530: CREATE INDEX IF NOT EXISTS "idx_botactivation_isExpired" ON "BotActivation"("isExpired");
- 531: 
+ 531: CREATE INDEX IF NOT EXISTS "idx_botactivation_expiryDate" ON "BotActivation"("expiryDate");
- 532: 
+ 532: CREATE INDEX IF NOT EXISTS "idx_botactivation_activationDate" ON "BotActivation"("activationDate");
- 534: 
+ 534: -- ----------------------------------------------------------------------------
- 535: 
+ 535: -- KYCSubmission Table - KYC verification submissions
- 536: 
+ 536: -- ----------------------------------------------------------------------------
- 537: 
+ 537: CREATE TABLE IF NOT EXISTS "KYCSubmission" (
- 538: 
+ 538:   "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
- 539: 
+ 539:   "userId" TEXT NOT NULL REFERENCES "User"("id") ON DELETE CASCADE,
- 540: 
+ 540:   
- 541: 
+ 541:   -- Status
- 542: 
+ 542:   "status" "KYCStatus" NOT NULL DEFAULT 'PENDING',
- 543: 
+ 543:   
- 544: 
+ 544:   -- Document details
- 545: 
+ 545:   "documentType" TEXT NOT NULL,
- 546: 
+ 546:   "documentNumber" TEXT,
- 547: 
+ 547:   "documentFrontUrl" TEXT,
- 548: 
+ 548:   "frontImageUrl" TEXT,
- 549: 
+ 549:   "documentBackUrl" TEXT,
- 550: 
+ 550:   "backImageUrl" TEXT,
- 551: 
+ 551:   "selfieUrl" TEXT,
- 552: 
+ 552:   "proofOfAddressUrl" TEXT,
- 553: 
+ 553:   
- 554: 
+ 554:   -- Personal details
- 555: 
+ 555:   "firstName" TEXT,
- 556: 
+ 556:   "lastName" TEXT,
- 557: 
+ 557:   "middleName" TEXT,
- 558: 
+ 558:   "dateOfBirth" DATE,
- 559: 
+ 559:   "nationality" TEXT,
- 560: 
+ 560:   "country" TEXT,
- 561: 
+ 561:   "city" TEXT,
- 562: 
+ 562:   "address" TEXT,
- 563: 
+ 563:   "zipCode" TEXT,
- 564: 
+ 564:   
- 565: 
+ 565:   -- Review
- 566: 
+ 566:   "rejectionReason" TEXT,
- 567: 
+ 567:   "adminNotes" TEXT,
- 568: 
+ 568:   "verifiedBy" TEXT,
- 569: 
+ 569:   "reviewedBy" TEXT,
- 570: 
+ 570:   "verifiedAt" TIMESTAMP,
- 571: 
+ 571:   "reviewedAt" TIMESTAMP,
- 572: 
+ 572:   "submittedAt" TIMESTAMP NOT NULL DEFAULT NOW(),
- 573: 
+ 573:   
- 574: 
+ 574:   -- Metadata
- 575: 
+ 575:   "metadata" JSONB,
- 576: 
+ 576:   
- 577: 
+ 577:   -- Timestamps
- 578: 
+ 578:   "createdAt" TIMESTAMP NOT NULL DEFAULT NOW(),
- 579: 
+ 579:   "updatedAt" TIMESTAMP NOT NULL DEFAULT NOW()
- 580: 
+ 580: );
- 582: 
+ 582: CREATE INDEX IF NOT EXISTS "idx_kycsubmission_userId" ON "KYCSubmission"("userId");
- 583: 
+ 583: CREATE INDEX IF NOT EXISTS "idx_kycsubmission_status" ON "KYCSubmission"("status");
- 584: 
+ 584: CREATE INDEX IF NOT EXISTS "idx_kycsubmission_submittedAt" ON "KYCSubmission"("submittedAt" DESC);
- 587: 
+ 587: -- End included: 02_core_tables.sql
- 590: 
+ 590: -- Begin included: 03_financial_tables.sql
- 591: 
+ 591: -- ============================================================================
- 592: 
+ 592: -- FINANCIAL TABLES - All money-related tables
- 593: 
+ 593: -- ============================================================================
- 595: 
+ 595: -- ----------------------------------------------------------------------------
- 596: 
+ 596: -- Transaction Table - All financial transactions
- 597: 
+ 597: -- ----------------------------------------------------------------------------
- 598: 
+ 598: CREATE TABLE IF NOT EXISTS "Transaction" (
- 599: 
+ 599:   "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
- 600: 
+ 600:   "userId" TEXT NOT NULL REFERENCES "User"("id") ON DELETE CASCADE,
- 601: 
+ 601:   
- 602: 
+ 602:   -- Transaction details
- 603: 
+ 603:   "type" "TransactionType" NOT NULL,
- 604: 
+ 604:   "amount" DECIMAL(20, 8) NOT NULL,
- 605: 
+ 605:   "fee" DECIMAL(20, 8) DEFAULT 0,
- 606: 
+ 606:   "netAmount" DECIMAL(20, 8),
- 607: 
+ 607:   "status" "TransactionStatus" NOT NULL DEFAULT 'PENDING',
- 608: 
+ 608:   
- 609: 
+ 609:   -- Description
- 610: 
+ 610:   "description" TEXT,
- 611: 
+ 611:   "notes" TEXT,
- 612: 
+ 612:   
- 613: 
+ 613:   -- Blockchain details
- 614: 
+ 614:   "txHash" TEXT,
- 615: 
+ 615:   "network" "Network",
- 616: 
+ 616:   "blockNumber" BIGINT,
- 617: 
+ 617:   "confirmations" INTEGER DEFAULT 0,
- 618: 
+ 618:   "fromAddress" TEXT,
- 619: 
+ 619:   "toAddress" TEXT,
- 620: 
+ 620:   
- 621: 
+ 621:   -- Reference tracking
- 622: 
+ 622:   "referenceId" TEXT,
- 623: 
+ 623:   "referenceType" TEXT,
- 624: 
+ 624:   "relatedTransactionId" TEXT,
- 625: 
+ 625:   
- 626: 
+ 626:   -- Balances (before and after)
- 627: 
+ 627:   "balanceBefore" DECIMAL(20, 8),
- 628: 
+ 628:   "balanceAfter" DECIMAL(20, 8),
- 629: 
+ 629:   
- 630: 
+ 630:   -- Admin actions
- 631: 
+ 631:   "processedBy" TEXT,
- 632: 
+ 632:   "processedAt" TIMESTAMP,
- 633: 
+ 633:   
- 634: 
+ 634:   -- Metadata
- 635: 
+ 635:   "metadata" JSONB,
- 636: 
+ 636:   
- 637: 
+ 637:   -- Timestamps
- 638: 
+ 638:   "createdAt" TIMESTAMP NOT NULL DEFAULT NOW(),
- 639: 
+ 639:   "updatedAt" TIMESTAMP NOT NULL DEFAULT NOW(),
- 640: 
+ 640:   "completedAt" TIMESTAMP
- 641: 
+ 641: );
- 643: 
+ 643: CREATE INDEX IF NOT EXISTS "idx_transaction_userId" ON "Transaction"("userId");
- 644: 
+ 644: CREATE INDEX IF NOT EXISTS "idx_transaction_type" ON "Transaction"("type");
- 645: 
+ 645: CREATE INDEX IF NOT EXISTS "idx_transaction_status" ON "Transaction"("status");
- 646: 
+ 646: CREATE INDEX IF NOT EXISTS "idx_transaction_txHash" ON "Transaction"("txHash");
- 647: 
+ 647: CREATE INDEX IF NOT EXISTS "idx_transaction_referenceId" ON "Transaction"("referenceId");
- 648: 
+ 648: CREATE INDEX IF NOT EXISTS "idx_transaction_createdAt" ON "Transaction"("createdAt" DESC);
- 649: 
+ 649: CREATE INDEX IF NOT EXISTS "idx_transaction_network" ON "Transaction"("network");
- 651: 
+ 651: -- ----------------------------------------------------------------------------
- 652: 
+ 652: -- RoiPayment Table - Monthly ROI payments
- 653: 
+ 653: -- ----------------------------------------------------------------------------
- 654: 
+ 654: CREATE TABLE IF NOT EXISTS "RoiPayment" (
- 655: 
+ 655:   "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
- 656: 
+ 656:   "packageId" TEXT NOT NULL REFERENCES "Package"("id") ON DELETE CASCADE,
- 657: 
+ 657:   "userId" TEXT NOT NULL REFERENCES "User"("id") ON DELETE CASCADE,
- 658: 
+ 658:   "transactionId" TEXT,
- 659: 
+ 659:   
- 660: 
+ 660:   -- Payment details
- 661: 
+ 661:   "amount" DECIMAL(20, 8) NOT NULL,
- 662: 
+ 662:   "percentage" DECIMAL(5, 2),
- 663: 
+ 663:   "monthNumber" INTEGER NOT NULL,
- 664: 
+ 664:   
- 665: 
+ 665:   -- Date tracking
- 666: 
+ 666:   "paymentDate" TIMESTAMP NOT NULL,
- 667: 
+ 667:   "scheduledDate" TIMESTAMP,
- 668: 
+ 668:   "paidAt" TIMESTAMP,
- 669: 
+ 669:   "dueDate" TIMESTAMP,
- 670: 
+ 670:   
- 671: 
+ 671:   -- Status
- 672: 
+ 672:   "status" "RoiPaymentStatus" DEFAULT 'COMPLETED',
- 673: 
+ 673:   "isPaid" BOOLEAN DEFAULT true,
- 674: 
+ 674:   
- 675: 
+ 675:   -- Failure tracking
- 676: 
+ 676:   "failureReason" TEXT,
- 677: 
+ 677:   "retryCount" INTEGER DEFAULT 0,
- 678: 
+ 678:   
- 679: 
+ 679:   -- Metadata
- 680: 
+ 680:   "notes" TEXT,
- 681: 
+ 681:   "metadata" JSONB,
- 682: 
+ 682:   
- 683: 
+ 683:   -- Timestamps
- 684: 
+ 684:   "createdAt" TIMESTAMP NOT NULL DEFAULT NOW(),
- 685: 
+ 685:   "updatedAt" TIMESTAMP
- 686: 
+ 686: );
- 688: 
+ 688: CREATE INDEX IF NOT EXISTS "idx_roipayment_packageId" ON "RoiPayment"("packageId");
- 689: 
+ 689: CREATE INDEX IF NOT EXISTS "idx_roipayment_userId" ON "RoiPayment"("userId");
- 690: 
+ 690: CREATE INDEX IF NOT EXISTS "idx_roipayment_monthNumber" ON "RoiPayment"("monthNumber");
- 691: 
+ 691: CREATE INDEX IF NOT EXISTS "idx_roipayment_status" ON "RoiPayment"("status");
- 692: 
+ 692: CREATE INDEX IF NOT EXISTS "idx_roipayment_paymentDate" ON "RoiPayment"("paymentDate" DESC);
- 693: 
+ 693: CREATE INDEX IF NOT EXISTS "idx_roipayment_scheduledDate" ON "RoiPayment"("scheduledDate");
- 695: 
+ 695: -- ----------------------------------------------------------------------------
- 696: 
+ 696: -- Earning Table - Referral & Level Income
- 697: 
+ 697: -- ----------------------------------------------------------------------------
- 698: 
+ 698: CREATE TABLE IF NOT EXISTS "Earning" (
- 699: 
+ 699:   "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
- 700: 
+ 700:   "userId" TEXT NOT NULL REFERENCES "User"("id") ON DELETE CASCADE,
- 701: 
+ 701:   "fromUserId" TEXT REFERENCES "User"("id") ON DELETE SET NULL,
- 702: 
+ 702:   "packageId" TEXT REFERENCES "Package"("id") ON DELETE SET NULL,
- 703: 
+ 703:   "transactionId" TEXT,
- 704: 
+ 704:   
- 705: 
+ 705:   -- Earning details
- 706: 
+ 706:   "earningType" "EarningType" NOT NULL,
- 707: 
+ 707:   "type" TEXT,
- 708: 
+ 708:   "amount" DECIMAL(20, 8) NOT NULL,
- 709: 
+ 709:   "level" INTEGER,
- 710: 
+ 710:   "percentage" DECIMAL(5, 2),
- 711: 
+ 711:   
- 712: 
+ 712:   -- Source tracking
- 713: 
+ 713:   "sourceId" TEXT,
- 714: 
+ 714:   "sourceType" TEXT,
- 715: 
+ 715:   "sourceAmount" DECIMAL(20, 8),
- 716: 
+ 716:   
- 717: 
+ 717:   -- Description
- 718: 
+ 718:   "description" TEXT,
- 719: 
+ 719:   "notes" TEXT,
- 720: 
+ 720:   
- 721: 
+ 721:   -- Status
- 722: 
+ 722:   "status" TEXT DEFAULT 'PAID',
- 723: 
+ 723:   "isPaid" BOOLEAN DEFAULT true,
- 724: 
+ 724:   "paidDate" TIMESTAMP,
- 725: 
+ 725:   "paidAt" TIMESTAMP,
- 726: 
+ 726:   
- 727: 
+ 727:   -- Metadata
- 728: 
+ 728:   "metadata" JSONB,
- 729: 
+ 729:   
- 730: 
+ 730:   -- Timestamps
- 731: 
+ 731:   "createdAt" TIMESTAMP NOT NULL DEFAULT NOW()
- 732: 
+ 732: );
- 734: 
+ 734: CREATE INDEX IF NOT EXISTS "idx_earning_userId" ON "Earning"("userId");
- 735: 
+ 735: CREATE INDEX IF NOT EXISTS "idx_earning_fromUserId" ON "Earning"("fromUserId");
- 736: 
+ 736: CREATE INDEX IF NOT EXISTS "idx_earning_packageId" ON "Earning"("packageId");
- 737: 
+ 737: CREATE INDEX IF NOT EXISTS "idx_earning_earningType" ON "Earning"("earningType");
- 738: 
+ 738: CREATE INDEX IF NOT EXISTS "idx_earning_level" ON "Earning"("level");
- 739: 
+ 739: CREATE INDEX IF NOT EXISTS "idx_earning_status" ON "Earning"("status");
- 740: 
+ 740: CREATE INDEX IF NOT EXISTS "idx_earning_createdAt" ON "Earning"("createdAt" DESC);
- 742: 
+ 742: -- ----------------------------------------------------------------------------
- 743: 
+ 743: -- Withdrawal Table - User withdrawal requests
- 744: 
+ 744: -- ----------------------------------------------------------------------------
- 745: 
+ 745: CREATE TABLE IF NOT EXISTS "Withdrawal" (
- 746: 
+ 746:   "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
- 747: 
+ 747:   "userId" TEXT NOT NULL REFERENCES "User"("id") ON DELETE CASCADE,
- 748: 
+ 748:   "transactionId" TEXT,
- 749: 
+ 749:   
- 750: 
+ 750:   -- Amount details
- 751: 
+ 751:   "amount" DECIMAL(20, 8) NOT NULL,
- 752: 
+ 752:   "fee" DECIMAL(20, 8) NOT NULL DEFAULT 0,
- 753: 
+ 753:   "feePercentage" DECIMAL(5, 2),
- 754: 
+ 754:   "netAmount" DECIMAL(20, 8) NOT NULL,
- 755: 
+ 755:   "requestedAmount" DECIMAL(20, 8),
- 756: 
+ 756:   
- 757: 
+ 757:   -- Withdrawal type
- 758: 
+ 758:   "type" "WithdrawalType",
- 759: 
+ 759:   "withdrawalType" TEXT,
- 760: 
+ 760:   
- 761: 
+ 761:   -- Wallet details
- 762: 
+ 762:   "walletAddress" TEXT NOT NULL,
- 763: 
+ 763:   "network" "Network" NOT NULL,
- 764: 
+ 764:   
- 765: 
+ 765:   -- Status
- 766: 
+ 766:   "status" "WithdrawalStatus" NOT NULL DEFAULT 'PENDING',
- 767: 
+ 767:   
- 768: 
+ 768:   -- Blockchain transaction
- 769: 
+ 769:   "txHash" TEXT,
- 770: 
+ 770:   "blockNumber" BIGINT,
- 771: 
+ 771:   
- 772: 
+ 772:   -- Admin actions
- 773: 
+ 773:   "approvedBy" TEXT,
- 774: 
+ 774:   "approvedAt" TIMESTAMP,
- 775: 
+ 775:   "rejectedBy" TEXT,
- 776: 
+ 776:   "rejectedAt" TIMESTAMP,
- 777: 
+ 777:   "rejectionReason" TEXT,
- 778: 
+ 778:   "processedBy" TEXT,
- 779: 
+ 779:   "processedDate" TIMESTAMP,
- 780: 
+ 780:   "processedAt" TIMESTAMP,
- 781: 
+ 781:   "completedAt" TIMESTAMP,
- 782: 
+ 782:   
- 783: 
+ 783:   -- Request tracking
- 784: 
+ 784:   "requestDate" TIMESTAMP NOT NULL DEFAULT NOW(),
- 785: 
+ 785:   "requestedAt" TIMESTAMP,
- 786: 
+ 786:   
- 787: 
+ 787:   -- Notes
- 788: 
+ 788:   "userNote" TEXT,
- 789: 
+ 789:   "adminNote" TEXT,
- 790: 
+ 790:   "notes" TEXT,
- 791: 
+ 791:   
- 792: 
+ 792:   -- Metadata
- 793: 
+ 793:   "metadata" JSONB,
- 794: 
+ 794:   
- 795: 
+ 795:   -- Timestamps
- 796: 
+ 796:   "createdAt" TIMESTAMP NOT NULL DEFAULT NOW(),
- 797: 
+ 797:   "updatedAt" TIMESTAMP NOT NULL DEFAULT NOW()
- 798: 
+ 798: );
- 800: 
+ 800: CREATE INDEX IF NOT EXISTS "idx_withdrawal_userId" ON "Withdrawal"("userId");
- 801: 
+ 801: CREATE INDEX IF NOT EXISTS "idx_withdrawal_status" ON "Withdrawal"("status");
- 802: 
+ 802: CREATE INDEX IF NOT EXISTS "idx_withdrawal_network" ON "Withdrawal"("network");
- 803: 
+ 803: CREATE INDEX IF NOT EXISTS "idx_withdrawal_txHash" ON "Withdrawal"("txHash");
- 804: 
+ 804: CREATE INDEX IF NOT EXISTS "idx_withdrawal_createdAt" ON "Withdrawal"("createdAt" DESC);
- 805: 
+ 805: CREATE INDEX IF NOT EXISTS "idx_withdrawal_approvedBy" ON "Withdrawal"("approvedBy");
- 807: 
+ 807: -- ----------------------------------------------------------------------------
- 808: 
+ 808: -- PaymentRequest Table - Payment gateway
- 809: 
+ 809: -- ----------------------------------------------------------------------------
- 810: 
+ 810: CREATE TABLE IF NOT EXISTS "PaymentRequest" (
- 811: 
+ 811:   "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
- 812: 
+ 812:   "userId" TEXT NOT NULL REFERENCES "User"("id") ON DELETE CASCADE,
- 813: 
+ 813:   
- 814: 
+ 814:   -- Purpose
- 815: 
+ 815:   "purpose" TEXT NOT NULL,
- 816: 
+ 816:   "purposeType" TEXT,
- 817: 
+ 817:   
- 818: 
+ 818:   -- Amount
- 819: 
+ 819:   "amount" DECIMAL(20, 8) NOT NULL,
- 820: 
+ 820:   "amountReceived" DECIMAL(20, 8),
- 821: 
+ 821:   "currency" TEXT DEFAULT 'USDT',
- 822: 
+ 822:   
- 823: 
+ 823:   -- Network and address
- 824: 
+ 824:   "network" "Network" NOT NULL,
- 825: 
+ 825:   "depositAddress" TEXT NOT NULL,
- 826: 
+ 826:   "generatedAddress" TEXT,
- 827: 
+ 827:   
- 828: 
+ 828:   -- QR Code
- 829: 
+ 829:   "qrCodeData" TEXT,
- 830: 
+ 830:   "qrCodeUrl" TEXT,
- 831: 
+ 831:   
- 832: 
+ 832:   -- Status
- 833: 
+ 833:   "status" "PaymentStatus" NOT NULL DEFAULT 'PENDING',
- 834: 
+ 834:   
- 835: 
+ 835:   -- Blockchain tracking
- 836: 
+ 836:   "txHash" TEXT,
- 837: 
+ 837:   "blockNumber" BIGINT,
- 838: 
+ 838:   "confirmations" INTEGER DEFAULT 0,
- 839: 
+ 839:   "requiredConfirmations" INTEGER DEFAULT 3,
- 840: 
+ 840:   "fromAddress" TEXT,
- 841: 
+ 841:   
- 842: 
+ 842:   -- Linked records
- 843: 
+ 843:   "packageId" TEXT,
- 844: 
+ 844:   "botActivationId" TEXT,
- 845: 
+ 845:   "transactionId" TEXT,
- 846: 
+ 846:   
- 847: 
+ 847:   -- Metadata
- 848: 
+ 848:   "metadata" JSONB,
- 849: 
+ 849:   
- 850: 
+ 850:   -- Expiry
- 851: 
+ 851:   "expiresAt" TIMESTAMP NOT NULL,
- 852: 
+ 852:   "expiredAt" TIMESTAMP,
- 853: 
+ 853:   "completedAt" TIMESTAMP,
- 854: 
+ 854:   
- 855: 
+ 855:   -- Verification
- 856: 
+ 856:   "verifiedAt" TIMESTAMP,
- 857: 
+ 857:   "verifiedBy" TEXT,
- 858: 
+ 858:   
- 859: 
+ 859:   -- Notes
- 860: 
+ 860:   "notes" TEXT,
- 861: 
+ 861:   "failureReason" TEXT,
- 862: 
+ 862:   
- 863: 
+ 863:   -- Timestamps
- 864: 
+ 864:   "createdAt" TIMESTAMP NOT NULL DEFAULT NOW(),
- 865: 
+ 865:   "updatedAt" TIMESTAMP NOT NULL DEFAULT NOW()
- 866: 
+ 866: );
- 868: 
+ 868: CREATE INDEX IF NOT EXISTS "idx_paymentrequest_userId" ON "PaymentRequest"("userId");
- 869: 
+ 869: CREATE INDEX IF NOT EXISTS "idx_paymentrequest_status" ON "PaymentRequest"("status");
- 870: 
+ 870: CREATE INDEX IF NOT EXISTS "idx_paymentrequest_txHash" ON "PaymentRequest"("txHash");
- 871: 
+ 871: CREATE INDEX IF NOT EXISTS "idx_paymentrequest_depositAddress" ON "PaymentRequest"("depositAddress");
- 872: 
+ 872: CREATE INDEX IF NOT EXISTS "idx_paymentrequest_expiresAt" ON "PaymentRequest"("expiresAt");
- 873: 
+ 873: CREATE INDEX IF NOT EXISTS "idx_paymentrequest_purpose" ON "PaymentRequest"("purpose");
- 874: 
+ 874: CREATE INDEX IF NOT EXISTS "idx_paymentrequest_network" ON "PaymentRequest"("network");
- 876: 
+ 876: -- ----------------------------------------------------------------------------
- 877: 
+ 877: -- PaymentConfirmation Table - Blockchain verification
- 878: 
+ 878: -- ----------------------------------------------------------------------------
- 879: 
+ 879: CREATE TABLE IF NOT EXISTS "PaymentConfirmation" (
- 880: 
+ 880:   "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
- 881: 
+ 881:   "paymentRequestId" TEXT REFERENCES "PaymentRequest"("id") ON DELETE CASCADE,
- 882: 
+ 882:   
- 883: 
+ 883:   -- Transaction details
- 884: 
+ 884:   "txHash" TEXT NOT NULL UNIQUE,
- 885: 
+ 885:   "network" "Network" NOT NULL,
- 886: 
+ 886:   "blockNumber" BIGINT,
- 887: 
+ 887:   "blockHash" TEXT,
- 888: 
+ 888:   "blockTimestamp" TIMESTAMP,
- 889: 
+ 889:   
- 890: 
+ 890:   -- Confirmation tracking
- 891: 
+ 891:   "confirmations" INTEGER NOT NULL DEFAULT 0,
- 892: 
+ 892:   "requiredConfirmations" INTEGER NOT NULL DEFAULT 3,
- 893: 
+ 893:   "isConfirmed" BOOLEAN NOT NULL DEFAULT false,
- 894: 
+ 894:   "confirmedAt" TIMESTAMP,
- 895: 
+ 895:   
- 896: 
+ 896:   -- Amount verification
- 897: 
+ 897:   "amount" DECIMAL(20, 8) NOT NULL,
- 898: 
+ 898:   "expectedAmount" DECIMAL(20, 8),
- 899: 
+ 899:   "amountMatches" BOOLEAN,
- 900: 
+ 900:   
- 901: 
+ 901:   -- Addresses
- 902: 
+ 902:   "fromAddress" TEXT NOT NULL,
- 903: 
+ 903:   "toAddress" TEXT NOT NULL,
- 904: 
+ 904:   "contractAddress" TEXT,
- 905: 
+ 905:   
- 906: 
+ 906:   -- Status
- 907: 
+ 907:   "status" TEXT DEFAULT 'PENDING',
- 908: 
+ 908:   "lastCheckedAt" TIMESTAMP,
- 909: 
+ 909:   "nextCheckAt" TIMESTAMP,
- 910: 
+ 910:   
- 911: 
+ 911:   -- Verification details
- 912: 
+ 912:   "verificationData" JSONB,
- 913: 
+ 913:   "gasUsed" BIGINT,
- 914: 
+ 914:   "gasPrice" BIGINT,
- 915: 
+ 915:   
- 916: 
+ 916:   -- Error tracking
- 917: 
+ 917:   "errorCount" INTEGER DEFAULT 0,
- 918: 
+ 918:   "lastError" TEXT,
- 919: 
+ 919:   
- 920: 
+ 920:   -- Timestamps
- 921: 
+ 921:   "createdAt" TIMESTAMP NOT NULL DEFAULT NOW(),
- 922: 
+ 922:   "updatedAt" TIMESTAMP NOT NULL DEFAULT NOW()
- 923: 
+ 923: );
- 925: 
+ 925: CREATE INDEX IF NOT EXISTS "idx_paymentconfirmation_txHash" ON "PaymentConfirmation"("txHash");
- 926: 
+ 926: CREATE INDEX IF NOT EXISTS "idx_paymentconfirmation_paymentRequestId" ON "PaymentConfirmation"("paymentRequestId");
- 927: 
+ 927: CREATE INDEX IF NOT EXISTS "idx_paymentconfirmation_isConfirmed" ON "PaymentConfirmation"("isConfirmed");
- 928: 
+ 928: CREATE INDEX IF NOT EXISTS "idx_paymentconfirmation_network" ON "PaymentConfirmation"("network");
- 929: 
+ 929: CREATE INDEX IF NOT EXISTS "idx_paymentconfirmation_nextCheckAt" ON "PaymentConfirmation"("nextCheckAt");
- 931: 
+ 931: -- ----------------------------------------------------------------------------
- 932: 
+ 932: -- PaymentWebhook Table - Webhook logs
- 933: 
+ 933: -- ----------------------------------------------------------------------------
- 934: 
+ 934: CREATE TABLE IF NOT EXISTS "PaymentWebhook" (
- 935: 
+ 935:   "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
- 936: 
+ 936:   "paymentRequestId" TEXT REFERENCES "PaymentRequest"("id") ON DELETE SET NULL,
- 937: 
+ 937:   
- 938: 
+ 938:   -- Webhook data
- 939: 
+ 939:   "txHash" TEXT,
- 940: 
+ 940:   "network" "Network",
- 941: 
+ 941:   "webhookData" JSONB NOT NULL,
- 942: 
+ 942:   "rawPayload" TEXT,
- 943: 
+ 943:   "headers" JSONB,
- 944: 
+ 944:   
- 945: 
+ 945:   -- Processing
- 946: 
+ 946:   "processed" BOOLEAN NOT NULL DEFAULT false,
- 947: 
+ 947:   "processedAt" TIMESTAMP,
- 948: 
+ 948:   "processedBy" TEXT,
- 949: 
+ 949:   
- 950: 
+ 950:   -- Error handling
- 951: 
+ 951:   "error" TEXT,
- 952: 
+ 952:   "errorCount" INTEGER DEFAULT 0,
- 953: 
+ 953:   "retryCount" INTEGER DEFAULT 0,
- 954: 
+ 954:   "lastRetryAt" TIMESTAMP,
- 955: 
+ 955:   
- 956: 
+ 956:   -- Source
- 957: 
+ 957:   "source" TEXT,
- 958: 
+ 958:   "ipAddress" TEXT,
- 959: 
+ 959:   
- 960: 
+ 960:   -- Timestamps
- 961: 
+ 961:   "createdAt" TIMESTAMP NOT NULL DEFAULT NOW()
- 962: 
+ 962: );
- 964: 
+ 964: CREATE INDEX IF NOT EXISTS "idx_paymentwebhook_txHash" ON "PaymentWebhook"("txHash");
- 965: 
+ 965: CREATE INDEX IF NOT EXISTS "idx_paymentwebhook_processed" ON "PaymentWebhook"("processed");
- 966: 
+ 966: CREATE INDEX IF NOT EXISTS "idx_paymentwebhook_paymentRequestId" ON "PaymentWebhook"("paymentRequestId");
- 967: 
+ 967: CREATE INDEX IF NOT EXISTS "idx_paymentwebhook_createdAt" ON "PaymentWebhook"("createdAt" DESC);
- 969: 
+ 969: -- ----------------------------------------------------------------------------
- 970: 
+ 970: -- BlockchainScanState Table - Track blockchain scanning progress
- 971: 
+ 971: -- ----------------------------------------------------------------------------
- 972: 
+ 972: CREATE TABLE IF NOT EXISTS "BlockchainScanState" (
- 973: 
+ 973:   "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
- 974: 
+ 974:   "network" "Network" NOT NULL UNIQUE,
- 975: 
+ 975:   "lastScannedBlock" BIGINT NOT NULL DEFAULT 0,
- 976: 
+ 976:   "lastScanTime" TIMESTAMP,
- 977: 
+ 977:   "scanActive" BOOLEAN DEFAULT false,
- 978: 
+ 978:   "errorCount" INTEGER DEFAULT 0,
- 979: 
+ 979:   "lastError" TEXT,
- 980: 
+ 980:   "updatedAt" TIMESTAMP NOT NULL DEFAULT NOW()
- 981: 
+ 981: );
- 983: 
+ 983: -- Initialize blockchain scan states
- 984: 
+ 984: INSERT INTO "BlockchainScanState" ("id", "network", "lastScannedBlock", "lastScanTime")
- 985: 
+ 985: VALUES
- 986: 
+ 986:   (gen_random_uuid()::text, 'BEP20', 0, CURRENT_TIMESTAMP),
- 987: 
+ 987:   (gen_random_uuid()::text, 'TRC20', 0, CURRENT_TIMESTAMP),
- 988: 
+ 988:   (gen_random_uuid()::text, 'ERC20', 0, CURRENT_TIMESTAMP),
- 989: 
+ 989:   (gen_random_uuid()::text, 'POLYGON', 0, CURRENT_TIMESTAMP)
- 990: 
+ 990: ON CONFLICT ("network") DO NOTHING;
- 993: 
+ 993: -- End included: 03_financial_tables.sql
- 996: 
+ 996: -- Begin included: 04_system_tables.sql
- 997: 
+ 997: -- ============================================================================
- 998: 
+ 998: -- SYSTEM TABLES - Settings, Logs, Sessions, Notifications, Support
- 999: 
+ 999: -- ============================================================================
- 1001: 
+ 1001: -- ----------------------------------------------------------------------------
- 1002: 
+ 1002: -- SystemSetting Table - Platform configuration
- 1003: 
+ 1003: -- ----------------------------------------------------------------------------
- 1004: 
+ 1004: CREATE TABLE IF NOT EXISTS "SystemSetting" (
- 1005: 
+ 1005:   "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
- 1006: 
+ 1006:   "key" TEXT NOT NULL UNIQUE,
- 1007: 
+ 1007:   "value" TEXT NOT NULL,
- 1008: 
+ 1008:   "description" TEXT,
- 1009: 
+ 1009:   "type" TEXT DEFAULT 'STRING',
- 1010: 
+ 1010:   "category" TEXT DEFAULT 'GENERAL',
- 1011: 
+ 1011:   "isPublic" BOOLEAN DEFAULT false,
- 1012: 
+ 1012:   "updatedBy" TEXT,
- 1013: 
+ 1013:   "updatedAt" TIMESTAMP NOT NULL DEFAULT NOW(),
- 1014: 
+ 1014:   "createdAt" TIMESTAMP NOT NULL DEFAULT NOW()
- 1015: 
+ 1015: );
- 1017: 
+ 1017: CREATE INDEX IF NOT EXISTS "idx_systemsetting_key" ON "SystemSetting"("key");
- 1018: 
+ 1018: CREATE INDEX IF NOT EXISTS "idx_systemsetting_category" ON "SystemSetting"("category");
- 1020: 
+ 1020: -- ----------------------------------------------------------------------------
- 1021: 
+ 1021: -- AdminLog Table - Audit trail for admin actions
- 1022: 
+ 1022: -- ----------------------------------------------------------------------------
- 1023: 
+ 1023: CREATE TABLE IF NOT EXISTS "AdminLog" (
- 1024: 
+ 1024:   "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
- 1025: 
+ 1025:   "adminId" TEXT NOT NULL REFERENCES "User"("id") ON DELETE CASCADE,
- 1026: 
+ 1026:   
- 1027: 
+ 1027:   -- Action details
- 1028: 
+ 1028:   "action" "AdminActionType" NOT NULL,
- 1029: 
+ 1029:   "actionType" TEXT,
- 1030: 
+ 1030:   "targetType" TEXT,
- 1031: 
+ 1031:   "targetId" TEXT,
- 1032: 
+ 1032:   
- 1033: 
+ 1033:   -- Description
- 1034: 
+ 1034:   "description" TEXT,
- 1035: 
+ 1035:   "notes" TEXT,
- 1036: 
+ 1036:   
- 1037: 
+ 1037:   -- Data
- 1038: 
+ 1038:   "details" JSONB,
- 1039: 
+ 1039:   "metadata" JSONB,
- 1040: 
+ 1040:   "oldValue" JSONB,
- 1041: 
+ 1041:   "newValue" JSONB,
- 1042: 
+ 1042:   
- 1043: 
+ 1043:   -- Request info
- 1044: 
+ 1044:   "ipAddress" TEXT,
- 1045: 
+ 1045:   "userAgent" TEXT,
- 1046: 
+ 1046:   
- 1047: 
+ 1047:   -- Timestamps
- 1048: 
+ 1048:   "createdAt" TIMESTAMP NOT NULL DEFAULT NOW()
- 1049: 
+ 1049: );
- 1051: 
+ 1051: CREATE INDEX IF NOT EXISTS "idx_adminlog_adminId" ON "AdminLog"("adminId");
- 1052: 
+ 1052: CREATE INDEX IF NOT EXISTS "idx_adminlog_action" ON "AdminLog"("action");
- 1053: 
+ 1053: CREATE INDEX IF NOT EXISTS "idx_adminlog_targetType" ON "AdminLog"("targetType");
- 1054: 
+ 1054: CREATE INDEX IF NOT EXISTS "idx_adminlog_targetId" ON "AdminLog"("targetId");
- 1055: 
+ 1055: CREATE INDEX IF NOT EXISTS "idx_adminlog_createdAt" ON "AdminLog"("createdAt" DESC);
- 1057: 
+ 1057: -- ----------------------------------------------------------------------------
- 1058: 
+ 1058: -- Session Table - User session management
- 1059: 
+ 1059: -- ----------------------------------------------------------------------------
- 1060: 
+ 1060: CREATE TABLE IF NOT EXISTS "Session" (
- 1061: 
+ 1061:   "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
- 1062: 
+ 1062:   "userId" TEXT NOT NULL REFERENCES "User"("id") ON DELETE CASCADE,
- 1063: 
+ 1063:   
- 1064: 
+ 1064:   -- Token details
- 1065: 
+ 1065:   "token" TEXT NOT NULL UNIQUE,
- 1066: 
+ 1066:   "refreshToken" TEXT,
- 1067: 
+ 1067:   "tokenHash" TEXT,
- 1068: 
+ 1068:   
- 1069: 
+ 1069:   -- Session info
- 1070: 
+ 1070:   "ipAddress" TEXT,
- 1071: 
+ 1071:   "userAgent" TEXT,
- 1072: 
+ 1072:   "deviceInfo" JSONB,
- 1073: 
+ 1073:   "location" TEXT,
- 1074: 
+ 1074:   
- 1075: 
+ 1075:   -- Status
- 1076: 
+ 1076:   "isActive" BOOLEAN NOT NULL DEFAULT true,
- 1077: 
+ 1077:   "status" "SessionStatus" DEFAULT 'ACTIVE',
- 1078: 
+ 1078:   
- 1079: 
+ 1079:   -- Expiry
- 1080: 
+ 1080:   "expiresAt" TIMESTAMP NOT NULL,
- 1081: 
+ 1081:   "refreshExpiresAt" TIMESTAMP,
- 1082: 
+ 1082:   
- 1083: 
+ 1083:   -- Usage tracking
- 1084: 
+ 1084:   "lastUsedAt" TIMESTAMP,
- 1085: 
+ 1085:   "lastActivityAt" TIMESTAMP,
- 1086: 
+ 1086:   "requestCount" INTEGER DEFAULT 0,
- 1087: 
+ 1087:   
- 1088: 
+ 1088:   -- Revocation
- 1089: 
+ 1089:   "revokedAt" TIMESTAMP,
- 1090: 
+ 1090:   "revokedBy" TEXT,
- 1091: 
+ 1091:   "revokedReason" TEXT,
- 1092: 
+ 1092:   
- 1093: 
+ 1093:   -- Timestamps
- 1094: 
+ 1094:   "createdAt" TIMESTAMP NOT NULL DEFAULT NOW()
- 1095: 
+ 1095: );
- 1097: 
+ 1097: CREATE INDEX IF NOT EXISTS "idx_session_userId" ON "Session"("userId");
- 1098: 
+ 1098: CREATE INDEX IF NOT EXISTS "idx_session_token" ON "Session"("token");
- 1099: 
+ 1099: CREATE INDEX IF NOT EXISTS "idx_session_tokenHash" ON "Session"("tokenHash");
- 1100: 
+ 1100: CREATE INDEX IF NOT EXISTS "idx_session_isActive" ON "Session"("isActive");
- 1101: 
+ 1101: CREATE INDEX IF NOT EXISTS "idx_session_expiresAt" ON "Session"("expiresAt");
- 1102: 
+ 1102: CREATE INDEX IF NOT EXISTS "idx_session_status" ON "Session"("status");
- 1104: 
+ 1104: -- ----------------------------------------------------------------------------
- 1105: 
+ 1105: -- LoginAttempt Table - Security tracking
- 1106: 
+ 1106: -- ----------------------------------------------------------------------------
- 1107: 
+ 1107: CREATE TABLE IF NOT EXISTS "LoginAttempt" (
- 1108: 
+ 1108:   "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
- 1109: 
+ 1109:   
- 1110: 
+ 1110:   -- User identification
- 1111: 
+ 1111:   "email" TEXT NOT NULL,
- 1112: 
+ 1112:   "userId" TEXT,
- 1113: 
+ 1113:   
- 1114: 
+ 1114:   -- Request details
- 1115: 
+ 1115:   "ipAddress" TEXT NOT NULL,
- 1116: 
+ 1116:   "userAgent" TEXT,
- 1117: 
+ 1117:   "deviceInfo" JSONB,
- 1118: 
+ 1118:   "location" TEXT,
- 1119: 
+ 1119:   
- 1120: 
+ 1120:   -- Attempt result
- 1121: 
+ 1121:   "success" BOOLEAN NOT NULL DEFAULT false,
- 1122: 
+ 1122:   "failureReason" TEXT,
- 1123: 
+ 1123:   "errorCode" TEXT,
- 1124: 
+ 1124:   
- 1125: 
+ 1125:   -- Two-factor
- 1126: 
+ 1126:   "twoFactorAttempted" BOOLEAN DEFAULT false,
- 1127: 
+ 1127:   "twoFactorSuccess" BOOLEAN,
- 1128: 
+ 1128:   
- 1129: 
+ 1129:   -- Metadata
- 1130: 
+ 1130:   "metadata" JSONB,
- 1131: 
+ 1131:   
- 1132: 
+ 1132:   -- Timestamp
- 1133: 
+ 1133:   "createdAt" TIMESTAMP NOT NULL DEFAULT NOW()
- 1134: 
+ 1134: );
- 1136: 
+ 1136: CREATE INDEX IF NOT EXISTS "idx_loginattempt_email" ON "LoginAttempt"("email");
- 1137: 
+ 1137: CREATE INDEX IF NOT EXISTS "idx_loginattempt_userId" ON "LoginAttempt"("userId");
- 1138: 
+ 1138: CREATE INDEX IF NOT EXISTS "idx_loginattempt_ipAddress" ON "LoginAttempt"("ipAddress");
- 1139: 
+ 1139: CREATE INDEX IF NOT EXISTS "idx_loginattempt_success" ON "LoginAttempt"("success");
- 1140: 
+ 1140: CREATE INDEX IF NOT EXISTS "idx_loginattempt_createdAt" ON "LoginAttempt"("createdAt" DESC);
- 1142: 
+ 1142: -- ----------------------------------------------------------------------------
- 1143: 
+ 1143: -- Notification Table - User notifications
- 1144: 
+ 1144: -- ----------------------------------------------------------------------------
- 1145: 
+ 1145: CREATE TABLE IF NOT EXISTS "Notification" (
- 1146: 
+ 1146:   "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
- 1147: 
+ 1147:   "userId" TEXT NOT NULL REFERENCES "User"("id") ON DELETE CASCADE,
- 1148: 
+ 1148:   
- 1149: 
+ 1149:   -- Content
- 1150: 
+ 1150:   "title" TEXT NOT NULL,
- 1151: 
+ 1151:   "message" TEXT NOT NULL,
- 1152: 
+ 1152:   "type" "NotificationType" NOT NULL DEFAULT 'INFO',
- 1153: 
+ 1153:   
- 1154: 
+ 1154:   -- Links
- 1155: 
+ 1155:   "link" TEXT,
- 1156: 
+ 1156:   "actionUrl" TEXT,
- 1157: 
+ 1157:   "actionText" TEXT,
- 1158: 
+ 1158:   
- 1159: 
+ 1159:   -- Read status
- 1160: 
+ 1160:   "read" BOOLEAN NOT NULL DEFAULT false,
- 1161: 
+ 1161:   "readAt" TIMESTAMP,
- 1162: 
+ 1162:   
- 1163: 
+ 1163:   -- Reference
- 1164: 
+ 1164:   "referenceId" TEXT,
- 1165: 
+ 1165:   "referenceType" TEXT,
- 1166: 
+ 1166:   
- 1167: 
+ 1167:   -- Priority
- 1168: 
+ 1168:   "priority" TEXT DEFAULT 'NORMAL',
- 1169: 
+ 1169:   
- 1170: 
+ 1170:   -- Metadata
- 1171: 
+ 1171:   "metadata" JSONB,
- 1172: 
+ 1172:   
- 1173: 
+ 1173:   -- Expiry (auto-delete after certain time)
- 1174: 
+ 1174:   "expiresAt" TIMESTAMP,
- 1175: 
+ 1175:   
- 1176: 
+ 1176:   -- Timestamps
- 1177: 
+ 1177:   "createdAt" TIMESTAMP NOT NULL DEFAULT NOW()
- 1178: 
+ 1178: );
- 1180: 
+ 1180: CREATE INDEX IF NOT EXISTS "idx_notification_userId" ON "Notification"("userId");
- 1181: 
+ 1181: CREATE INDEX IF NOT EXISTS "idx_notification_read" ON "Notification"("read");
- 1182: 
+ 1182: CREATE INDEX IF NOT EXISTS "idx_notification_type" ON "Notification"("type");
- 1183: 
+ 1183: CREATE INDEX IF NOT EXISTS "idx_notification_createdAt" ON "Notification"("createdAt" DESC);
- 1185: 
+ 1185: -- ----------------------------------------------------------------------------
- 1186: 
+ 1186: -- SupportTicket Table - Customer support
- 1187: 
+ 1187: -- ----------------------------------------------------------------------------
- 1188: 
+ 1188: CREATE TABLE IF NOT EXISTS "SupportTicket" (
- 1189: 
+ 1189:   "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
- 1190: 
+ 1190:   "userId" TEXT NOT NULL REFERENCES "User"("id") ON DELETE CASCADE,
- 1191: 
+ 1191:   
- 1192: 
+ 1192:   -- Ticket details
- 1193: 
+ 1193:   "ticketNumber" TEXT UNIQUE,
- 1194: 
+ 1194:   "subject" TEXT NOT NULL,
- 1195: 
+ 1195:   "message" TEXT NOT NULL,
- 1196: 
+ 1196:   "category" TEXT,
- 1197: 
+ 1197:   
- 1198: 
+ 1198:   -- Status
- 1199: 
+ 1199:   "status" "TicketStatus" NOT NULL DEFAULT 'OPEN',
- 1200: 
+ 1200:   "priority" "TicketPriority" NOT NULL DEFAULT 'MEDIUM',
- 1201: 
+ 1201:   
- 1202: 
+ 1202:   -- Assignment
- 1203: 
+ 1203:   "assignedTo" TEXT REFERENCES "User"("id") ON DELETE SET NULL,
- 1204: 
+ 1204:   "assignedAt" TIMESTAMP,
- 1205: 
+ 1205:   
- 1206: 
+ 1206:   -- Resolution
- 1207: 
+ 1207:   "resolvedAt" TIMESTAMP,
- 1208: 
+ 1208:   "resolvedBy" TEXT REFERENCES "User"("id") ON DELETE SET NULL,
- 1209: 
+ 1209:   "resolution" TEXT,
- 1210: 
+ 1210:   "closedAt" TIMESTAMP,
- 1211: 
+ 1211:   "closedBy" TEXT,
- 1212: 
+ 1212:   
- 1213: 
+ 1213:   -- Metadata
- 1214: 
+ 1214:   "metadata" JSONB,
- 1215: 
+ 1215:   "attachments" TEXT[],
- 1216: 
+ 1216:   
- 1217: 
+ 1217:   -- Timestamps
- 1218: 
+ 1218:   "createdAt" TIMESTAMP NOT NULL DEFAULT NOW(),
- 1219: 
+ 1219:   "updatedAt" TIMESTAMP NOT NULL DEFAULT NOW(),
- 1220: 
+ 1220:   "lastResponseAt" TIMESTAMP
- 1221: 
+ 1221: );
- 1223: 
+ 1223: CREATE INDEX IF NOT EXISTS "idx_supportticket_userId" ON "SupportTicket"("userId");
- 1224: 
+ 1224: CREATE INDEX IF NOT EXISTS "idx_supportticket_status" ON "SupportTicket"("status");
- 1225: 
+ 1225: CREATE INDEX IF NOT EXISTS "idx_supportticket_priority" ON "SupportTicket"("priority");
- 1226: 
+ 1226: CREATE INDEX IF NOT EXISTS "idx_supportticket_assignedTo" ON "SupportTicket"("assignedTo");
- 1227: 
+ 1227: CREATE INDEX IF NOT EXISTS "idx_supportticket_ticketNumber" ON "SupportTicket"("ticketNumber");
- 1228: 
+ 1228: CREATE INDEX IF NOT EXISTS "idx_supportticket_createdAt" ON "SupportTicket"("createdAt" DESC);
- 1230: 
+ 1230: -- ----------------------------------------------------------------------------
- 1231: 
+ 1231: -- TicketMessage Table - Support ticket messages
- 1232: 
+ 1232: -- ----------------------------------------------------------------------------
- 1233: 
+ 1233: CREATE TABLE IF NOT EXISTS "TicketMessage" (
- 1234: 
+ 1234:   "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
- 1235: 
+ 1235:   "ticketId" TEXT NOT NULL REFERENCES "SupportTicket"("id") ON DELETE CASCADE,
- 1236: 
+ 1236:   "userId" TEXT NOT NULL REFERENCES "User"("id") ON DELETE CASCADE,
- 1237: 
+ 1237:   
- 1238: 
+ 1238:   -- Message
- 1239: 
+ 1239:   "message" TEXT NOT NULL,
- 1240: 
+ 1240:   "isStaffReply" BOOLEAN DEFAULT false,
- 1241: 
+ 1241:   
- 1242: 
+ 1242:   -- Attachments
- 1243: 
+ 1243:   "attachments" TEXT[],
- 1244: 
+ 1244:   
- 1245: 
+ 1245:   -- Metadata
- 1246: 
+ 1246:   "metadata" JSONB,
- 1247: 
+ 1247:   
- 1248: 
+ 1248:   -- Timestamps
- 1249: 
+ 1249:   "createdAt" TIMESTAMP NOT NULL DEFAULT NOW()
- 1250: 
+ 1250: );
- 1252: 
+ 1252: CREATE INDEX IF NOT EXISTS "idx_ticketmessage_ticketId" ON "TicketMessage"("ticketId");
- 1253: 
+ 1253: CREATE INDEX IF NOT EXISTS "idx_ticketmessage_userId" ON "TicketMessage"("userId");
- 1254: 
+ 1254: CREATE INDEX IF NOT EXISTS "idx_ticketmessage_createdAt" ON "TicketMessage"("createdAt");
- 1256: 
+ 1256: -- ----------------------------------------------------------------------------
- 1257: 
+ 1257: -- EmailLog Table - Email delivery tracking
- 1258: 
+ 1258: -- ----------------------------------------------------------------------------
- 1259: 
+ 1259: CREATE TABLE IF NOT EXISTS "EmailLog" (
- 1260: 
+ 1260:   "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
- 1261: 
+ 1261:   "userId" TEXT REFERENCES "User"("id") ON DELETE SET NULL,
- 1262: 
+ 1262:   
- 1263: 
+ 1263:   -- Email details
- 1264: 
+ 1264:   "to" TEXT NOT NULL,
- 1265: 
+ 1265:   "from" TEXT,
- 1266: 
+ 1266:   "subject" TEXT NOT NULL,
- 1267: 
+ 1267:   "body" TEXT,
- 1268: 
+ 1268:   "templateName" TEXT,
- 1269: 
+ 1269:   "templateData" JSONB,
- 1270: 
+ 1270:   
- 1271: 
+ 1271:   -- Status
- 1272: 
+ 1272:   "status" TEXT DEFAULT 'PENDING',
- 1273: 
+ 1273:   "sentAt" TIMESTAMP,
- 1274: 
+ 1274:   "deliveredAt" TIMESTAMP,
- 1275: 
+ 1275:   "openedAt" TIMESTAMP,
- 1276: 
+ 1276:   "clickedAt" TIMESTAMP,
- 1277: 
+ 1277:   
- 1278: 
+ 1278:   -- Provider info
- 1279: 
+ 1279:   "provider" TEXT,
- 1280: 
+ 1280:   "messageId" TEXT,
- 1281: 
+ 1281:   "providerResponse" JSONB,
- 1282: 
+ 1282:   
- 1283: 
+ 1283:   -- Error tracking
- 1284: 
+ 1284:   "error" TEXT,
- 1285: 
+ 1285:   "retryCount" INTEGER DEFAULT 0,
- 1286: 
+ 1286:   
- 1287: 
+ 1287:   -- Metadata
- 1288: 
+ 1288:   "metadata" JSONB,
- 1289: 
+ 1289:   
- 1290: 
+ 1290:   -- Timestamps
- 1291: 
+ 1291:   "createdAt" TIMESTAMP NOT NULL DEFAULT NOW()
- 1292: 
+ 1292: );
- 1294: 
+ 1294: CREATE INDEX IF NOT EXISTS "idx_emaillog_userId" ON "EmailLog"("userId");
- 1295: 
+ 1295: CREATE INDEX IF NOT EXISTS "idx_emaillog_to" ON "EmailLog"("to");
- 1296: 
+ 1296: CREATE INDEX IF NOT EXISTS "idx_emaillog_status" ON "EmailLog"("status");
- 1297: 
+ 1297: CREATE INDEX IF NOT EXISTS "idx_emaillog_createdAt" ON "EmailLog"("createdAt" DESC);
- 1299: 
+ 1299: -- ----------------------------------------------------------------------------
- 1300: 
+ 1300: -- CronJob Table - Cron job execution tracking
- 1301: 
+ 1301: -- ----------------------------------------------------------------------------
- 1302: 
+ 1302: CREATE TABLE IF NOT EXISTS "CronJob" (
- 1303: 
+ 1303:   "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
- 1304: 
+ 1304:   
- 1305: 
+ 1305:   -- Job details
- 1306: 
+ 1306:   "name" TEXT NOT NULL UNIQUE,
- 1307: 
+ 1307:   "description" TEXT,
- 1308: 
+ 1308:   "schedule" TEXT,
- 1309: 
+ 1309:   
- 1310: 
+ 1310:   -- Status
- 1311: 
+ 1311:   "status" "CronJobStatus" DEFAULT 'IDLE',
- 1312: 
+ 1312:   "enabled" BOOLEAN DEFAULT true,
- 1313: 
+ 1313:   
- 1314: 
+ 1314:   -- Execution tracking
- 1315: 
+ 1315:   "lastRunAt" TIMESTAMP,
- 1316: 
+ 1316:   "lastSuccessAt" TIMESTAMP,
- 1317: 
+ 1317:   "lastFailureAt" TIMESTAMP,
- 1318: 
+ 1318:   "nextRunAt" TIMESTAMP,
- 1319: 
+ 1319:   
- 1320: 
+ 1320:   -- Statistics
- 1321: 
+ 1321:   "runCount" INTEGER DEFAULT 0,
- 1322: 
+ 1322:   "successCount" INTEGER DEFAULT 0,
- 1323: 
+ 1323:   "failureCount" INTEGER DEFAULT 0,
- 1324: 
+ 1324:   "averageDuration" INTEGER,
- 1325: 
+ 1325:   
- 1326: 
+ 1326:   -- Last execution
- 1327: 
+ 1327:   "lastDuration" INTEGER,
- 1328: 
+ 1328:   "lastError" TEXT,
- 1329: 
+ 1329:   "lastResult" JSONB,
- 1330: 
+ 1330:   
- 1331: 
+ 1331:   -- Configuration
- 1332: 
+ 1332:   "config" JSONB,
- 1333: 
+ 1333:   
- 1334: 
+ 1334:   -- Timestamps
- 1335: 
+ 1335:   "createdAt" TIMESTAMP NOT NULL DEFAULT NOW(),
- 1336: 
+ 1336:   "updatedAt" TIMESTAMP NOT NULL DEFAULT NOW()
- 1337: 
+ 1337: );
- 1339: 
+ 1339: CREATE INDEX IF NOT EXISTS "idx_cronjob_name" ON "CronJob"("name");
- 1340: 
+ 1340: CREATE INDEX IF NOT EXISTS "idx_cronjob_status" ON "CronJob"("status");
- 1341: 
+ 1341: CREATE INDEX IF NOT EXISTS "idx_cronjob_enabled" ON "CronJob"("enabled");
- 1342: 
+ 1342: CREATE INDEX IF NOT EXISTS "idx_cronjob_nextRunAt" ON "CronJob"("nextRunAt");
- 1344: 
+ 1344: -- ----------------------------------------------------------------------------
- 1345: 
+ 1345: -- CronJobExecution Table - Individual cron job runs
- 1346: 
+ 1346: -- ----------------------------------------------------------------------------
- 1347: 
+ 1347: CREATE TABLE IF NOT EXISTS "CronJobExecution" (
- 1348: 
+ 1348:   "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
- 1349: 
+ 1349:   "cronJobId" TEXT NOT NULL REFERENCES "CronJob"("id") ON DELETE CASCADE,
- 1350: 
+ 1350:   
- 1351: 
+ 1351:   -- Execution details
- 1352: 
+ 1352:   "startedAt" TIMESTAMP NOT NULL,
- 1353: 
+ 1353:   "completedAt" TIMESTAMP,
- 1354: 
+ 1354:   "duration" INTEGER,
- 1355: 
+ 1355:   
- 1356: 
+ 1356:   -- Status
- 1357: 
+ 1357:   "status" TEXT DEFAULT 'RUNNING',
- 1358: 
+ 1358:   "success" BOOLEAN,
- 1359: 
+ 1359:   
- 1360: 
+ 1360:   -- Results
- 1361: 
+ 1361:   "result" JSONB,
- 1362: 
+ 1362:   "error" TEXT,
- 1363: 
+ 1363:   "stackTrace" TEXT,
- 1364: 
+ 1364:   
- 1365: 
+ 1365:   -- Statistics
- 1366: 
+ 1366:   "recordsProcessed" INTEGER DEFAULT 0,
- 1367: 
+ 1367:   "recordsSucceeded" INTEGER DEFAULT 0,
- 1368: 
+ 1368:   "recordsFailed" INTEGER DEFAULT 0,
- 1369: 
+ 1369:   
- 1370: 
+ 1370:   -- Metadata
- 1371: 
+ 1371:   "metadata" JSONB,
- 1372: 
+ 1372:   
- 1373: 
+ 1373:   -- Timestamps
- 1374: 
+ 1374:   "createdAt" TIMESTAMP NOT NULL DEFAULT NOW()
- 1375: 
+ 1375: );
- 1377: 
+ 1377: CREATE INDEX IF NOT EXISTS "idx_cronjobexecution_cronJobId" ON "CronJobExecution"("cronJobId");
- 1378: 
+ 1378: CREATE INDEX IF NOT EXISTS "idx_cronjobexecution_startedAt" ON "CronJobExecution"("startedAt" DESC);
- 1379: 
+ 1379: CREATE INDEX IF NOT EXISTS "idx_cronjobexecution_status" ON "CronJobExecution"("status");
- 1381: 
+ 1381: -- ----------------------------------------------------------------------------
- 1382: 
+ 1382: -- AuditLog Table - General system audit trail
- 1383: 
+ 1383: -- ----------------------------------------------------------------------------
- 1384: 
+ 1384: CREATE TABLE IF NOT EXISTS "AuditLog" (
- 1385: 
+ 1385:   "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
- 1386: 
+ 1386:   "userId" TEXT REFERENCES "User"("id") ON DELETE SET NULL,
- 1387: 
+ 1387:   
- 1388: 
+ 1388:   -- Action details
- 1389: 
+ 1389:   "action" TEXT NOT NULL,
- 1390: 
+ 1390:   "entityType" TEXT,
- 1391: 
+ 1391:   "entityId" TEXT,
- 1392: 
+ 1392:   
- 1393: 
+ 1393:   -- Changes
- 1394: 
+ 1394:   "oldValue" JSONB,
- 1395: 
+ 1395:   "newValue" JSONB,
- 1396: 
+ 1396:   "changes" JSONB,
- 1397: 
+ 1397:   
- 1398: 
+ 1398:   -- Request info
- 1399: 
+ 1399:   "ipAddress" TEXT,
- 1400: 
+ 1400:   "userAgent" TEXT,
- 1401: 
+ 1401:   "method" TEXT,
- 1402: 
+ 1402:   "path" TEXT,
- 1403: 
+ 1403:   
- 1404: 
+ 1404:   -- Metadata
- 1405: 
+ 1405:   "metadata" JSONB,
- 1406: 
+ 1406:   
- 1407: 
+ 1407:   -- Timestamps
- 1408: 
+ 1408:   "createdAt" TIMESTAMP NOT NULL DEFAULT NOW()
- 1409: 
+ 1409: );
- 1411: 
+ 1411: CREATE INDEX IF NOT EXISTS "idx_auditlog_userId" ON "AuditLog"("userId");
- 1412: 
+ 1412: CREATE INDEX IF NOT EXISTS "idx_auditlog_action" ON "AuditLog"("action");
- 1413: 
+ 1413: CREATE INDEX IF NOT EXISTS "idx_auditlog_entityType" ON "AuditLog"("entityType");
- 1414: 
+ 1414: CREATE INDEX IF NOT EXISTS "idx_auditlog_entityId" ON "AuditLog"("entityId");
- 1415: 
+ 1415: CREATE INDEX IF NOT EXISTS "idx_auditlog_createdAt" ON "AuditLog"("createdAt" DESC);
- 1417: 
+ 1417: -- ----------------------------------------------------------------------------
- 1418: 
+ 1418: -- ApiLog Table - API request logging
- 1419: 
+ 1419: -- ----------------------------------------------------------------------------
- 1420: 
+ 1420: CREATE TABLE IF NOT EXISTS "ApiLog" (
- 1421: 
+ 1421:   "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
- 1422: 
+ 1422:   "userId" TEXT REFERENCES "User"("id") ON DELETE SET NULL,
- 1423: 
+ 1423:   
- 1424: 
+ 1424:   -- Request details
- 1425: 
+ 1425:   "method" TEXT NOT NULL,
- 1426: 
+ 1426:   "path" TEXT NOT NULL,
- 1427: 
+ 1427:   "query" JSONB,
- 1428: 
+ 1428:   "body" JSONB,
- 1429: 
+ 1429:   "headers" JSONB,
- 1430: 
+ 1430:   
- 1431: 
+ 1431:   -- Response
- 1432: 
+ 1432:   "statusCode" INTEGER,
- 1433: 
+ 1433:   "responseTime" INTEGER,
- 1434: 
+ 1434:   "responseSize" INTEGER,
- 1435: 
+ 1435:   
- 1436: 
+ 1436:   -- Client info
- 1437: 
+ 1437:   "ipAddress" TEXT,
- 1438: 
+ 1438:   "userAgent" TEXT,
- 1439: 
+ 1439:   
- 1440: 
+ 1440:   -- Error tracking
- 1441: 
+ 1441:   "error" TEXT,
- 1442: 
+ 1442:   "stackTrace" TEXT,
- 1443: 
+ 1443:   
- 1444: 
+ 1444:   -- Timestamps
- 1445: 
+ 1445:   "createdAt" TIMESTAMP NOT NULL DEFAULT NOW()
- 1446: 
+ 1446: );
- 1448: 
+ 1448: CREATE INDEX IF NOT EXISTS "idx_apilog_userId" ON "ApiLog"("userId");
- 1449: 
+ 1449: CREATE INDEX IF NOT EXISTS "idx_apilog_path" ON "ApiLog"("path");
- 1450: 
+ 1450: CREATE INDEX IF NOT EXISTS "idx_apilog_statusCode" ON "ApiLog"("statusCode");
- 1451: 
+ 1451: CREATE INDEX IF NOT EXISTS "idx_apilog_createdAt" ON "ApiLog"("createdAt" DESC);
- 1453: 
+ 1453: -- ----------------------------------------------------------------------------
- 1454: 
+ 1454: -- ErrorLog Table - Application error logging
- 1455: 
+ 1455: -- ----------------------------------------------------------------------------
- 1456: 
+ 1456: CREATE TABLE IF NOT EXISTS "ErrorLog" (
- 1457: 
+ 1457:   "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
- 1458: 
+ 1458:   "userId" TEXT REFERENCES "User"("id") ON DELETE SET NULL,
- 1459: 
+ 1459:   
- 1460: 
+ 1460:   -- Error details
- 1461: 
+ 1461:   "errorType" TEXT NOT NULL,
- 1462: 
+ 1462:   "errorMessage" TEXT NOT NULL,
- 1463: 
+ 1463:   "stackTrace" TEXT,
- 1464: 
+ 1464:   "context" JSONB,
- 1465: 
+ 1465:   
- 1466: 
+ 1466:   -- Request info
- 1467: 
+ 1467:   "method" TEXT,
- 1468: 
+ 1468:   "path" TEXT,
- 1469: 
+ 1469:   "ipAddress" TEXT,
- 1470: 
+ 1470:   "userAgent" TEXT,
- 1471: 
+ 1471:   
- 1472: 
+ 1472:   -- Severity
- 1473: 
+ 1473:   "severity" TEXT DEFAULT 'ERROR',
- 1474: 
+ 1474:   
- 1475: 
+ 1475:   -- Resolution
- 1476: 
+ 1476:   "resolved" BOOLEAN DEFAULT false,
- 1477: 
+ 1477:   "resolvedAt" TIMESTAMP,
- 1478: 
+ 1478:   "resolvedBy" TEXT,
- 1479: 
+ 1479:   
- 1480: 
+ 1480:   -- Metadata
- 1481: 
+ 1481:   "metadata" JSONB,
- 1482: 
+ 1482:   
- 1483: 
+ 1483:   -- Timestamps
- 1484: 
+ 1484:   "createdAt" TIMESTAMP NOT NULL DEFAULT NOW()
- 1485: 
+ 1485: );
- 1487: 
+ 1487: CREATE INDEX IF NOT EXISTS "idx_errorlog_userId" ON "ErrorLog"("userId");
- 1488: 
+ 1488: CREATE INDEX IF NOT EXISTS "idx_errorlog_errorType" ON "ErrorLog"("errorType");
- 1489: 
+ 1489: CREATE INDEX IF NOT EXISTS "idx_errorlog_severity" ON "ErrorLog"("severity");
- 1490: 
+ 1490: CREATE INDEX IF NOT EXISTS "idx_errorlog_resolved" ON "ErrorLog"("resolved");
- 1491: 
+ 1491: CREATE INDEX IF NOT EXISTS "idx_errorlog_createdAt" ON "ErrorLog"("createdAt" DESC);
- 1493: 
+ 1493: -- ----------------------------------------------------------------------------
- 1494: 
+ 1494: -- PlatformWallet Table - Platform wallet addresses
- 1495: 
+ 1495: -- ----------------------------------------------------------------------------
- 1496: 
+ 1496: CREATE TABLE IF NOT EXISTS "PlatformWallet" (
- 1497: 
+ 1497:   "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
- 1498: 
+ 1498:   
- 1499: 
+ 1499:   -- Wallet details
- 1500: 
+ 1500:   "network" "Network" NOT NULL UNIQUE,
- 1501: 
+ 1501:   "address" TEXT NOT NULL,
- 1502: 
+ 1502:   "label" TEXT,
- 1503: 
+ 1503:   "isActive" BOOLEAN DEFAULT true,
- 1504: 
+ 1504:   
- 1505: 
+ 1505:   -- Balance tracking
- 1506: 
+ 1506:   "lastBalance" DECIMAL(20, 8),
- 1507: 
+ 1507:   "lastBalanceCheck" TIMESTAMP,
- 1508: 
+ 1508:   
- 1509: 
+ 1509:   -- Metadata
- 1510: 
+ 1510:   "metadata" JSONB,
- 1511: 
+ 1511:   
- 1512: 
+ 1512:   -- Timestamps
- 1513: 
+ 1513:   "createdAt" TIMESTAMP NOT NULL DEFAULT NOW(),
- 1514: 
+ 1514:   "updatedAt" TIMESTAMP NOT NULL DEFAULT NOW()
- 1515: 
+ 1515: );
- 1517: 
+ 1517: -- ----------------------------------------------------------------------------
- 1518: 
+ 1518: -- RateLimitTracking Table - Rate limiting
- 1519: 
+ 1519: -- ----------------------------------------------------------------------------
- 1520: 
+ 1520: CREATE TABLE IF NOT EXISTS "RateLimitTracking" (
- 1521: 
+ 1521:   "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
- 1522: 
+ 1522:   "identifier" TEXT NOT NULL,
- 1523: 
+ 1523:   "endpoint" TEXT NOT NULL,
- 1524: 
+ 1524:   "requestCount" INTEGER DEFAULT 1,
- 1525: 
+ 1525:   "windowStart" TIMESTAMP NOT NULL,
- 1526: 
+ 1526:   "windowEnd" TIMESTAMP NOT NULL,
- 1527: 
+ 1527:   "lastRequestAt" TIMESTAMP NOT NULL DEFAULT NOW(),
- 1528: 
+ 1528:   
- 1529: 
+ 1529:   UNIQUE("identifier", "endpoint", "windowStart")
- 1530: 
+ 1530: );
- 1532: 
+ 1532: CREATE INDEX IF NOT EXISTS "idx_ratelimit_identifier" ON "RateLimitTracking"("identifier");
- 1533: 
+ 1533: CREATE INDEX IF NOT EXISTS "idx_ratelimit_windowEnd" ON "RateLimitTracking"("windowEnd");
- 1536: 
+ 1536: -- End included: 04_system_tables.sql
- 1539: 
+ 1539: -- Begin included: 05_functions.sql
- 1540: 
+ 1540: -- ============================================================================
- 1541: 
+ 1541: -- POSTGRESQL FUNCTIONS - Stored procedures and helper functions
- 1542: 
+ 1542: -- ============================================================================
- 1544: 
+ 1544: -- ----------------------------------------------------------------------------
- 1545: 
+ 1545: -- Function: Generate next referral code
- 1546: 
+ 1546: -- ----------------------------------------------------------------------------
- 1547: 
+ 1547: CREATE OR REPLACE FUNCTION get_next_referral_code()
- 1548: 
+ 1548: RETURNS TEXT AS $$
- 1549: 
+ 1549: DECLARE
- 1550: 
+ 1550:   next_value INTEGER;
- 1551: 
+ 1551:   new_code TEXT;
- 1552: 
+ 1552: BEGIN
- 1553: 
+ 1553:   UPDATE "ReferralCounter"
- 1554: 
+ 1554:   SET "currentValue" = "currentValue" + 1,
- 1555: 
+ 1555:       "updatedAt" = NOW()
- 1556: 
+ 1556:   WHERE "counterType" = 'NSCREF'
- 1557: 
+ 1557:   RETURNING "currentValue" INTO next_value;
- 1558: 
+ 1558:   
- 1559: 
+ 1559:   new_code := 'NSCREF' || next_value::TEXT;
- 1560: 
+ 1560:   RETURN new_code;
- 1561: 
+ 1561: END;
- 1562: 
+ 1562: $$ LANGUAGE plpgsql;
- 1564: 
+ 1564: -- ----------------------------------------------------------------------------
- 1565: 
+ 1565: -- Function: Get user's referral tree (6 levels deep)
- 1566: 
+ 1566: -- ----------------------------------------------------------------------------
- 1567: 
+ 1567: CREATE OR REPLACE FUNCTION get_referral_tree(user_referral_code TEXT, max_levels INT DEFAULT 6)
- 1568: 
+ 1568: RETURNS TABLE (
- 1569: 
+ 1569:   "userId" TEXT,
- 1570: 
+ 1570:   "email" TEXT,
- 1571: 
+ 1571:   "fullName" TEXT,
- 1572: 
+ 1572:   "referralCode" TEXT,
- 1573: 
+ 1573:   "level" INTEGER,
- 1574: 
+ 1574:   "createdAt" TIMESTAMP
- 1575: 
+ 1575: ) AS $$
- 1576: 
+ 1576: BEGIN
- 1577: 
+ 1577:   RETURN QUERY
- 1578: 
+ 1578:   WITH RECURSIVE referral_tree AS (
- 1579: 
+ 1579:     -- Base case: Direct referrals (Level 1)
- 1580: 
+ 1580:     SELECT 
- 1581: 
+ 1581:       u."id" as "userId",
- 1582: 
+ 1582:       u."email",
- 1583: 
+ 1583:       u."fullName",
- 1584: 
+ 1584:       u."referralCode",
- 1585: 
+ 1585:       1 as "level",
- 1586: 
+ 1586:       u."createdAt"
- 1587: 
+ 1587:     FROM "User" u
- 1588: 
+ 1588:     WHERE u."referredBy" = user_referral_code
- 1589: 
+ 1589:     
- 1590: 
+ 1590:     UNION ALL
- 1591: 
+ 1591:     
- 1592: 
+ 1592:     -- Recursive case: Get referrals of referrals
- 1593: 
+ 1593:     SELECT 
- 1594: 
+ 1594:       u."id",
- 1595: 
+ 1595:       u."email",
- 1596: 
+ 1596:       u."fullName",
- 1597: 
+ 1597:       u."referralCode",
- 1598: 
+ 1598:       rt."level" + 1,
- 1599: 
+ 1599:       u."createdAt"
- 1600: 
+ 1600:     FROM "User" u
- 1601: 
+ 1601:     INNER JOIN referral_tree rt ON u."referredBy" = rt."referralCode"
- 1602: 
+ 1602:     WHERE rt."level" < max_levels
- 1603: 
+ 1603:   )
- 1604: 
+ 1604:   SELECT * FROM referral_tree
- 1605: 
+ 1605:   ORDER BY "level", "createdAt";
- 1606: 
+ 1606: END;
- 1607: 
+ 1607: $$ LANGUAGE plpgsql;
- 1609: 
+ 1609: -- ----------------------------------------------------------------------------
- 1610: 
+ 1610: -- Function: Calculate total earnings for a user
- 1611: 
+ 1611: -- ----------------------------------------------------------------------------
- 1612: 
+ 1612: CREATE OR REPLACE FUNCTION get_user_total_earnings(p_user_id TEXT)
- 1613: 
+ 1613: RETURNS TABLE (
- 1614: 
+ 1614:   "totalRoi" DECIMAL(20, 8),
- 1615: 
+ 1615:   "totalReferral" DECIMAL(20, 8),
- 1616: 
+ 1616:   "totalLevelIncome" DECIMAL(20, 8),
- 1617: 
+ 1617:   "totalEarnings" DECIMAL(20, 8)
- 1618: 
+ 1618: ) AS $$
- 1619: 
+ 1619: BEGIN
- 1620: 
+ 1620:   RETURN QUERY
- 1621: 
+ 1621:   SELECT
- 1622: 
+ 1622:     COALESCE(SUM(CASE WHEN "type" = 'ROI_PAYMENT' THEN "amount" ELSE 0 END), 0) as "totalRoi",
- 1623: 
+ 1623:     COALESCE(SUM(CASE WHEN "type" = 'REFERRAL_BONUS' THEN "amount" ELSE 0 END), 0) as "totalReferral",
- 1624: 
+ 1624:     COALESCE(SUM(CASE WHEN "type" = 'LEVEL_INCOME' THEN "amount" ELSE 0 END), 0) as "totalLevelIncome",
- 1625: 
+ 1625:     COALESCE(SUM("amount"), 0) as "totalEarnings"
- 1626: 
+ 1626:   FROM "Transaction"
- 1627: 
+ 1627:   WHERE "userId" = p_user_id
- 1628: 
+ 1628:     AND "status" = 'COMPLETED'
- 1629: 
+ 1629:     AND "type" IN ('ROI_PAYMENT', 'REFERRAL_BONUS', 'LEVEL_INCOME');
- 1630: 
+ 1630: END;
- 1631: 
+ 1631: $$ LANGUAGE plpgsql;
- 1633: 
+ 1633: -- ----------------------------------------------------------------------------
- 1634: 
+ 1634: -- Function: Calculate user's available balance for withdrawal
- 1635: 
+ 1635: -- ----------------------------------------------------------------------------
- 1636: 
+ 1636: CREATE OR REPLACE FUNCTION get_user_withdrawal_balance(p_user_id TEXT)
- 1637: 
+ 1637: RETURNS TABLE (
- 1638: 
+ 1638:   "roiBalance" DECIMAL(20, 8),
- 1639: 
+ 1639:   "referralBalance" DECIMAL(20, 8),
- 1640: 
+ 1640:   "capitalBalance" DECIMAL(20, 8),
- 1641: 
+ 1641:   "totalBalance" DECIMAL(20, 8),
- 1642: 
+ 1642:   "pendingWithdrawals" DECIMAL(20, 8),
- 1643: 
+ 1643:   "availableBalance" DECIMAL(20, 8)
- 1644: 
+ 1644: ) AS $$
- 1645: 
+ 1645: DECLARE
- 1646: 
+ 1646:   v_total_earned DECIMAL(20, 8);
- 1647: 
+ 1647:   v_total_withdrawn DECIMAL(20, 8);
- 1648: 
+ 1648:   v_pending DECIMAL(20, 8);
- 1649: 
+ 1649:   v_roi DECIMAL(20, 8);
- 1650: 
+ 1650:   v_referral DECIMAL(20, 8);
- 1651: 
+ 1651:   v_capital DECIMAL(20, 8);
- 1652: 
+ 1652: BEGIN
- 1653: 
+ 1653:   -- Calculate ROI earnings
- 1654: 
+ 1654:   SELECT COALESCE(SUM("amount"), 0) INTO v_roi
- 1655: 
+ 1655:   FROM "Transaction"
- 1656: 
+ 1656:   WHERE "userId" = p_user_id 
- 1657: 
+ 1657:     AND "type" = 'ROI_PAYMENT' 
- 1658: 
+ 1658:     AND "status" = 'COMPLETED';
- 1659: 
+ 1659:   
- 1660: 
+ 1660:   -- Calculate referral earnings
- 1661: 
+ 1661:   SELECT COALESCE(SUM("amount"), 0) INTO v_referral
- 1662: 
+ 1662:   FROM "Transaction"
- 1663: 
+ 1663:   WHERE "userId" = p_user_id 
- 1664: 
+ 1664:     AND "type" IN ('REFERRAL_BONUS', 'LEVEL_INCOME')
- 1665: 
+ 1665:     AND "status" = 'COMPLETED';
- 1666: 
+ 1666:   
- 1667: 
+ 1667:   -- Calculate returned capital
- 1668: 
+ 1668:   SELECT COALESCE(SUM("amount"), 0) INTO v_capital
- 1669: 
+ 1669:   FROM "Transaction"
- 1670: 
+ 1670:   WHERE "userId" = p_user_id 
- 1671: 
+ 1671:     AND "type" = 'CAPITAL_RETURN'
- 1672: 
+ 1672:     AND "status" = 'COMPLETED';
- 1673: 
+ 1673:   
- 1674: 
+ 1674:   -- Calculate total withdrawals
- 1675: 
+ 1675:   SELECT COALESCE(SUM("amount"), 0) INTO v_total_withdrawn
- 1676: 
+ 1676:   FROM "Withdrawal"
- 1677: 
+ 1677:   WHERE "userId" = p_user_id 
- 1678: 
+ 1678:     AND "status" IN ('COMPLETED', 'APPROVED', 'PROCESSING');
- 1679: 
+ 1679:   
- 1680: 
+ 1680:   -- Calculate pending withdrawals
- 1681: 
+ 1681:   SELECT COALESCE(SUM("amount"), 0) INTO v_pending
- 1682: 
+ 1682:   FROM "Withdrawal"
- 1683: 
+ 1683:   WHERE "userId" = p_user_id 
- 1684: 
+ 1684:     AND "status" = 'PENDING';
- 1685: 
+ 1685:   
- 1686: 
+ 1686:   v_total_earned := v_roi + v_referral + v_capital;
- 1687: 
+ 1687:   
- 1688: 
+ 1688:   RETURN QUERY SELECT
- 1689: 
+ 1689:     v_roi,
- 1690: 
+ 1690:     v_referral,
- 1691: 
+ 1691:     v_capital,
- 1692: 
+ 1692:     v_total_earned,
- 1693: 
+ 1693:     v_pending,
- 1694: 
+ 1694:     v_total_earned - v_total_withdrawn - v_pending;
- 1695: 
+ 1695: END;
- 1696: 
+ 1696: $$ LANGUAGE plpgsql;
- 1698: 
+ 1698: -- ----------------------------------------------------------------------------
- 1699: 
+ 1699: -- Function: Check if user can withdraw
- 1700: 
+ 1700: -- ----------------------------------------------------------------------------
- 1701: 
+ 1701: CREATE OR REPLACE FUNCTION check_withdrawal_eligibility(p_user_id TEXT)
- 1702: 
+ 1702: RETURNS TABLE (
- 1703: 
+ 1703:   "canWithdraw" BOOLEAN,
- 1704: 
+ 1704:   "reason" TEXT,
- 1705: 
+ 1705:   "availableBalance" DECIMAL(20, 8),
- 1706: 
+ 1706:   "minWithdrawal" DECIMAL(20, 8),
- 1707: 
+ 1707:   "lastWithdrawalDate" TIMESTAMP,
- 1708: 
+ 1708:   "cooldownDays" INTEGER,
- 1709: 
+ 1709:   "daysUntilNext" INTEGER
- 1710: 
+ 1710: ) AS $$
- 1711: 
+ 1711: DECLARE
- 1712: 
+ 1712:   v_available DECIMAL(20, 8);
- 1713: 
+ 1713:   v_min_withdrawal DECIMAL(20, 8);
- 1714: 
+ 1714:   v_last_withdrawal TIMESTAMP;
- 1715: 
+ 1715:   v_cooldown_days INTEGER;
- 1716: 
+ 1716:   v_days_since INTEGER;
- 1717: 
+ 1717:   v_kyc_status "KYCStatus";
- 1718: 
+ 1718:   v_is_blocked BOOLEAN;
- 1719: 
+ 1719:   v_can_withdraw BOOLEAN := true;
- 1720: 
+ 1720:   v_reason TEXT := '';
- 1721: 
+ 1721: BEGIN
- 1722: 
+ 1722:   -- Get user KYC status and block status
- 1723: 
+ 1723:   SELECT "kycStatus", "isBlocked" INTO v_kyc_status, v_is_blocked
- 1724: 
+ 1724:   FROM "User" WHERE "id" = p_user_id;
- 1725: 
+ 1725:   
- 1726: 
+ 1726:   -- Get system settings
- 1727: 
+ 1727:   SELECT COALESCE("value", '20')::DECIMAL INTO v_min_withdrawal
- 1728: 
+ 1728:   FROM "SystemSetting" WHERE "key" = 'MIN_WITHDRAWAL';
- 1729: 
+ 1729:   
- 1730: 
+ 1730:   SELECT COALESCE("value", '30')::INTEGER INTO v_cooldown_days
- 1731: 
+ 1731:   FROM "SystemSetting" WHERE "key" = 'WITHDRAWAL_COOLDOWN';
- 1732: 
+ 1732:   
- 1733: 
+ 1733:   -- Get available balance
- 1734: 
+ 1734:   SELECT "availableBalance" INTO v_available
- 1735: 
+ 1735:   FROM get_user_withdrawal_balance(p_user_id);
- 1736: 
+ 1736:   
- 1737: 
+ 1737:   -- Get last withdrawal date
- 1738: 
+ 1738:   SELECT MAX("completedAt") INTO v_last_withdrawal
- 1739: 
+ 1739:   FROM "Withdrawal"
- 1740: 
+ 1740:   WHERE "userId" = p_user_id AND "status" = 'COMPLETED';
- 1741: 
+ 1741:   
- 1742: 
+ 1742:   -- Calculate days since last withdrawal
- 1743: 
+ 1743:   IF v_last_withdrawal IS NOT NULL THEN
- 1744: 
+ 1744:     v_days_since := EXTRACT(DAY FROM NOW() - v_last_withdrawal)::INTEGER;
- 1745: 
+ 1745:   ELSE
- 1746: 
+ 1746:     v_days_since := 999;
- 1747: 
+ 1747:   END IF;
- 1748: 
+ 1748:   
- 1749: 
+ 1749:   -- Check eligibility
- 1750: 
+ 1750:   IF v_is_blocked THEN
- 1751: 
+ 1751:     v_can_withdraw := false;
- 1752: 
+ 1752:     v_reason := 'Account is blocked';
- 1753: 
+ 1753:   ELSIF v_kyc_status != 'APPROVED' THEN
- 1754: 
+ 1754:     v_can_withdraw := false;
- 1755: 
+ 1755:     v_reason := 'KYC verification required';
- 1756: 
+ 1756:   ELSIF v_available < v_min_withdrawal THEN
- 1757: 
+ 1757:     v_can_withdraw := false;
- 1758: 
+ 1758:     v_reason := 'Insufficient balance (minimum: ' || v_min_withdrawal || ')';
- 1759: 
+ 1759:   ELSIF v_days_since < v_cooldown_days THEN
- 1760: 
+ 1760:     v_can_withdraw := false;
- 1761: 
+ 1761:     v_reason := 'Withdrawal cooldown active';
- 1762: 
+ 1762:   END IF;
- 1763: 
+ 1763:   
- 1764: 
+ 1764:   RETURN QUERY SELECT
- 1765: 
+ 1765:     v_can_withdraw,
- 1766: 
+ 1766:     v_reason,
- 1767: 
+ 1767:     v_available,
- 1768: 
+ 1768:     v_min_withdrawal,
- 1769: 
+ 1769:     v_last_withdrawal,
- 1770: 
+ 1770:     v_cooldown_days,
- 1771: 
+ 1771:     GREATEST(0, v_cooldown_days - v_days_since);
- 1772: 
+ 1772: END;
- 1773: 
+ 1773: $$ LANGUAGE plpgsql;
- 1775: 
+ 1775: -- ----------------------------------------------------------------------------
- 1776: 
+ 1776: -- Function: Record login attempt
- 1777: 
+ 1777: -- ----------------------------------------------------------------------------
- 1778: 
+ 1778: CREATE OR REPLACE FUNCTION record_login_attempt(
- 1779: 
+ 1779:   p_email TEXT,
- 1780: 
+ 1780:   p_ip_address TEXT,
- 1781: 
+ 1781:   p_user_agent TEXT,
- 1782: 
+ 1782:   p_success BOOLEAN,
- 1783: 
+ 1783:   p_failure_reason TEXT DEFAULT NULL
- 1784: 
+ 1784: )
- 1785: 
+ 1785: RETURNS TEXT AS $$
- 1786: 
+ 1786: DECLARE
- 1787: 
+ 1787:   attempt_id TEXT;
- 1788: 
+ 1788:   v_user_id TEXT;
- 1789: 
+ 1789: BEGIN
- 1790: 
+ 1790:   -- Get user ID if exists
- 1791: 
+ 1791:   SELECT "id" INTO v_user_id FROM "User" WHERE "email" = p_email;
- 1792: 
+ 1792:   
- 1793: 
+ 1793:   attempt_id := gen_random_uuid()::text;
- 1794: 
+ 1794:   
- 1795: 
+ 1795:   INSERT INTO "LoginAttempt" (
- 1796: 
+ 1796:     "id", "email", "userId", "ipAddress", "userAgent", 
- 1797: 
+ 1797:     "success", "failureReason", "createdAt"
- 1798: 
+ 1798:   ) VALUES (
- 1799: 
+ 1799:     attempt_id, p_email, v_user_id, p_ip_address, p_user_agent, 
- 1800: 
+ 1800:     p_success, p_failure_reason, NOW()
- 1801: 
+ 1801:   );
- 1802: 
+ 1802:   
- 1803: 
+ 1803:   -- Update user record if login was successful
- 1804: 
+ 1804:   IF p_success AND v_user_id IS NOT NULL THEN
- 1805: 
+ 1805:     UPDATE "User"
- 1806: 
+ 1806:     SET "lastLogin" = NOW(),
- 1807: 
+ 1807:         "lastLoginIp" = p_ip_address,
- 1808: 
+ 1808:         "failedLoginAttempts" = 0,
- 1809: 
+ 1809:         "lastActiveAt" = NOW()
- 1810: 
+ 1810:     WHERE "id" = v_user_id;
- 1811: 
+ 1811:   ELSIF NOT p_success AND v_user_id IS NOT NULL THEN
- 1812: 
+ 1812:     UPDATE "User"
- 1813: 
+ 1813:     SET "failedLoginAttempts" = COALESCE("failedLoginAttempts", 0) + 1,
- 1814: 
+ 1814:         "lastFailedLoginAt" = NOW()
- 1815: 
+ 1815:     WHERE "id" = v_user_id;
- 1816: 
+ 1816:   END IF;
- 1817: 
+ 1817:   
- 1818: 
+ 1818:   RETURN attempt_id;
- 1819: 
+ 1819: END;
- 1820: 
+ 1820: $$ LANGUAGE plpgsql;
- 1822: 
+ 1822: -- ----------------------------------------------------------------------------
- 1823: 
+ 1823: -- Function: Check login blocking (brute-force protection)
- 1824: 
+ 1824: -- ----------------------------------------------------------------------------
- 1825: 
+ 1825: CREATE OR REPLACE FUNCTION check_login_blocking(
- 1826: 
+ 1826:   p_email TEXT,
- 1827: 
+ 1827:   p_ip_address TEXT,
- 1828: 
+ 1828:   p_max_attempts INT DEFAULT 5,
- 1829: 
+ 1829:   p_window_minutes INT DEFAULT 15
- 1830: 
+ 1830: )
- 1831: 
+ 1831: RETURNS TABLE (
- 1832: 
+ 1832:   "isBlocked" BOOLEAN,
- 1833: 
+ 1833:   "blockReason" TEXT,
- 1834: 
+ 1834:   "failedAttempts" INTEGER,
- 1835: 
+ 1835:   "lastAttemptAt" TIMESTAMP,
- 1836: 
+ 1836:   "blockUntil" TIMESTAMP
- 1837: 
+ 1837: ) AS $$
- 1838: 
+ 1838: DECLARE
- 1839: 
+ 1839:   failed_count INTEGER;
- 1840: 
+ 1840:   last_attempt TIMESTAMP;
- 1841: 
+ 1841:   block_until TIMESTAMP;
- 1842: 
+ 1842:   account_locked_until TIMESTAMP;
- 1843: 
+ 1843: BEGIN
- 1844: 
+ 1844:   -- Check if account is already locked
- 1845: 
+ 1845:   SELECT "accountLockedUntil" INTO account_locked_until
- 1846: 
+ 1846:   FROM "User" WHERE "email" = p_email;
- 1847: 
+ 1847:   
- 1848: 
+ 1848:   IF account_locked_until IS NOT NULL AND account_locked_until > NOW() THEN
- 1849: 
+ 1849:     RETURN QUERY SELECT 
- 1850: 
+ 1850:       true,
- 1851: 
+ 1851:       'Account temporarily locked',
- 1852: 
+ 1852:       0::INTEGER,
- 1853: 
+ 1853:       NULL::TIMESTAMP,
- 1854: 
+ 1854:       account_locked_until;
- 1855: 
+ 1855:     RETURN;
- 1856: 
+ 1856:   END IF;
- 1857: 
+ 1857:   
- 1858: 
+ 1858:   -- Count failed attempts in the time window (by email OR IP address)
- 1859: 
+ 1859:   SELECT COUNT(*), MAX("createdAt")
- 1860: 
+ 1860:   INTO failed_count, last_attempt
- 1861: 
+ 1861:   FROM "LoginAttempt"
- 1862: 
+ 1862:   WHERE ("email" = p_email OR "ipAddress" = p_ip_address)
- 1863: 
+ 1863:     AND "success" = false
- 1864: 
+ 1864:     AND "createdAt" >= NOW() - (p_window_minutes || ' minutes')::INTERVAL;
- 1865: 
+ 1865:   
- 1866: 
+ 1866:   -- Check if blocked
- 1867: 
+ 1867:   IF failed_count >= p_max_attempts THEN
- 1868: 
+ 1868:     block_until := last_attempt + (p_window_minutes || ' minutes')::INTERVAL;
- 1869: 
+ 1869:     
- 1870: 
+ 1870:     -- Update user account lock
- 1871: 
+ 1871:     UPDATE "User"
- 1872: 
+ 1872:     SET "accountLockedUntil" = block_until
- 1873: 
+ 1873:     WHERE "email" = p_email;
- 1874: 
+ 1874:     
- 1875: 
+ 1875:     RETURN QUERY SELECT 
- 1876: 
+ 1876:       true,
- 1877: 
+ 1877:       'Too many failed login attempts',
- 1878: 
+ 1878:       failed_count,
- 1879: 
+ 1879:       last_attempt,
- 1880: 
+ 1880:       block_until;
- 1881: 
+ 1881:   ELSE
- 1882: 
+ 1882:     RETURN QUERY SELECT 
- 1883: 
+ 1883:       false,
- 1884: 
+ 1884:       NULL::TEXT,
- 1885: 
+ 1885:       failed_count,
- 1886: 
+ 1886:       last_attempt,
- 1887: 
+ 1887:       NULL::TIMESTAMP;
- 1888: 
+ 1888:   END IF;
- 1889: 
+ 1889: END;
- 1890: 
+ 1890: $$ LANGUAGE plpgsql;
- 1892: 
+ 1892: -- ----------------------------------------------------------------------------
- 1893: 
+ 1893: -- Function: Calculate referral earnings for a package purchase
- 1894: 
+ 1894: -- ----------------------------------------------------------------------------
- 1895: 
+ 1895: CREATE OR REPLACE FUNCTION calculate_referral_earnings(
- 1896: 
+ 1896:   p_package_id TEXT,
- 1897: 
+ 1897:   p_user_id TEXT,
- 1898: 
+ 1898:   p_amount DECIMAL(20, 8)
- 1899: 
+ 1899: )
- 1900: 
+ 1900: RETURNS TABLE (
- 1901: 
+ 1901:   "level" INTEGER,
- 1902: 
+ 1902:   "referrerId" TEXT,
- 1903: 
+ 1903:   "amount" DECIMAL(20, 8),
- 1904: 
+ 1904:   "percentage" DECIMAL(5, 2)
- 1905: 
+ 1905: ) AS $$
- 1906: 
+ 1906: DECLARE
- 1907: 
+ 1907:   current_user_code TEXT;
- 1908: 
+ 1908:   current_user_id TEXT := p_user_id;
- 1909: 
+ 1909:   current_level INTEGER := 0;
- 1910: 
+ 1910:   -- Level rates match the product spec: levels 1..6
- 1911: 
+ 1911:   level_percentages DECIMAL(5, 2)[] := ARRAY[2.00, 0.75, 0.50, 0.25, 0.15, 0.10];
- 1912: 
+ 1912:   referrer_has_bot BOOLEAN;
- 1913: 
+ 1913: BEGIN
- 1914: 
+ 1914:   -- Get settings for level income percentages
- 1915: 
+ 1915:   -- Use defaults if not found
- 1916: 
+ 1916:   
- 1917: 
+ 1917:   -- Walk up the referral chain
- 1918: 
+ 1918:   WHILE current_level < 6 LOOP
- 1919: 
+ 1919:     -- Get referrer
- 1920: 
+ 1920:     SELECT "referredBy" INTO current_user_code
- 1921: 
+ 1921:     FROM "User" WHERE "id" = current_user_id;
- 1922: 
+ 1922:     
- 1923: 
+ 1923:     EXIT WHEN current_user_code IS NULL;
- 1924: 
+ 1924:     
- 1925: 
+ 1925:     -- Skip default referral code (no earnings)
- 1926: 
+ 1926:     EXIT WHEN current_user_code = 'NSCREF1000';
- 1927: 
+ 1927:     
- 1928: 
+ 1928:     -- Get referrer user ID and check if they have an active bot
- 1929: 
+ 1929:     SELECT "id", 
- 1930: 
+ 1930:            CASE WHEN EXISTS (
- 1931: 
+ 1931:              SELECT 1 FROM "BotActivation" 
- 1932: 
+ 1932:              WHERE "userId" = "User"."id" 
- 1933: 
+ 1933:              AND status = 'ACTIVE'::"BotStatus" 
- 1934: 
+ 1934:              AND "isExpired" = false
- 1935: 
+ 1935:            ) THEN true ELSE false END
- 1936: 
+ 1936:     INTO current_user_id, referrer_has_bot
- 1937: 
+ 1937:     FROM "User" WHERE "referralCode" = current_user_code;
- 1938: 
+ 1938:     
- 1939: 
+ 1939:     EXIT WHEN current_user_id IS NULL;
- 1940: 
+ 1940:     
- 1941: 
+ 1941:     -- Increment the level counter for every step up the chain (buyer -> upline)
- 1942: 
+ 1942:     current_level := current_level + 1;
- 1944: 
+ 1944:     -- Only pay earnings if referrer has an active bot
- 1945: 
+ 1945:     IF referrer_has_bot = true THEN
- 1946: 
+ 1946:       
- 1947: 
+ 1947:       -- Insert earning record
- 1948: 
+ 1948:       INSERT INTO "Earning" (
- 1949: 
+ 1949:         id, "userId", "fromUserId", "earningType", amount, "packageId", level, description, "createdAt"
- 1950: 
+ 1950:       ) VALUES (
- 1951: 
+ 1951:         gen_random_uuid()::text,
- 1952: 
+ 1952:         current_user_id,
- 1953: 
+ 1953:         p_user_id,
- 1954: 
+ 1954:         CASE WHEN current_level = 1 THEN 'DIRECT_REFERRAL'::"EarningType" ELSE 'LEVEL_INCOME'::"EarningType" END,
- 1955: 
+ 1955:         ROUND(p_amount * level_percentages[current_level] / 100, 8),
- 1956: 
+ 1956:         p_package_id,
- 1957: 
+ 1957:         current_level,
- 1958: 
+ 1958:         CASE WHEN current_level = 1 THEN 'Direct referral bonus' ELSE 'Level ' || current_level || ' income' END,
- 1959: 
+ 1959:         NOW()
- 1960: 
+ 1960:       );
- 1961: 
+ 1961:       
- 1962: 
+ 1962:       -- Insert transaction record
- 1963: 
+ 1963:       INSERT INTO "Transaction" (
- 1964: 
+ 1964:         id, "userId", type, amount, status, description, "createdAt", "updatedAt"
- 1965: 
+ 1965:       ) VALUES (
- 1966: 
+ 1966:         gen_random_uuid()::text,
- 1967: 
+ 1967:         current_user_id,
- 1968: 
+ 1968:         CASE WHEN current_level = 1 THEN 'REFERRAL_BONUS'::"TransactionType" ELSE 'LEVEL_INCOME'::"TransactionType" END,
- 1969: 
+ 1969:         ROUND(p_amount * level_percentages[current_level] / 100, 8),
- 1970: 
+ 1970:         'COMPLETED'::"TransactionStatus",
- 1971: 
+ 1971:         CASE WHEN current_level = 1 THEN 'Direct referral bonus from package purchase' ELSE 'Level ' || current_level || ' income from package purchase' END,
- 1972: 
+ 1972:         NOW(),
- 1973: 
+ 1973:         NOW()
- 1974: 
+ 1974:       );
- 1975: 
+ 1975:       
- 1976: 
+ 1976:       -- Return earning record
- 1977: 
+ 1977:       RETURN QUERY SELECT
- 1978: 
+ 1978:         current_level,
- 1979: 
+ 1979:         current_user_id,
- 1980: 
+ 1980:         ROUND(p_amount * level_percentages[current_level] / 100, 8),
- 1981: 
+ 1981:         level_percentages[current_level];
- 1982: 
+ 1982:     ELSE
- 1983: 
+ 1983:       -- Referrer hasn't bought bot: record as lost commission, continue up the chain
- 1984: 
+ 1984:       -- Referrer hasn't bought bot: record as lost commission for the correct level
- 1985: 
+ 1985:       INSERT INTO "LostCommission" (id, "packageId", "wouldBeRecipientId", level, amount, reason, "createdAt")
- 1986: 
+ 1986:       VALUES (gen_random_uuid()::text, p_package_id, current_user_id, current_level, ROUND(p_amount * level_percentages[current_level] / 100, 8), 'no_bot', NOW());
- 1987: 
+ 1987:       -- do not increment current_level (only count paid levels), continue looping
- 1988: 
+ 1988:       CONTINUE;
- 1989: 
+ 1989:     END IF;
- 1990: 
+ 1990:   END LOOP;
- 1991: 
+ 1991:   
- 1992: 
+ 1992:   RETURN;
- 1993: 
+ 1993: END;
- 1994: 
+ 1994: $$ LANGUAGE plpgsql;
- 1996: 
+ 1996: -- ----------------------------------------------------------------------------
- 1997: 
+ 1997: -- Function: Cleanup old records (maintenance)
- 1998: 
+ 1998: -- ----------------------------------------------------------------------------
- 1999: 
+ 1999: CREATE OR REPLACE FUNCTION cleanup_old_records(p_days_to_keep INT DEFAULT 90)
- 2000: 
+ 2000: RETURNS TABLE (
- 2001: 
+ 2001:   "table_name" TEXT,
- 2002: 
+ 2002:   "deleted_count" INTEGER
- 2003: 
+ 2003: ) AS $$
- 2004: 
+ 2004: DECLARE
- 2005: 
+ 2005:   v_deleted INTEGER;
- 2006: 
+ 2006: BEGIN
- 2007: 
+ 2007:   -- Cleanup old login attempts
- 2008: 
+ 2008:   DELETE FROM "LoginAttempt"
- 2009: 
+ 2009:   WHERE "createdAt" < NOW() - (p_days_to_keep || ' days')::INTERVAL;
- 2010: 
+ 2010:   GET DIAGNOSTICS v_deleted = ROW_COUNT;
- 2011: 
+ 2011:   RETURN QUERY SELECT 'LoginAttempt'::TEXT, v_deleted;
- 2012: 
+ 2012:   
- 2013: 
+ 2013:   -- Cleanup old notifications
- 2014: 
+ 2014:   DELETE FROM "Notification"
- 2015: 
+ 2015:   WHERE "read" = true 
- 2016: 
+ 2016:     AND "createdAt" < NOW() - (p_days_to_keep || ' days')::INTERVAL;
- 2017: 
+ 2017:   GET DIAGNOSTICS v_deleted = ROW_COUNT;
- 2018: 
+ 2018:   RETURN QUERY SELECT 'Notification'::TEXT, v_deleted;
- 2019: 
+ 2019:   
- 2020: 
+ 2020:   -- Cleanup expired payment requests
- 2021: 
+ 2021:   DELETE FROM "PaymentRequest"
- 2022: 
+ 2022:   WHERE "status" IN ('EXPIRED', 'FAILED', 'CANCELLED')
- 2023: 
+ 2023:     AND "createdAt" < NOW() - (p_days_to_keep || ' days')::INTERVAL;
- 2024: 
+ 2024:   GET DIAGNOSTICS v_deleted = ROW_COUNT;
- 2025: 
+ 2025:   RETURN QUERY SELECT 'PaymentRequest'::TEXT, v_deleted;
- 2026: 
+ 2026:   
- 2027: 
+ 2027:   -- Cleanup old API logs
- 2028: 
+ 2028:   DELETE FROM "ApiLog"
- 2029: 
+ 2029:   WHERE "createdAt" < NOW() - (p_days_to_keep || ' days')::INTERVAL;
- 2030: 
+ 2030:   GET DIAGNOSTICS v_deleted = ROW_COUNT;
- 2031: 
+ 2031:   RETURN QUERY SELECT 'ApiLog'::TEXT, v_deleted;
- 2032: 
+ 2032:   
- 2033: 
+ 2033:   -- Cleanup old sessions
- 2034: 
+ 2034:   DELETE FROM "Session"
- 2035: 
+ 2035:   WHERE "expiresAt" < NOW() - (p_days_to_keep || ' days')::INTERVAL;
- 2036: 
+ 2036:   GET DIAGNOSTICS v_deleted = ROW_COUNT;
- 2037: 
+ 2037:   RETURN QUERY SELECT 'Session'::TEXT, v_deleted;
- 2038: 
+ 2038:   
- 2039: 
+ 2039:   RETURN;
- 2040: 
+ 2040: END;
- 2041: 
+ 2041: $$ LANGUAGE plpgsql;
- 2043: 
+ 2043: -- ----------------------------------------------------------------------------
- 2044: 
+ 2044: -- Function: Get package ROI schedule
- 2045: 
+ 2045: -- ----------------------------------------------------------------------------
- 2046: 
+ 2046: CREATE OR REPLACE FUNCTION get_package_roi_schedule(p_package_id TEXT)
- 2047: 
+ 2047: RETURNS TABLE (
- 2048: 
+ 2048:   "monthNumber" INTEGER,
- 2049: 
+ 2049:   "scheduledDate" TIMESTAMP,
- 2050: 
+ 2050:   "amount" DECIMAL(20, 8),
- 2051: 
+ 2051:   "status" TEXT,
- 2052: 
+ 2052:   "paidAt" TIMESTAMP
- 2053: 
+ 2053: ) AS $$
- 2054: 
+ 2054: DECLARE
- 2055: 
+ 2055:   v_investment_date TIMESTAMP;
- 2056: 
+ 2056:   v_amount DECIMAL(20, 8);
- 2057: 
+ 2057:   v_roi_percentage DECIMAL(5, 2);
- 2058: 
+ 2058:   v_monthly_roi DECIMAL(20, 8);
- 2059: 
+ 2059:   i INTEGER;
- 2060: 
+ 2060: BEGIN
- 2061: 
+ 2061:   -- Get package details
- 2062: 
+ 2062:   SELECT "investmentDate", "amount", "roiPercentage"
- 2063: 
+ 2063:   INTO v_investment_date, v_amount, v_roi_percentage
- 2064: 
+ 2064:   FROM "Package"
- 2065: 
+ 2065:   WHERE "id" = p_package_id;
- 2066: 
+ 2066:   
- 2067: 
+ 2067:   IF v_investment_date IS NULL THEN
- 2068: 
+ 2068:     RETURN;
- 2069: 
+ 2069:   END IF;
- 2070: 
+ 2070:   
- 2071: 
+ 2071:   v_monthly_roi := ROUND(v_amount * v_roi_percentage / 100, 8);
- 2072: 
+ 2072:   
- 2073: 
+ 2073:   -- Generate 12 months schedule
- 2074: 
+ 2074:   FOR i IN 1..12 LOOP
- 2075: 
+ 2075:     RETURN QUERY
- 2076: 
+ 2076:     SELECT
- 2077: 
+ 2077:       i,
- 2078: 
+ 2078:       v_investment_date + (i || ' months')::INTERVAL,
- 2079: 
+ 2079:       v_monthly_roi,
- 2080: 
+ 2080:       COALESCE(
- 2081: 
+ 2081:         (SELECT rp."status"::TEXT FROM "RoiPayment" rp 
- 2082: 
+ 2082:          WHERE rp."packageId" = p_package_id AND rp."monthNumber" = i),
- 2083: 
+ 2083:         'PENDING'
- 2084: 
+ 2084:       ),
- 2085: 
+ 2085:       (SELECT rp."paidAt" FROM "RoiPayment" rp 
- 2086: 
+ 2086:        WHERE rp."packageId" = p_package_id AND rp."monthNumber" = i);
- 2087: 
+ 2087:   END LOOP;
- 2088: 
+ 2088:   
- 2089: 
+ 2089:   RETURN;
- 2090: 
+ 2090: END;
- 2091: 
+ 2091: $$ LANGUAGE plpgsql;
- 2093: 
+ 2093: -- ----------------------------------------------------------------------------
- 2094: 
+ 2094: -- Function: Get platform statistics
- 2095: 
+ 2095: -- ----------------------------------------------------------------------------
- 2096: 
+ 2096: CREATE OR REPLACE FUNCTION get_platform_statistics()
- 2097: 
+ 2097: RETURNS TABLE (
- 2098: 
+ 2098:   "totalUsers" BIGINT,
- 2099: 
+ 2099:   "activeUsers" BIGINT,
- 2100: 
+ 2100:   "totalPackages" BIGINT,
- 2101: 
+ 2101:   "activePackages" BIGINT,
- 2102: 
+ 2102:   "totalInvested" DECIMAL(20, 8),
- 2103: 
+ 2103:   "totalRoiPaid" DECIMAL(20, 8),
- 2104: 
+ 2104:   "totalWithdrawals" DECIMAL(20, 8),
- 2105: 
+ 2105:   "pendingWithdrawals" BIGINT
- 2106: 
+ 2106: ) AS $$
- 2107: 
+ 2107: BEGIN
- 2108: 
+ 2108:   RETURN QUERY
- 2109: 
+ 2109:   SELECT
- 2110: 
+ 2110:     (SELECT COUNT(*) FROM "User" WHERE "isActive" = true) as "totalUsers",
- 2111: 
+ 2111:     (SELECT COUNT(*) FROM "User" WHERE "lastLogin" > NOW() - INTERVAL '30 days') as "activeUsers",
- 2112: 
+ 2112:     (SELECT COUNT(*) FROM "Package") as "totalPackages",
- 2113: 
+ 2113:     (SELECT COUNT(*) FROM "Package" WHERE "status" = 'ACTIVE') as "activePackages",
- 2114: 
+ 2114:     (SELECT COALESCE(SUM("amount"), 0) FROM "Package" WHERE "status" IN ('ACTIVE', 'EXPIRED', 'COMPLETED')) as "totalInvested",
- 2115: 
+ 2115:     (SELECT COALESCE(SUM("amount"), 0) FROM "RoiPayment" WHERE "status" = 'COMPLETED') as "totalRoiPaid",
- 2116: 
+ 2116:     (SELECT COALESCE(SUM("amount"), 0) FROM "Withdrawal" WHERE "status" = 'COMPLETED') as "totalWithdrawals",
- 2117: 
+ 2117:     (SELECT COUNT(*) FROM "Withdrawal" WHERE "status" = 'PENDING') as "pendingWithdrawals";
- 2118: 
+ 2118: END;
- 2119: 
+ 2119: $$ LANGUAGE plpgsql;
- 2121: 
+ 2121: -- ----------------------------------------------------------------------------
- 2122: 
+ 2122: -- Session Management Functions
- 2123: 
+ 2123: -- ----------------------------------------------------------------------------
- 2125: 
+ 2125: -- Create a new session
- 2126: 
+ 2126: CREATE OR REPLACE FUNCTION create_session(
- 2127: 
+ 2127:   p_user_id TEXT,
- 2128: 
+ 2128:   p_token_hash TEXT,
- 2129: 
+ 2129:   p_refresh_token_hash TEXT,
- 2130: 
+ 2130:   p_ip_address TEXT,
- 2131: 
+ 2131:   p_user_agent TEXT,
- 2132: 
+ 2132:   p_expires_at TIMESTAMP
- 2133: 
+ 2133: )
- 2134: 
+ 2134: RETURNS TEXT AS $$
- 2135: 
+ 2135: DECLARE
- 2136: 
+ 2136:   v_session_id TEXT;
- 2137: 
+ 2137: BEGIN
- 2138: 
+ 2138:   v_session_id := gen_random_uuid()::text;
- 2139: 
+ 2139:   
- 2140: 
+ 2140:   INSERT INTO "Session" (
- 2141: 
+ 2141:     "id", "userId", "token", "refreshToken", "ipAddress", "userAgent",
- 2142: 
+ 2142:     "expiresAt", "isActive", "status", "createdAt", "lastUsedAt"
- 2143: 
+ 2143:   ) VALUES (
- 2144: 
+ 2144:     v_session_id, p_user_id, p_token_hash, p_refresh_token_hash, p_ip_address, p_user_agent,
- 2145: 
+ 2145:     p_expires_at, true, 'ACTIVE', NOW(), NOW()
- 2146: 
+ 2146:   );
- 2147: 
+ 2147:   
- 2148: 
+ 2148:   RETURN v_session_id;
- 2149: 
+ 2149: END;
- 2150: 
+ 2150: $$ LANGUAGE plpgsql;
- 2152: 
+ 2152: -- ----------------------------------------------------------------------------
- 2153: 
+ 2153: -- Function: Get user balance (OPTIMIZED)
- 2154: 
+ 2154: -- Added: 2025-11-11
- 2155: 
+ 2155: -- ----------------------------------------------------------------------------
- 2156: 
+ 2156: CREATE OR REPLACE FUNCTION get_user_balance(p_user_id TEXT)
- 2157: 
+ 2157: RETURNS TABLE (
- 2158: 
+ 2158:   "roiBalance" NUMERIC,
- 2159: 
+ 2159:   "referralBalance" NUMERIC,
- 2160: 
+ 2160:   "levelBalance" NUMERIC,
- 2161: 
+ 2161:   "totalBalance" NUMERIC,
- 2162: 
+ 2162:   "lockedCapital" NUMERIC
- 2163: 
+ 2163: ) AS $$
- 2164: 
+ 2164: DECLARE
- 2165: 
+ 2165:   v_roi_balance NUMERIC;
- 2166: 
+ 2166:   v_referral_balance NUMERIC;
- 2167: 
+ 2167:   v_level_balance NUMERIC;
- 2168: 
+ 2168:   v_total_withdrawn NUMERIC;
- 2169: 
+ 2169:   v_locked_capital NUMERIC;
- 2170: 
+ 2170:   v_total_earned NUMERIC;
- 2171: 
+ 2171:   v_total_balance NUMERIC;
- 2172: 
+ 2172: BEGIN
- 2173: 
+ 2173:   -- Get ROI balance
- 2174: 
+ 2174:   SELECT COALESCE(SUM(amount)::NUMERIC, 0)
- 2175: 
+ 2175:   INTO v_roi_balance
- 2176: 
+ 2176:   FROM "Transaction"
- 2177: 
+ 2177:   WHERE "userId" = p_user_id
- 2178: 
+ 2178:   AND type = 'ROI_PAYMENT'
- 2179: 
+ 2179:   AND status = 'COMPLETED';
- 2181: 
+ 2181:   -- Get referral balance
- 2182: 
+ 2182:   SELECT COALESCE(SUM(amount)::NUMERIC, 0)
- 2183: 
+ 2183:   INTO v_referral_balance
- 2184: 
+ 2184:   FROM "Earning"
- 2185: 
+ 2185:   WHERE "userId" = p_user_id
- 2186: 
+ 2186:   AND "earningType" = 'DIRECT_REFERRAL'::"EarningType";
- 2188: 
+ 2188:   -- Get level balance
- 2189: 
+ 2189:   SELECT COALESCE(SUM(amount)::NUMERIC, 0)
- 2190: 
+ 2190:   INTO v_level_balance
- 2191: 
+ 2191:   FROM "Earning"
- 2192: 
+ 2192:   WHERE "userId" = p_user_id
- 2193: 
+ 2193:   AND "earningType" = 'LEVEL_INCOME'::"EarningType";
- 2195: 
+ 2195:   -- Get total withdrawn
- 2196: 
+ 2196:   SELECT COALESCE(SUM(amount)::NUMERIC, 0)
- 2197: 
+ 2197:   INTO v_total_withdrawn
- 2198: 
+ 2198:   FROM "Withdrawal"
- 2199: 
+ 2199:   WHERE "userId" = p_user_id
- 2200: 
+ 2200:   AND status = 'COMPLETED';
- 2202: 
+ 2202:   -- Get locked capital
- 2203: 
+ 2203:   SELECT COALESCE(SUM(amount)::NUMERIC, 0)
- 2204: 
+ 2204:   INTO v_locked_capital
- 2205: 
+ 2205:   FROM "Package"
- 2206: 
+ 2206:   WHERE "userId" = p_user_id
- 2207: 
+ 2207:   AND status = 'ACTIVE';
- 2209: 
+ 2209:   -- Calculate totals
- 2210: 
+ 2210:   v_total_earned := v_roi_balance + v_referral_balance + v_level_balance;
- 2211: 
+ 2211:   v_total_balance := GREATEST(v_total_earned - v_total_withdrawn, 0);
- 2213: 
+ 2213:   -- Return the values
- 2214: 
+ 2214:   RETURN QUERY
- 2215: 
+ 2215:   SELECT
- 2216: 
+ 2216:     v_roi_balance,
- 2217: 
+ 2217:     v_referral_balance,
- 2218: 
+ 2218:     v_level_balance,
- 2219: 
+ 2219:     v_total_balance,
- 2220: 
+ 2220:     v_locked_capital;
- 2221: 
+ 2221: END;
- 2222: 
+ 2222: $$ LANGUAGE plpgsql;
- 2224: 
+ 2224: -- ----------------------------------------------------------------------------
- 2225: 
+ 2225: -- Function: Validate session
- 2226: 
+ 2226: -- Added: 2025-11-11
- 2227: 
+ 2227: -- ----------------------------------------------------------------------------
- 2228: 
+ 2228: CREATE OR REPLACE FUNCTION validate_session(p_token_hash TEXT)
- 2229: 
+ 2229: RETURNS TABLE (
- 2230: 
+ 2230:   "sessionId" TEXT,
- 2231: 
+ 2231:   "userId" TEXT,
- 2232: 
+ 2232:   "ipAddress" TEXT,
- 2233: 
+ 2233:   "userAgent" TEXT,
- 2234: 
+ 2234:   "isValid" BOOLEAN,
- 2235: 
+ 2235:   "createdAt" TIMESTAMP,
- 2236: 
+ 2236:   "lastUsedAt" TIMESTAMP,
- 2237: 
+ 2237:   "expiresAt" TIMESTAMP
- 2238: 
+ 2238: ) AS $$
- 2239: 
+ 2239: DECLARE
- 2240: 
+ 2240:   v_session RECORD;
- 2241: 
+ 2241: BEGIN
- 2242: 
+ 2242:   SELECT
- 2243: 
+ 2243:     s.id,
- 2244: 
+ 2244:     s."userId",
- 2245: 
+ 2245:     s."ipAddress",
- 2246: 
+ 2246:     s."userAgent",
- 2247: 
+ 2247:     s."createdAt",
- 2248: 
+ 2248:     s."lastActivityAt",
- 2249: 
+ 2249:     s."expiresAt",
- 2250: 
+ 2250:     s."isActive"
- 2251: 
+ 2251:   INTO v_session
- 2252: 
+ 2252:   FROM "Session" s
- 2253: 
+ 2253:   WHERE s."tokenHash" = p_token_hash
- 2254: 
+ 2254:   AND s."isActive" = true
- 2255: 
+ 2255:   AND s."expiresAt" > NOW()
- 2256: 
+ 2256:   LIMIT 1;
- 2258: 
+ 2258:   IF NOT FOUND THEN
- 2259: 
+ 2259:     RETURN QUERY SELECT
- 2260: 
+ 2260:       NULL::TEXT, NULL::TEXT, NULL::TEXT, NULL::TEXT,
- 2261: 
+ 2261:       false, NULL::TIMESTAMP, NULL::TIMESTAMP, NULL::TIMESTAMP;
- 2262: 
+ 2262:     RETURN;
- 2263: 
+ 2263:   END IF;
- 2265: 
+ 2265:   UPDATE "Session"
- 2266: 
+ 2266:   SET "lastActivityAt" = NOW()
- 2267: 
+ 2267:   WHERE id = v_session.id;
- 2269: 
+ 2269:   RETURN QUERY SELECT
- 2270: 
+ 2270:     v_session.id,
- 2271: 
+ 2271:     v_session."userId",
- 2272: 
+ 2272:     v_session."ipAddress",
- 2273: 
+ 2273:     v_session."userAgent",
- 2274: 
+ 2274:     true,
- 2275: 
+ 2275:     v_session."createdAt",
- 2276: 
+ 2276:     v_session."lastActivityAt",
- 2277: 
+ 2277:     v_session."expiresAt";
- 2278: 
+ 2278: END;
- 2279: 
+ 2279: $$ LANGUAGE plpgsql;
- 2281: 
+ 2281: -- ----------------------------------------------------------------------------
- 2282: 
+ 2282: -- Function: Revoke session
- 2283: 
+ 2283: -- Added: 2025-11-11
- 2284: 
+ 2284: -- ----------------------------------------------------------------------------
- 2285: 
+ 2285: CREATE OR REPLACE FUNCTION revoke_session(p_session_id TEXT)
- 2286: 
+ 2286: RETURNS BOOLEAN AS $$
- 2287: 
+ 2287: DECLARE
- 2288: 
+ 2288:   v_updated INTEGER;
- 2289: 
+ 2289: BEGIN
- 2290: 
+ 2290:   UPDATE "Session"
- 2291: 
+ 2291:   SET "isActive" = false
- 2292: 
+ 2292:   WHERE id = p_session_id;
- 2294: 
+ 2294:   GET DIAGNOSTICS v_updated = ROW_COUNT;
- 2295: 
+ 2295:   RETURN v_updated > 0;
- 2296: 
+ 2296: END;
- 2297: 
+ 2297: $$ LANGUAGE plpgsql;
- 2299: 
+ 2299: -- ----------------------------------------------------------------------------
- 2300: 
+ 2300: -- Function: Revoke all user sessions
- 2301: 
+ 2301: -- Added: 2025-11-11
- 2302: 
+ 2302: -- ----------------------------------------------------------------------------
- 2303: 
+ 2303: CREATE OR REPLACE FUNCTION revoke_all_user_sessions(p_user_id TEXT)
- 2304: 
+ 2304: RETURNS INTEGER AS $$
- 2305: 
+ 2305: DECLARE
- 2306: 
+ 2306:   v_updated INTEGER;
- 2307: 
+ 2307: BEGIN
- 2308: 
+ 2308:   UPDATE "Session"
- 2309: 
+ 2309:   SET "isActive" = false
- 2310: 
+ 2310:   WHERE "userId" = p_user_id
- 2311: 
+ 2311:   AND "isActive" = true;
- 2313: 
+ 2313:   GET DIAGNOSTICS v_updated = ROW_COUNT;
- 2314: 
+ 2314:   RETURN v_updated;
- 2315: 
+ 2315: END;
- 2316: 
+ 2316: $$ LANGUAGE plpgsql;
- 2318: 
+ 2318: -- ----------------------------------------------------------------------------
- 2319: 
+ 2319: -- Function: Revoke other sessions
- 2320: 
+ 2320: -- Added: 2025-11-11
- 2321: 
+ 2321: -- ----------------------------------------------------------------------------
- 2322: 
+ 2322: CREATE OR REPLACE FUNCTION revoke_other_sessions(
- 2323: 
+ 2323:   p_user_id TEXT,
- 2324: 
+ 2324:   p_current_session_id TEXT
- 2325: 
+ 2325: )
- 2326: 
+ 2326: RETURNS INTEGER AS $$
- 2327: 
+ 2327: DECLARE
- 2328: 
+ 2328:   v_updated INTEGER;
- 2329: 
+ 2329: BEGIN
- 2330: 
+ 2330:   UPDATE "Session"
- 2331: 
+ 2331:   SET "isActive" = false
- 2332: 
+ 2332:   WHERE "userId" = p_user_id
- 2333: 
+ 2333:   AND id != p_current_session_id
- 2334: 
+ 2334:   AND "isActive" = true;
- 2336: 
+ 2336:   GET DIAGNOSTICS v_updated = ROW_COUNT;
- 2337: 
+ 2337:   RETURN v_updated;
- 2338: 
+ 2338: END;
- 2339: 
+ 2339: $$ LANGUAGE plpgsql;
- 2341: 
+ 2341: -- ----------------------------------------------------------------------------
- 2342: 
+ 2342: -- Function: Get user sessions
- 2343: 
+ 2343: -- Added: 2025-11-11
- 2344: 
+ 2344: -- ----------------------------------------------------------------------------
- 2345: 
+ 2345: CREATE OR REPLACE FUNCTION get_user_sessions(p_user_id TEXT)
- 2346: 
+ 2346: RETURNS TABLE (
- 2347: 
+ 2347:   "sessionId" TEXT,
- 2348: 
+ 2348:   "ipAddress" TEXT,
- 2349: 
+ 2349:   "userAgent" TEXT,
- 2350: 
+ 2350:   "isActive" BOOLEAN,
- 2351: 
+ 2351:   "createdAt" TIMESTAMP,
- 2352: 
+ 2352:   "lastUsedAt" TIMESTAMP,
- 2353: 
+ 2353:   "expiresAt" TIMESTAMP
- 2354: 
+ 2354: ) AS $$
- 2355: 
+ 2355: BEGIN
- 2356: 
+ 2356:   RETURN QUERY
- 2357: 
+ 2357:   SELECT
- 2358: 
+ 2358:     s.id,
- 2359: 
+ 2359:     s."ipAddress",
- 2360: 
+ 2360:     s."userAgent",
- 2361: 
+ 2361:     s."isActive",
- 2362: 
+ 2362:     s."createdAt",
- 2363: 
+ 2363:     s."lastActivityAt",
- 2364: 
+ 2364:     s."expiresAt"
- 2365: 
+ 2365:   FROM "Session" s
- 2366: 
+ 2366:   WHERE s."userId" = p_user_id
- 2367: 
+ 2367:   ORDER BY s."lastActivityAt" DESC;
- 2368: 
+ 2368: END;
- 2369: 
+ 2369: $$ LANGUAGE plpgsql;
- 2372: 
+ 2372: -- End included: 05_functions.sql
- 2375: 
+ 2375: -- Begin included: 06_triggers.sql
- 2376: 
+ 2376: -- ============================================================================
- 2377: 
+ 2377: -- TRIGGERS - Automatic database triggers
- 2378: 
+ 2378: -- ============================================================================
- 2380: 
+ 2380: -- ----------------------------------------------------------------------------
- 2381: 
+ 2381: -- Trigger: Update "updatedAt" timestamp automatically
- 2382: 
+ 2382: -- ----------------------------------------------------------------------------
- 2383: 
+ 2383: CREATE OR REPLACE FUNCTION update_updated_at_column()
- 2384: 
+ 2384: RETURNS TRIGGER AS $$
- 2385: 
+ 2385: BEGIN
- 2386: 
+ 2386:   NEW."updatedAt" = NOW();
- 2387: 
+ 2387:   RETURN NEW;
- 2388: 
+ 2388: END;
- 2389: 
+ 2389: $$ LANGUAGE plpgsql;
- 2391: 
+ 2391: -- Apply to all tables with updatedAt column
- 2392: 
+ 2392: DROP TRIGGER IF EXISTS update_user_updated_at ON "User";CREATE TRIGGER update_user_updated_at BEFORE UPDATE ON "User"
- 2393: 
+ 2393:   FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
- 2395: 
+ 2395: DROP TRIGGER IF EXISTS update_package_updated_at ON "Package";CREATE TRIGGER update_package_updated_at BEFORE UPDATE ON "Package"
- 2396: 
+ 2396:   FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
- 2398: 
+ 2398: DROP TRIGGER IF EXISTS update_botactivation_updated_at ON "BotActivation";CREATE TRIGGER update_botactivation_updated_at BEFORE UPDATE ON "BotActivation"
- 2399: 
+ 2399:   FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
- 2401: 
+ 2401: DROP TRIGGER IF EXISTS update_transaction_updated_at ON "Transaction";CREATE TRIGGER update_transaction_updated_at BEFORE UPDATE ON "Transaction"
- 2402: 
+ 2402:   FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
- 2404: 
+ 2404: DROP TRIGGER IF EXISTS update_withdrawal_updated_at ON "Withdrawal";CREATE TRIGGER update_withdrawal_updated_at BEFORE UPDATE ON "Withdrawal"
- 2405: 
+ 2405:   FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
- 2407: 
+ 2407: DROP TRIGGER IF EXISTS update_paymentrequest_updated_at ON "PaymentRequest";CREATE TRIGGER update_paymentrequest_updated_at BEFORE UPDATE ON "PaymentRequest"
- 2408: 
+ 2408:   FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
- 2410: 
+ 2410: DROP TRIGGER IF EXISTS update_paymentconfirmation_updated_at ON "PaymentConfirmation";CREATE TRIGGER update_paymentconfirmation_updated_at BEFORE UPDATE ON "PaymentConfirmation"
- 2411: 
+ 2411:   FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
- 2413: 
+ 2413: DROP TRIGGER IF EXISTS update_kycsubmission_updated_at ON "KYCSubmission";CREATE TRIGGER update_kycsubmission_updated_at BEFORE UPDATE ON "KYCSubmission"
- 2414: 
+ 2414:   FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
- 2416: 
+ 2416: DROP TRIGGER IF EXISTS update_supportticket_updated_at ON "SupportTicket";CREATE TRIGGER update_supportticket_updated_at BEFORE UPDATE ON "SupportTicket"
- 2417: 
+ 2417:   FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
- 2419: 
+ 2419: DROP TRIGGER IF EXISTS update_systemsetting_updated_at ON "SystemSetting";CREATE TRIGGER update_systemsetting_updated_at BEFORE UPDATE ON "SystemSetting"
- 2420: 
+ 2420:   FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
- 2422: 
+ 2422: DROP TRIGGER IF EXISTS update_cronjob_updated_at ON "CronJob";CREATE TRIGGER update_cronjob_updated_at BEFORE UPDATE ON "CronJob"
- 2423: 
+ 2423:   FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
- 2425: 
+ 2425: DROP TRIGGER IF EXISTS update_platformwallet_updated_at ON "PlatformWallet";CREATE TRIGGER update_platformwallet_updated_at BEFORE UPDATE ON "PlatformWallet"
- 2426: 
+ 2426:   FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
- 2428: 
+ 2428: -- ----------------------------------------------------------------------------
- 2429: 
+ 2429: -- Trigger: Auto-generate referral code on user registration
- 2430: 
+ 2430: -- ----------------------------------------------------------------------------
- 2431: 
+ 2431: CREATE OR REPLACE FUNCTION generate_referral_code()
- 2432: 
+ 2432: RETURNS TRIGGER AS $$
- 2433: 
+ 2433: BEGIN
- 2434: 
+ 2434:   IF NEW."referralCode" IS NULL OR NEW."referralCode" = '' THEN
- 2435: 
+ 2435:     NEW."referralCode" = get_next_referral_code();
- 2436: 
+ 2436:   END IF;
- 2437: 
+ 2437:   RETURN NEW;
- 2438: 
+ 2438: END;
- 2439: 
+ 2439: $$ LANGUAGE plpgsql;
- 2441: 
+ 2441: DROP TRIGGER IF EXISTS user_generate_referral_code ON "User";CREATE TRIGGER user_generate_referral_code BEFORE INSERT ON "User"
- 2442: 
+ 2442:   FOR EACH ROW EXECUTE FUNCTION generate_referral_code();
- 2444: 
+ 2444: -- ----------------------------------------------------------------------------
- 2445: 
+ 2445: -- Trigger: Create notification on important events
- 2446: 
+ 2446: -- ----------------------------------------------------------------------------
- 2447: 
+ 2447: CREATE OR REPLACE FUNCTION create_event_notification()
- 2448: 
+ 2448: RETURNS TRIGGER AS $$
- 2449: 
+ 2449: BEGIN
- 2450: 
+ 2450:   -- Package activated (only for Package table)
- 2451: 
+ 2451:   IF TG_TABLE_NAME = 'Package' THEN
- 2452: 
+ 2452:     IF NEW."status" = 'ACTIVE' AND OLD."status" = 'PENDING' THEN
- 2453: 
+ 2453:       INSERT INTO "Notification" ("id", "userId", "title", "message", "type", "referenceId", "referenceType")
- 2454: 
+ 2454:       VALUES (
- 2455: 
+ 2455:         gen_random_uuid()::text,
- 2456: 
+ 2456:         NEW."userId",
- 2457: 
+ 2457:         'Package Activated',
- 2458: 
+ 2458:         'Your ' || NEW."packageType" || ' package has been activated successfully!',
- 2459: 
+ 2459:         'SUCCESS',
- 2460: 
+ 2460:         NEW."id",
- 2461: 
+ 2461:         'PACKAGE'
- 2462: 
+ 2462:       );
- 2463: 
+ 2463:     END IF;
- 2464: 
+ 2464:   END IF;
- 2465: 
+ 2465:   
- 2466: 
+ 2466:   -- Withdrawal notifications (only for Withdrawal table)
- 2467: 
+ 2467:   IF TG_TABLE_NAME = 'Withdrawal' THEN
- 2468: 
+ 2468:     -- Withdrawal approved
- 2469: 
+ 2469:     IF NEW."status" = 'APPROVED' AND OLD."status" = 'PENDING' THEN
- 2470: 
+ 2470:       INSERT INTO "Notification" ("id", "userId", "title", "message", "type", "referenceId", "referenceType")
- 2471: 
+ 2471:       VALUES (
- 2472: 
+ 2472:         gen_random_uuid()::text,
- 2473: 
+ 2473:         NEW."userId",
- 2474: 
+ 2474:         'Withdrawal Approved',
- 2475: 
+ 2475:         'Your withdrawal request of ' || NEW."amount" || ' USDT has been approved!',
- 2476: 
+ 2476:         'SUCCESS',
- 2477: 
+ 2477:         NEW."id",
- 2478: 
+ 2478:         'WITHDRAWAL'
- 2479: 
+ 2479:       );
- 2480: 
+ 2480:     END IF;
- 2481: 
+ 2481:     
- 2482: 
+ 2482:     -- Withdrawal rejected
- 2483: 
+ 2483:     IF NEW."status" = 'REJECTED' AND OLD."status" = 'PENDING' THEN
- 2484: 
+ 2484:       INSERT INTO "Notification" ("id", "userId", "title", "message", "type", "referenceId", "referenceType")
- 2485: 
+ 2485:       VALUES (
- 2486: 
+ 2486:         gen_random_uuid()::text,
- 2487: 
+ 2487:         NEW."userId",
- 2488: 
+ 2488:         'Withdrawal Rejected',
- 2489: 
+ 2489:         'Your withdrawal request has been rejected. Reason: ' || COALESCE(NEW."rejectionReason", 'Not specified'),
- 2490: 
+ 2490:         'ERROR',
- 2491: 
+ 2491:         NEW."id",
- 2492: 
+ 2492:         'WITHDRAWAL'
- 2493: 
+ 2493:       );
- 2494: 
+ 2494:     END IF;
- 2495: 
+ 2495:   END IF;
- 2496: 
+ 2496:   
- 2497: 
+ 2497:   -- KYC approved (only for User table)
- 2498: 
+ 2498:   IF TG_TABLE_NAME = 'User' THEN
- 2499: 
+ 2499:     IF NEW."kycStatus" = 'APPROVED' AND OLD."kycStatus" != 'APPROVED' THEN
- 2500: 
+ 2500:       INSERT INTO "Notification" ("id", "userId", "title", "message", "type", "referenceType")
- 2501: 
+ 2501:       VALUES (
- 2502: 
+ 2502:         gen_random_uuid()::text,
- 2503: 
+ 2503:         NEW."id",
- 2504: 
+ 2504:         'KYC Approved',
- 2505: 
+ 2505:         'Your KYC verification has been approved!',
- 2506: 
+ 2506:         'SUCCESS',
- 2507: 
+ 2507:         'KYC'
- 2508: 
+ 2508:       );
- 2509: 
+ 2509:     END IF;
- 2510: 
+ 2510:   END IF;
- 2511: 
+ 2511:   
- 2512: 
+ 2512:   RETURN NEW;
- 2513: 
+ 2513: END;
- 2514: 
+ 2514: $$ LANGUAGE plpgsql;
- 2516: 
+ 2516: DROP TRIGGER IF EXISTS package_status_notification ON "Package";CREATE TRIGGER package_status_notification AFTER UPDATE ON "Package"
- 2517: 
+ 2517:   FOR EACH ROW EXECUTE FUNCTION create_event_notification();
- 2519: 
+ 2519: DROP TRIGGER IF EXISTS withdrawal_status_notification ON "Withdrawal";CREATE TRIGGER withdrawal_status_notification AFTER UPDATE ON "Withdrawal"
- 2520: 
+ 2520:   FOR EACH ROW EXECUTE FUNCTION create_event_notification();
- 2522: 
+ 2522: DROP TRIGGER IF EXISTS user_kyc_notification ON "User";CREATE TRIGGER user_kyc_notification AFTER UPDATE ON "User"
- 2523: 
+ 2523:   FOR EACH ROW EXECUTE FUNCTION create_event_notification();
- 2525: 
+ 2525: -- ----------------------------------------------------------------------------
- 2526: 
+ 2526: -- Trigger: Calculate referral earnings on package activation
- 2527: 
+ 2527: -- ----------------------------------------------------------------------------
- 2528: 
+ 2528: CREATE OR REPLACE FUNCTION process_referral_earnings()
- 2529: 
+ 2529: RETURNS TRIGGER AS $$
- 2530: 
+ 2530: DECLARE
- 2531: 
+ 2531:   earning_record RECORD;
- 2532: 
+ 2532:   transaction_id TEXT;
- 2533: 
+ 2533: BEGIN
- 2534: 
+ 2534:   -- Only process when package becomes ACTIVE
- 2535: 
+ 2535:   IF NEW."status" = 'ACTIVE' AND (OLD."status" IS NULL OR OLD."status" != 'ACTIVE') THEN
- 2536: 
+ 2536:     
- 2537: 
+ 2537:     -- Calculate and create earnings for referral chain
- 2538: 
+ 2538:     FOR earning_record IN 
- 2539: 
+ 2539:       SELECT * FROM calculate_referral_earnings(NEW."id", NEW."userId", NEW."amount")
- 2540: 
+ 2540:     LOOP
- 2541: 
+ 2541:       -- Create transaction record
- 2542: 
+ 2542:       transaction_id := gen_random_uuid()::text;
- 2543: 
+ 2543:       
- 2544: 
+ 2544:       INSERT INTO "Transaction" (
- 2545: 
+ 2545:         "id", "userId", "type", "amount", "status", "description",
- 2546: 
+ 2546:         "referenceId", "referenceType"
- 2547: 
+ 2547:       ) VALUES (
- 2548: 
+ 2548:         transaction_id,
- 2549: 
+ 2549:         earning_record."referrerId",
- 2550: 
+ 2550:         (CASE WHEN earning_record."level" = 1 THEN 'REFERRAL_BONUS' ELSE 'LEVEL_INCOME' END)::"TransactionType",
- 2551: 
+ 2551:         earning_record."amount",
- 2552: 
+ 2552:         'COMPLETED'::"TransactionStatus",
- 2553: 
+ 2553:         'Level ' || earning_record."level" || ' income from package purchase',
- 2554: 
+ 2554:         NEW."id",
- 2555: 
+ 2555:         'PACKAGE'
- 2556: 
+ 2556:       );
- 2557: 
+ 2557:       
- 2558: 
+ 2558:       -- Create earning record
- 2559: 
+ 2559:       INSERT INTO "Earning" (
- 2560: 
+ 2560:         "id", "userId", "fromUserId", "packageId", "transactionId",
- 2561: 
+ 2561:         "earningType", "amount", "level", "percentage", "status"
- 2562: 
+ 2562:       ) VALUES (
- 2563: 
+ 2563:         gen_random_uuid()::text,
- 2564: 
+ 2564:         earning_record."referrerId",
- 2565: 
+ 2565:         NEW."userId",
- 2566: 
+ 2566:         NEW."id",
- 2567: 
+ 2567:         transaction_id,
- 2568: 
+ 2568:         (CASE WHEN earning_record."level" = 1 THEN 'DIRECT_REFERRAL' ELSE 'LEVEL_INCOME' END)::"EarningType",
- 2569: 
+ 2569:         earning_record."amount",
- 2570: 
+ 2570:         earning_record."level",
- 2571: 
+ 2571:         earning_record."percentage",
- 2572: 
+ 2572:         'PAID'
- 2573: 
+ 2573:       );
- 2574: 
+ 2574:       
- 2575: 
+ 2575:       -- Create notification
- 2576: 
+ 2576:       INSERT INTO "Notification" (
- 2577: 
+ 2577:         "id", "userId", "title", "message", "type", "referenceId", "referenceType"
- 2578: 
+ 2578:       ) VALUES (
- 2579: 
+ 2579:         gen_random_uuid()::text,
- 2580: 
+ 2580:         earning_record."referrerId",
- 2581: 
+ 2581:         'Referral Earnings',
- 2582: 
+ 2582:         'You earned ' || earning_record."amount" || ' USDT from Level ' || earning_record."level" || ' referral income!',
- 2583: 
+ 2583:         'REFERRAL',
- 2584: 
+ 2584:         NEW."id",
- 2585: 
+ 2585:         'PACKAGE'
- 2586: 
+ 2586:       );
- 2587: 
+ 2587:     END LOOP;
- 2588: 
+ 2588:   END IF;
- 2589: 
+ 2589:   
- 2590: 
+ 2590:   RETURN NEW;
- 2591: 
+ 2591: END;
- 2592: 
+ 2592: $$ LANGUAGE plpgsql;
- 2594: 
+ 2594: DROP TRIGGER IF EXISTS package_referral_earnings ON "Package";CREATE TRIGGER package_referral_earnings AFTER INSERT OR UPDATE ON "Package"
- 2595: 
+ 2595:   FOR EACH ROW EXECUTE FUNCTION process_referral_earnings();
- 2597: 
+ 2597: -- ----------------------------------------------------------------------------
- 2598: 
+ 2598: -- Trigger: Update package ROI counters when ROI is paid
- 2599: 
+ 2599: -- ----------------------------------------------------------------------------
- 2600: 
+ 2600: CREATE OR REPLACE FUNCTION update_package_roi_stats()
- 2601: 
+ 2601: RETURNS TRIGGER AS $$
- 2602: 
+ 2602: BEGIN
- 2603: 
+ 2603:   IF TG_OP = 'INSERT' AND NEW."status" = 'COMPLETED' THEN
- 2604: 
+ 2604:     UPDATE "Package"
- 2605: 
+ 2605:     SET 
- 2606: 
+ 2606:       "totalRoiPaid" = "totalRoiPaid" + NEW."amount",
- 2607: 
+ 2607:       "roiPaidCount" = "roiPaidCount" + 1,
- 2608: 
+ 2608:       "lastRoiDate" = NEW."paymentDate",
- 2609: 
+ 2609:       "nextRoiDate" = NEW."paymentDate" + INTERVAL '1 month'
- 2610: 
+ 2610:     WHERE "id" = NEW."packageId";
- 2611: 
+ 2611:   END IF;
- 2612: 
+ 2612:   
- 2613: 
+ 2613:   RETURN NEW;
- 2614: 
+ 2614: END;
- 2615: 
+ 2615: $$ LANGUAGE plpgsql;
- 2617: 
+ 2617: DROP TRIGGER IF EXISTS roipayment_update_package ON "RoiPayment";CREATE TRIGGER roipayment_update_package AFTER INSERT ON "RoiPayment"
- 2618: 
+ 2618:   FOR EACH ROW EXECUTE FUNCTION update_package_roi_stats();
- 2620: 
+ 2620: -- ----------------------------------------------------------------------------
- 2621: 
+ 2621: -- Trigger: Log admin actions automatically
- 2622: 
+ 2622: -- ----------------------------------------------------------------------------
- 2623: 
+ 2623: CREATE OR REPLACE FUNCTION log_admin_action()
- 2624: 
+ 2624: RETURNS TRIGGER AS $$
- 2625: 
+ 2625: BEGIN
- 2626: 
+ 2626:   -- Log withdrawal approvals (only for Withdrawal table)
- 2627: 
+ 2627:   IF TG_TABLE_NAME = 'Withdrawal' THEN
- 2628: 
+ 2628:     IF NEW."approvedBy" IS NOT NULL AND (OLD."approvedBy" IS NULL OR OLD."approvedBy" IS DISTINCT FROM NEW."approvedBy") THEN
- 2629: 
+ 2629:       INSERT INTO "AdminLog" (
- 2630: 
+ 2630:         "id", "adminId", "action", "targetType", "targetId", "description"
- 2631: 
+ 2631:       ) VALUES (
- 2632: 
+ 2632:         gen_random_uuid()::text,
- 2633: 
+ 2633:         NEW."approvedBy",
- 2634: 
+ 2634:         'APPROVE_WITHDRAWAL',
- 2635: 
+ 2635:         'WITHDRAWAL',
- 2636: 
+ 2636:         NEW."id",
- 2637: 
+ 2637:         'Approved withdrawal of ' || NEW."amount" || ' USDT for user ' || NEW."userId"
- 2638: 
+ 2638:       );
- 2639: 
+ 2639:     END IF;
- 2640: 
+ 2640:     
- 2641: 
+ 2641:     -- Log withdrawal rejections
- 2642: 
+ 2642:     IF NEW."status" = 'REJECTED' AND OLD."status" != 'REJECTED' THEN
- 2643: 
+ 2643:       INSERT INTO "AdminLog" (
- 2644: 
+ 2644:         "id", "adminId", "action", "targetType", "targetId", "description"
- 2645: 
+ 2645:       ) VALUES (
- 2646: 
+ 2646:         gen_random_uuid()::text,
- 2647: 
+ 2647:         NEW."rejectedBy",
- 2648: 
+ 2648:         'REJECT_WITHDRAWAL',
- 2649: 
+ 2649:         'WITHDRAWAL',
- 2650: 
+ 2650:         NEW."id",
- 2651: 
+ 2651:         'Rejected withdrawal: ' || COALESCE(NEW."rejectionReason", 'No reason provided')
- 2652: 
+ 2652:       );
- 2653: 
+ 2653:     END IF;
- 2654: 
+ 2654:   END IF;
- 2655: 
+ 2655:   
- 2656: 
+ 2656:   -- Log user blocking (only for User table)
- 2657: 
+ 2657:   IF TG_TABLE_NAME = 'User' THEN
- 2658: 
+ 2658:     IF NEW."isBlocked" = true AND OLD."isBlocked" = false THEN
- 2659: 
+ 2659:       INSERT INTO "AdminLog" (
- 2660: 
+ 2660:         "id", "adminId", "action", "targetType", "targetId", "description"
- 2661: 
+ 2661:       ) VALUES (
- 2662: 
+ 2662:         gen_random_uuid()::text,
- 2663: 
+ 2663:         NEW."blockedBy",
- 2664: 
+ 2664:         'BLOCK_USER',
- 2665: 
+ 2665:         'USER',
- 2666: 
+ 2666:         NEW."id",
- 2667: 
+ 2667:         'Blocked user: ' || COALESCE(NEW."blockReason", 'No reason provided')
- 2668: 
+ 2668:       );
- 2669: 
+ 2669:     END IF;
- 2670: 
+ 2670:     
- 2671: 
+ 2671:     -- Log KYC approvals
- 2672: 
+ 2672:     IF NEW."kycStatus" = 'APPROVED' AND OLD."kycStatus" != 'APPROVED' THEN
- 2673: 
+ 2673:       INSERT INTO "AdminLog" (
- 2674: 
+ 2674:         "id", "adminId", "action", "targetType", "targetId", "description"
- 2675: 
+ 2675:       ) VALUES (
- 2676: 
+ 2676:         gen_random_uuid()::text,
- 2677: 
+ 2677:         'SYSTEM',
- 2678: 
+ 2678:         'APPROVE_KYC',
- 2679: 
+ 2679:         'USER',
- 2680: 
+ 2680:         NEW."id",
- 2681: 
+ 2681:         'Approved KYC verification'
- 2682: 
+ 2682:       );
- 2683: 
+ 2683:     END IF;
- 2684: 
+ 2684:   END IF;
- 2685: 
+ 2685:   
- 2686: 
+ 2686:   RETURN NEW;
- 2687: 
+ 2687: END;
- 2688: 
+ 2688: $$ LANGUAGE plpgsql;
- 2690: 
+ 2690: DROP TRIGGER IF EXISTS log_withdrawal_actions ON "Withdrawal";CREATE TRIGGER log_withdrawal_actions AFTER UPDATE ON "Withdrawal"
- 2691: 
+ 2691:   FOR EACH ROW EXECUTE FUNCTION log_admin_action();
- 2693: 
+ 2693: DROP TRIGGER IF EXISTS log_user_actions ON "User";CREATE TRIGGER log_user_actions AFTER UPDATE ON "User"
- 2694: 
+ 2694:   FOR EACH ROW EXECUTE FUNCTION log_admin_action();
- 2696: 
+ 2696: -- ----------------------------------------------------------------------------
- 2697: 
+ 2697: -- Trigger: Auto-expire sessions
- 2698: 
+ 2698: -- ----------------------------------------------------------------------------
- 2699: 
+ 2699: CREATE OR REPLACE FUNCTION auto_expire_sessions()
- 2700: 
+ 2700: RETURNS TRIGGER AS $$
- 2701: 
+ 2701: BEGIN
- 2702: 
+ 2702:   IF NEW."expiresAt" < NOW() AND NEW."isActive" = true THEN
- 2703: 
+ 2703:     NEW."isActive" = false;
- 2704: 
+ 2704:     NEW."status" = 'EXPIRED';
- 2705: 
+ 2705:   END IF;
- 2706: 
+ 2706:   RETURN NEW;
- 2707: 
+ 2707: END;
- 2708: 
+ 2708: $$ LANGUAGE plpgsql;
- 2710: 
+ 2710: DROP TRIGGER IF EXISTS session_auto_expire ON "Session";CREATE TRIGGER session_auto_expire BEFORE UPDATE ON "Session"
- 2711: 
+ 2711:   FOR EACH ROW EXECUTE FUNCTION auto_expire_sessions();
- 2713: 
+ 2713: -- ----------------------------------------------------------------------------
- 2714: 
+ 2714: -- Trigger: Validate withdrawal amount
- 2715: 
+ 2715: -- ----------------------------------------------------------------------------
- 2716: 
+ 2716: CREATE OR REPLACE FUNCTION validate_withdrawal_amount()
- 2717: 
+ 2717: RETURNS TRIGGER AS $$
- 2718: 
+ 2718: DECLARE
- 2719: 
+ 2719:   v_available DECIMAL(20, 8);
- 2720: 
+ 2720:   v_min_withdrawal DECIMAL(20, 8);
- 2721: 
+ 2721: BEGIN
- 2722: 
+ 2722:   -- Get available balance
- 2723: 
+ 2723:   SELECT "availableBalance" INTO v_available
- 2724: 
+ 2724:   FROM get_user_withdrawal_balance(NEW."userId");
- 2725: 
+ 2725:   
- 2726: 
+ 2726:   -- Get minimum withdrawal
- 2727: 
+ 2727:   SELECT COALESCE("value", '20')::DECIMAL INTO v_min_withdrawal
- 2728: 
+ 2728:   FROM "SystemSetting" WHERE "key" = 'MIN_WITHDRAWAL';
- 2729: 
+ 2729:   
- 2730: 
+ 2730:   -- Validate
- 2731: 
+ 2731:   IF NEW."amount" > v_available THEN
- 2732: 
+ 2732:     RAISE EXCEPTION 'Insufficient balance. Available: %, Requested: %', v_available, NEW."amount";
- 2733: 
+ 2733:   END IF;
- 2734: 
+ 2734:   
- 2735: 
+ 2735:   IF NEW."amount" < v_min_withdrawal THEN
- 2736: 
+ 2736:     RAISE EXCEPTION 'Amount below minimum withdrawal limit of %', v_min_withdrawal;
- 2737: 
+ 2737:   END IF;
- 2738: 
+ 2738:   
- 2739: 
+ 2739:   RETURN NEW;
- 2740: 
+ 2740: END;
- 2741: 
+ 2741: $$ LANGUAGE plpgsql;
- 2743: 
+ 2743: DROP TRIGGER IF EXISTS withdrawal_validate_amount ON "Withdrawal";CREATE TRIGGER withdrawal_validate_amount BEFORE INSERT ON "Withdrawal"
- 2744: 
+ 2744:   FOR EACH ROW EXECUTE FUNCTION validate_withdrawal_amount();
- 2746: 
+ 2746: -- ----------------------------------------------------------------------------
- 2747: 
+ 2747: -- Trigger: Calculate net amount for withdrawals
- 2748: 
+ 2748: -- ----------------------------------------------------------------------------
- 2749: 
+ 2749: CREATE OR REPLACE FUNCTION calculate_withdrawal_net_amount()
- 2750: 
+ 2750: RETURNS TRIGGER AS $$
- 2751: 
+ 2751: DECLARE
- 2752: 
+ 2752:   v_fee_percentage DECIMAL(5, 2);
- 2753: 
+ 2753: BEGIN
- 2754: 
+ 2754:   -- Get fee percentage from settings
- 2755: 
+ 2755:   SELECT COALESCE("value", '10')::DECIMAL INTO v_fee_percentage
- 2756: 
+ 2756:   FROM "SystemSetting" WHERE "key" = 'WITHDRAWAL_FEE';
- 2757: 
+ 2757:   
- 2758: 
+ 2758:   -- Calculate fee and net amount
- 2759: 
+ 2759:   IF NEW."fee" = 0 THEN
- 2760: 
+ 2760:     NEW."fee" = ROUND(NEW."amount" * v_fee_percentage / 100, 8);
- 2761: 
+ 2761:     NEW."feePercentage" = v_fee_percentage;
- 2762: 
+ 2762:   END IF;
- 2763: 
+ 2763:   
- 2764: 
+ 2764:   NEW."netAmount" = NEW."amount" - NEW."fee";
- 2765: 
+ 2765:   
- 2766: 
+ 2766:   RETURN NEW;
- 2767: 
+ 2767: END;
- 2768: 
+ 2768: $$ LANGUAGE plpgsql;
- 2770: 
+ 2770: DROP TRIGGER IF EXISTS withdrawal_calculate_net ON "Withdrawal";CREATE TRIGGER withdrawal_calculate_net BEFORE INSERT OR UPDATE ON "Withdrawal"
- 2771: 
+ 2771:   FOR EACH ROW EXECUTE FUNCTION calculate_withdrawal_net_amount();
- 2773: 
+ 2773: -- ----------------------------------------------------------------------------
- 2774: 
+ 2774: -- Trigger: Create transaction record when withdrawal is completed
- 2775: 
+ 2775: -- ----------------------------------------------------------------------------
- 2776: 
+ 2776: CREATE OR REPLACE FUNCTION create_withdrawal_transaction()
- 2777: 
+ 2777: RETURNS TRIGGER AS $$
- 2778: 
+ 2778: DECLARE
- 2779: 
+ 2779:   v_transaction_id TEXT;
- 2780: 
+ 2780: BEGIN
- 2781: 
+ 2781:   IF NEW."status" = 'COMPLETED' AND (OLD."status" IS NULL OR OLD."status" != 'COMPLETED') THEN
- 2782: 
+ 2782:     v_transaction_id := gen_random_uuid()::text;
- 2783: 
+ 2783:     
- 2784: 
+ 2784:     INSERT INTO "Transaction" (
- 2785: 
+ 2785:       "id", "userId", "type", "amount", "fee", "netAmount",
- 2786: 
+ 2786:       "status", "description", "txHash", "network",
- 2787: 
+ 2787:       "referenceId", "referenceType"
- 2788: 
+ 2788:     ) VALUES (
- 2789: 
+ 2789:       v_transaction_id,
- 2790: 
+ 2790:       NEW."userId",
- 2791: 
+ 2791:       'WITHDRAWAL'::"TransactionType",
- 2792: 
+ 2792:       NEW."amount",
- 2793: 
+ 2793:       NEW."fee",
- 2794: 
+ 2794:       NEW."netAmount",
- 2795: 
+ 2795:       'COMPLETED'::"TransactionStatus",
- 2796: 
+ 2796:       'Withdrawal to ' || NEW."walletAddress",
- 2797: 
+ 2797:       NEW."txHash",
- 2798: 
+ 2798:       NEW."network",
- 2799: 
+ 2799:       NEW."id",
- 2800: 
+ 2800:       'WITHDRAWAL'
- 2801: 
+ 2801:     );
- 2802: 
+ 2802:     
- 2803: 
+ 2803:     -- Link transaction to withdrawal
- 2804: 
+ 2804:     UPDATE "Withdrawal" SET "transactionId" = v_transaction_id WHERE "id" = NEW."id";
- 2805: 
+ 2805:   END IF;
- 2806: 
+ 2806:   
- 2807: 
+ 2807:   RETURN NEW;
- 2808: 
+ 2808: END;
- 2809: 
+ 2809: $$ LANGUAGE plpgsql;
- 2811: 
+ 2811: DROP TRIGGER IF EXISTS withdrawal_create_transaction ON "Withdrawal";CREATE TRIGGER withdrawal_create_transaction AFTER UPDATE ON "Withdrawal"
- 2812: 
+ 2812:   FOR EACH ROW EXECUTE FUNCTION create_withdrawal_transaction();
- 2814: 
+ 2814: -- ----------------------------------------------------------------------------
- 2815: 
+ 2815: -- Trigger: Auto-generate ticket number
- 2816: 
+ 2816: -- ----------------------------------------------------------------------------
- 2817: 
+ 2817: CREATE OR REPLACE FUNCTION generate_ticket_number()
- 2818: 
+ 2818: RETURNS TRIGGER AS $$
- 2819: 
+ 2819: BEGIN
- 2820: 
+ 2820:   IF NEW."ticketNumber" IS NULL THEN
- 2821: 
+ 2821:     NEW."ticketNumber" = 'TKT-' || TO_CHAR(NOW(), 'YYYYMMDD') || '-' || LPAD(NEXTVAL('ticket_sequence')::TEXT, 5, '0');
- 2822: 
+ 2822:   END IF;
- 2823: 
+ 2823:   RETURN NEW;
- 2824: 
+ 2824: END;
- 2825: 
+ 2825: $$ LANGUAGE plpgsql;
- 2827: 
+ 2827: -- Create sequence for ticket numbers
- 2828: 
+ 2828: CREATE SEQUENCE IF NOT EXISTS ticket_sequence START 1;
- 2830: 
+ 2830: DROP TRIGGER IF EXISTS supportticket_generate_number ON "SupportTicket";CREATE TRIGGER supportticket_generate_number BEFORE INSERT ON "SupportTicket"
- 2831: 
+ 2831:   FOR EACH ROW EXECUTE FUNCTION generate_ticket_number();
- 2833: 
+ 2833: -- ----------------------------------------------------------------------------
- 2834: 
+ 2834: -- Trigger: Update last activity timestamp
- 2835: 
+ 2835: -- ----------------------------------------------------------------------------
- 2836: 
+ 2836: CREATE OR REPLACE FUNCTION update_last_activity()
- 2837: 
+ 2837: RETURNS TRIGGER AS $$
- 2838: 
+ 2838: BEGIN
- 2839: 
+ 2839:   UPDATE "User" SET "lastActiveAt" = NOW() WHERE "id" = NEW."userId";
- 2840: 
+ 2840:   RETURN NEW;
- 2841: 
+ 2841: END;
- 2842: 
+ 2842: $$ LANGUAGE plpgsql;
- 2844: 
+ 2844: DROP TRIGGER IF EXISTS transaction_update_activity ON "Transaction";CREATE TRIGGER transaction_update_activity AFTER INSERT ON "Transaction"
- 2845: 
+ 2845:   FOR EACH ROW EXECUTE FUNCTION update_last_activity();
- 2847: 
+ 2847: DROP TRIGGER IF EXISTS withdrawal_update_activity ON "Withdrawal";CREATE TRIGGER withdrawal_update_activity AFTER INSERT ON "Withdrawal"
- 2848: 
+ 2848:   FOR EACH ROW EXECUTE FUNCTION update_last_activity();
- 2852: 
+ 2852: -- End included: 06_triggers.sql
- 2855: 
+ 2855: -- Begin included: 07_views.sql
- 2856: 
+ 2856: -- ============================================================================
- 2857: 
+ 2857: -- VIEWS - Database views for common queries
- 2858: 
+ 2858: -- ============================================================================
- 2860: 
+ 2860: -- ----------------------------------------------------------------------------
- 2861: 
+ 2861: -- View: User Balance Summary
- 2862: 
+ 2862: -- ----------------------------------------------------------------------------
- 2863: 
+ 2863: CREATE OR REPLACE VIEW "vw_UserBalanceSummary" AS
- 2864: 
+ 2864: SELECT
- 2865: 
+ 2865:   u."id" as "userId",
- 2866: 
+ 2866:   u."email",
- 2867: 
+ 2867:   u."referralCode",
- 2868: 
+ 2868:   
- 2869: 
+ 2869:   -- ROI Balance
- 2870: 
+ 2870:   COALESCE(SUM(CASE WHEN t."type" = 'ROI_PAYMENT' AND t."status" = 'COMPLETED' THEN t."amount" ELSE 0 END), 0) as "roiBalance",
- 2871: 
+ 2871:   
- 2872: 
+ 2872:   -- Referral Balance
- 2873: 
+ 2873:   COALESCE(SUM(CASE WHEN t."type" IN ('REFERRAL_BONUS', 'LEVEL_INCOME') AND t."status" = 'COMPLETED' THEN t."amount" ELSE 0 END), 0) as "referralBalance",
- 2874: 
+ 2874:   
- 2875: 
+ 2875:   -- Capital Returned
- 2876: 
+ 2876:   COALESCE(SUM(CASE WHEN t."type" = 'CAPITAL_RETURN' AND t."status" = 'COMPLETED' THEN t."amount" ELSE 0 END), 0) as "capitalReturned",
- 2877: 
+ 2877:   
- 2878: 
+ 2878:   -- Total Earned
- 2879: 
+ 2879:   COALESCE(SUM(CASE WHEN t."type" IN ('ROI_PAYMENT', 'REFERRAL_BONUS', 'LEVEL_INCOME', 'CAPITAL_RETURN') AND t."status" = 'COMPLETED' THEN t."amount" ELSE 0 END), 0) as "totalEarned",
- 2880: 
+ 2880:   
- 2881: 
+ 2881:   -- Total Withdrawn
- 2882: 
+ 2882:   COALESCE((SELECT SUM(w."amount") FROM "Withdrawal" w WHERE w."userId" = u."id" AND w."status" IN ('COMPLETED', 'APPROVED', 'PROCESSING')), 0) as "totalWithdrawn",
- 2883: 
+ 2883:   
- 2884: 
+ 2884:   -- Pending Withdrawals
- 2885: 
+ 2885:   COALESCE((SELECT SUM(w."amount") FROM "Withdrawal" w WHERE w."userId" = u."id" AND w."status" = 'PENDING'), 0) as "pendingWithdrawals",
- 2886: 
+ 2886:   
- 2887: 
+ 2887:   -- Available Balance
- 2888: 
+ 2888:   COALESCE(SUM(CASE WHEN t."type" IN ('ROI_PAYMENT', 'REFERRAL_BONUS', 'LEVEL_INCOME', 'CAPITAL_RETURN') AND t."status" = 'COMPLETED' THEN t."amount" ELSE 0 END), 0) -
- 2889: 
+ 2889:   COALESCE((SELECT SUM(w."amount") FROM "Withdrawal" w WHERE w."userId" = u."id" AND w."status" IN ('COMPLETED', 'APPROVED', 'PROCESSING', 'PENDING')), 0) as "availableBalance",
- 2890: 
+ 2890:   
- 2891: 
+ 2891:   -- Investment Summary
- 2892: 
+ 2892:   COALESCE((SELECT SUM(p."amount") FROM "Package" p WHERE p."userId" = u."id" AND p."status" IN ('ACTIVE', 'EXPIRED', 'COMPLETED')), 0) as "totalInvested",
- 2893: 
+ 2893:   COALESCE((SELECT COUNT(*) FROM "Package" p WHERE p."userId" = u."id" AND p."status" = 'ACTIVE'), 0) as "activePackages"
- 2894: 
+ 2894:   
- 2895: 
+ 2895: FROM "User" u
- 2896: 
+ 2896: LEFT JOIN "Transaction" t ON t."userId" = u."id"
- 2897: 
+ 2897: GROUP BY u."id", u."email", u."referralCode";
- 2899: 
+ 2899: -- ----------------------------------------------------------------------------
- 2900: 
+ 2900: -- View: Active Packages with ROI Info
- 2901: 
+ 2901: -- ----------------------------------------------------------------------------
- 2902: 
+ 2902: CREATE OR REPLACE VIEW "vw_ActivePackages" AS
- 2903: 
+ 2903: SELECT
- 2904: 
+ 2904:   p."id",
- 2905: 
+ 2905:   p."userId",
- 2906: 
+ 2906:   u."email",
- 2907: 
+ 2907:   u."fullName",
- 2908: 
+ 2908:   p."amount",
- 2909: 
+ 2909:   p."packageType",
- 2910: 
+ 2910:   p."roiPercentage" as "maxRoiPercentage",
- 2911: 
+ 2911:   p."status",
- 2912: 
+ 2912:   p."investmentDate",
- 2913: 
+ 2913:   p."expiryDate",
- 2914: 
+ 2914:   p."nextRoiDate",
- 2915: 
+ 2915:   p."roiPaidCount",
- 2916: 
+ 2916:   p."totalRoiPaid",
- 2917: 
+ 2917:   12 - p."roiPaidCount" as "remainingPayments",
- 2918: 
+ 2918:   p."createdAt"
- 2919: 
+ 2919: FROM "Package" p
- 2920: 
+ 2920: INNER JOIN "User" u ON u."id" = p."userId"
- 2921: 
+ 2921: WHERE p."status" = 'ACTIVE';
- 2923: 
+ 2923: -- ----------------------------------------------------------------------------
- 2924: 
+ 2924: -- View: Pending Withdrawals with User Info
- 2925: 
+ 2925: -- ----------------------------------------------------------------------------
- 2926: 
+ 2926: CREATE OR REPLACE VIEW "vw_PendingWithdrawals" AS
- 2927: 
+ 2927: SELECT
- 2928: 
+ 2928:   w."id",
- 2929: 
+ 2929:   w."userId",
- 2930: 
+ 2930:   u."email",
- 2931: 
+ 2931:   u."fullName",
- 2932: 
+ 2932:   u."kycStatus",
- 2933: 
+ 2933:   w."amount",
- 2934: 
+ 2934:   w."fee",
- 2935: 
+ 2935:   w."netAmount",
- 2936: 
+ 2936:   w."type",
- 2937: 
+ 2937:   w."walletAddress",
- 2938: 
+ 2938:   w."network",
- 2939: 
+ 2939:   w."status",
- 2940: 
+ 2940:   w."requestDate",
- 2941: 
+ 2941:   w."userNote",
- 2942: 
+ 2942:   EXTRACT(DAY FROM NOW() - w."requestDate") as "daysPending"
- 2943: 
+ 2943: FROM "Withdrawal" w
- 2944: 
+ 2944: INNER JOIN "User" u ON u."id" = w."userId"
- 2945: 
+ 2945: WHERE w."status" = 'PENDING'
- 2946: 
+ 2946: ORDER BY w."requestDate" ASC;
- 2948: 
+ 2948: -- ----------------------------------------------------------------------------
- 2949: 
+ 2949: -- View: User Referral Statistics
- 2950: 
+ 2950: -- ----------------------------------------------------------------------------
- 2951: 
+ 2951: CREATE OR REPLACE VIEW "vw_UserReferralStats" AS
- 2952: 
+ 2952: SELECT
- 2953: 
+ 2953:   u."id" as "userId",
- 2954: 
+ 2954:   u."email",
- 2955: 
+ 2955:   u."referralCode",
- 2956: 
+ 2956:   
- 2957: 
+ 2957:   -- Direct Referrals (Level 1)
- 2958: 
+ 2958:   (SELECT COUNT(*) FROM "User" r WHERE r."referredBy" = u."referralCode") as "directReferrals",
- 2959: 
+ 2959:   
- 2960: 
+ 2960:   -- Total Team Size (all levels)
- 2961: 
+ 2961:   (SELECT COUNT(*) FROM get_referral_tree(u."referralCode", 6)) as "totalTeamSize",
- 2962: 
+ 2962:   
- 2963: 
+ 2963:   -- Direct Referral Earnings
- 2964: 
+ 2964:   COALESCE((SELECT SUM(e."amount") FROM "Earning" e WHERE e."userId" = u."id" AND e."earningType" = 'DIRECT_REFERRAL'::"EarningType"), 0) as "directReferralEarnings",
- 2965: 
+ 2965:   
- 2966: 
+ 2966:   -- Level Income Earnings
- 2967: 
+ 2967:   COALESCE((SELECT SUM(e."amount") FROM "Earning" e WHERE e."userId" = u."id" AND e."earningType" = 'LEVEL_INCOME'::"EarningType"), 0) as "levelIncomeEarnings",
- 2968: 
+ 2968:   
- 2969: 
+ 2969:   -- Total Referral Earnings
- 2970: 
+ 2970:   COALESCE((SELECT SUM(e."amount") FROM "Earning" e WHERE e."userId" = u."id" AND e."earningType" IN ('DIRECT_REFERRAL'::"EarningType", 'LEVEL_INCOME'::"EarningType")), 0) as "totalReferralEarnings",
- 2971: 
+ 2971:   
- 2972: 
+ 2972:   -- Active Referrals
- 2973: 
+ 2973:   (SELECT COUNT(DISTINCT p."userId") FROM "Package" p 
- 2974: 
+ 2974:    INNER JOIN "User" r ON r."id" = p."userId" 
- 2975: 
+ 2975:    WHERE r."referredBy" = u."referralCode" AND p."status" = 'ACTIVE') as "activeReferrals"
- 2976: 
+ 2976:   
- 2977: 
+ 2977: FROM "User" u;
- 2979: 
+ 2979: -- ----------------------------------------------------------------------------
- 2980: 
+ 2980: -- View: Platform Statistics Dashboard
- 2981: 
+ 2981: -- ----------------------------------------------------------------------------
- 2982: 
+ 2982: CREATE OR REPLACE VIEW "vw_PlatformStatistics" AS
- 2983: 
+ 2983: SELECT
- 2984: 
+ 2984:   -- User Statistics
- 2985: 
+ 2985:   (SELECT COUNT(*) FROM "User" WHERE "isActive" = true) as "totalUsers",
- 2986: 
+ 2986:   (SELECT COUNT(*) FROM "User" WHERE "isActive" = true AND "createdAt" >= NOW() - INTERVAL '30 days') as "newUsersThisMonth",
- 2987: 
+ 2987:   (SELECT COUNT(*) FROM "User" WHERE "lastLogin" >= NOW() - INTERVAL '7 days') as "activeUsersWeek",
- 2988: 
+ 2988:   (SELECT COUNT(*) FROM "User" WHERE "kycStatus" = 'APPROVED') as "verifiedUsers",
- 2989: 
+ 2989:   
- 2990: 
+ 2990:   -- Package Statistics
- 2991: 
+ 2991:   (SELECT COUNT(*) FROM "Package") as "totalPackages",
- 2992: 
+ 2992:   (SELECT COUNT(*) FROM "Package" WHERE "status" = 'ACTIVE') as "activePackages",
- 2993: 
+ 2993:   (SELECT COUNT(*) FROM "Package" WHERE "status" = 'EXPIRED') as "expiredPackages",
- 2994: 
+ 2994:   (SELECT COALESCE(SUM("amount"), 0) FROM "Package" WHERE "status" IN ('ACTIVE', 'EXPIRED', 'COMPLETED')) as "totalInvested",
- 2995: 
+ 2995:   
- 2996: 
+ 2996:   -- Financial Statistics
- 2997: 
+ 2997:   (SELECT COALESCE(SUM("amount"), 0) FROM "RoiPayment" WHERE "status" = 'COMPLETED') as "totalRoiPaid",
- 2998: 
+ 2998:   (SELECT COALESCE(SUM("amount"), 0) FROM "Earning") as "totalReferralPaid",
- 2999: 
+ 2999:   (SELECT COALESCE(SUM("amount"), 0) FROM "Withdrawal" WHERE "status" = 'COMPLETED') as "totalWithdrawals",
- 3000: 
+ 3000:   (SELECT COALESCE(SUM("amount"), 0) FROM "Withdrawal" WHERE "status" = 'PENDING') as "pendingWithdrawalAmount",
- 3001: 
+ 3001:   (SELECT COUNT(*) FROM "Withdrawal" WHERE "status" = 'PENDING') as "pendingWithdrawalCount",
- 3002: 
+ 3002:   
- 3003: 
+ 3003:   -- Bot Statistics
- 3004: 
+ 3004:   (SELECT COUNT(*) FROM "BotActivation" WHERE "status" = 'ACTIVE') as "activeBots",
- 3005: 
+ 3005:   (SELECT COUNT(*) FROM "BotActivation" WHERE "isExpired" = true) as "expiredBots",
- 3006: 
+ 3006:   
- 3007: 
+ 3007:   -- Today's Activity
- 3008: 
+ 3008:   (SELECT COUNT(*) FROM "User" WHERE "createdAt" >= CURRENT_DATE) as "newUsersToday",
- 3009: 
+ 3009:   (SELECT COUNT(*) FROM "Package" WHERE "createdAt" >= CURRENT_DATE) as "newPackagesToday",
- 3010: 
+ 3010:   (SELECT COALESCE(SUM("amount"), 0) FROM "Withdrawal" WHERE "createdAt" >= CURRENT_DATE) as "withdrawalRequestsToday";
- 3012: 
+ 3012: -- ----------------------------------------------------------------------------
- 3013: 
+ 3013: -- View: ROI Payment Schedule Overview
- 3014: 
+ 3014: -- ----------------------------------------------------------------------------
- 3015: 
+ 3015: CREATE OR REPLACE VIEW "vw_RoiPaymentSchedule" AS
- 3016: 
+ 3016: SELECT
- 3017: 
+ 3017:   p."id" as "packageId",
- 3018: 
+ 3018:   p."userId",
- 3019: 
+ 3019:   u."email",
- 3020: 
+ 3020:   p."packageType",
- 3021: 
+ 3021:   p."amount",
- 3022: 
+ 3022:   p."roiPercentage" as "maxRoiPercentage",
- 3023: 
+ 3023:   p."investmentDate",
- 3024: 
+ 3024:   p."roiPaidCount",
- 3025: 
+ 3025:   
- 3026: 
+ 3026:   -- Next payment details
- 3027: 
+ 3027:   p."nextRoiDate",
- 3028: 
+ 3028:   CASE 
- 3029: 
+ 3029:     WHEN p."nextRoiDate" < NOW() THEN 'OVERDUE'
- 3030: 
+ 3030:     WHEN p."nextRoiDate" < NOW() + INTERVAL '3 days' THEN 'DUE_SOON'
- 3031: 
+ 3031:     ELSE 'SCHEDULED'
- 3032: 
+ 3032:   END as "nextPaymentStatus",
- 3033: 
+ 3033:   
- 3034: 
+ 3034:   -- Completion tracking
- 3035: 
+ 3035:   ROUND((p."roiPaidCount"::DECIMAL / 12) * 100, 2) as "completionPercentage",
- 3036: 
+ 3036:   12 - p."roiPaidCount" as "paymentsRemaining"
- 3037: 
+ 3037:   
- 3038: 
+ 3038: FROM "Package" p
- 3039: 
+ 3039: INNER JOIN "User" u ON u."id" = p."userId"
- 3040: 
+ 3040: WHERE p."status" = 'ACTIVE' AND p."isExpired" = false;
- 3042: 
+ 3042: -- ----------------------------------------------------------------------------
- 3043: 
+ 3043: -- View: User Activity Log
- 3044: 
+ 3044: -- ----------------------------------------------------------------------------
- 3045: 
+ 3045: CREATE OR REPLACE VIEW "vw_UserActivityLog" AS
- 3046: 
+ 3046: SELECT
- 3047: 
+ 3047:   u."id" as "userId",
- 3048: 
+ 3048:   u."email",
- 3049: 
+ 3049:   u."lastLogin",
- 3050: 
+ 3050:   u."lastActiveAt",
- 3051: 
+ 3051:   u."createdAt" as "registrationDate",
- 3052: 
+ 3052:   
- 3053: 
+ 3053:   -- Activity counts
- 3054: 
+ 3054:   (SELECT COUNT(*) FROM "Transaction" t WHERE t."userId" = u."id") as "totalTransactions",
- 3055: 
+ 3055:   (SELECT COUNT(*) FROM "Package" p WHERE p."userId" = u."id") as "totalPackages",
- 3056: 
+ 3056:   (SELECT COUNT(*) FROM "Withdrawal" w WHERE w."userId" = u."id") as "totalWithdrawals",
- 3057: 
+ 3057:   (SELECT COUNT(*) FROM "LoginAttempt" la WHERE la."email" = u."email" AND la."success" = true) as "loginCount",
- 3058: 
+ 3058:   
- 3059: 
+ 3059:   -- Last activities
- 3060: 
+ 3060:   (SELECT MAX(t."createdAt") FROM "Transaction" t WHERE t."userId" = u."id") as "lastTransaction",
- 3061: 
+ 3061:   (SELECT MAX(w."createdAt") FROM "Withdrawal" w WHERE w."userId" = u."id") as "lastWithdrawal",
- 3062: 
+ 3062:   (SELECT MAX(p."createdAt") FROM "Package" p WHERE p."userId" = u."id") as "lastPackagePurchase"
- 3063: 
+ 3063:   
- 3064: 
+ 3064: FROM "User" u;
- 3066: 
+ 3066: -- ----------------------------------------------------------------------------
- 3067: 
+ 3067: -- View: Package Performance Analysis
- 3068: 
+ 3068: -- ----------------------------------------------------------------------------
- 3069: 
+ 3069: CREATE OR REPLACE VIEW "vw_PackagePerformance" AS
- 3070: 
+ 3070: SELECT
- 3071: 
+ 3071:   p."packageType",
- 3072: 
+ 3072:   COUNT(*) as "totalPackages",
- 3073: 
+ 3073:   COUNT(CASE WHEN p."status" = 'ACTIVE' THEN 1 END) as "activePackages",
- 3074: 
+ 3074:   COUNT(CASE WHEN p."status" = 'EXPIRED' THEN 1 END) as "expiredPackages",
- 3075: 
+ 3075:   COALESCE(SUM(p."amount"), 0) as "totalInvestment",
- 3076: 
+ 3076:   COALESCE(AVG(p."amount"), 0) as "averageInvestment",
- 3077: 
+ 3077:   COALESCE(SUM(p."totalRoiPaid"), 0) as "totalRoiPaid",
- 3078: 
+ 3078:   COALESCE(AVG(p."roiPaidCount"), 0) as "averagePaymentsMade"
- 3079: 
+ 3079: FROM "Package" p
- 3080: 
+ 3080: WHERE p."status" IN ('ACTIVE', 'EXPIRED', 'COMPLETED')
- 3081: 
+ 3081: GROUP BY p."packageType";
- 3083: 
+ 3083: -- ----------------------------------------------------------------------------
- 3084: 
+ 3084: -- View: Admin Dashboard Quick Stats
- 3085: 
+ 3085: -- ----------------------------------------------------------------------------
- 3086: 
+ 3086: CREATE OR REPLACE VIEW "vw_AdminQuickStats" AS
- 3087: 
+ 3087: SELECT
- 3088: 
+ 3088:   -- Pending Actions
- 3089: 
+ 3089:   (SELECT COUNT(*) FROM "Withdrawal" WHERE "status" = 'PENDING') as "pendingWithdrawals",
- 3090: 
+ 3090:   (SELECT COUNT(*) FROM "KYCSubmission" WHERE "status" = 'PENDING') as "pendingKyc",
- 3091: 
+ 3091:   (SELECT COUNT(*) FROM "SupportTicket" WHERE "status" IN ('OPEN', 'IN_PROGRESS')) as "openTickets",
- 3092: 
+ 3092:   (SELECT COUNT(*) FROM "Package" WHERE "status" = 'PENDING') as "pendingPackages",
- 3093: 
+ 3093:   
- 3094: 
+ 3094:   -- Today's Stats
- 3095: 
+ 3095:   (SELECT COUNT(*) FROM "User" WHERE DATE("createdAt") = CURRENT_DATE) as "newUsersToday",
- 3096: 
+ 3096:   (SELECT COUNT(*) FROM "Package" WHERE DATE("createdAt") = CURRENT_DATE) as "newPackagesToday",
- 3097: 
+ 3097:   (SELECT COALESCE(SUM("amount"), 0) FROM "Transaction" WHERE DATE("createdAt") = CURRENT_DATE AND "type" = 'DEPOSIT') as "depositsToday",
- 3098: 
+ 3098:   (SELECT COALESCE(SUM("amount"), 0) FROM "Withdrawal" WHERE DATE("completedAt") = CURRENT_DATE AND "status" = 'COMPLETED') as "withdrawalsToday",
- 3099: 
+ 3099:   
- 3100: 
+ 3100:   -- This Month
- 3101: 
+ 3101:   (SELECT COUNT(*) FROM "User" WHERE DATE_TRUNC('month', "createdAt") = DATE_TRUNC('month', CURRENT_DATE)) as "newUsersThisMonth",
- 3102: 
+ 3102:   (SELECT COALESCE(SUM("amount"), 0) FROM "Package" WHERE DATE_TRUNC('month', "createdAt") = DATE_TRUNC('month', CURRENT_DATE)) as "investmentThisMonth",
- 3103: 
+ 3103:   
- 3104: 
+ 3104:   -- System Health
- 3105: 
+ 3105:   (SELECT COUNT(*) FROM "ErrorLog" WHERE "createdAt" >= NOW() - INTERVAL '24 hours' AND "resolved" = false) as "unresolvedErrors24h",
- 3106: 
+ 3106:   (SELECT COUNT(*) FROM "LoginAttempt" WHERE "createdAt" >= NOW() - INTERVAL '1 hour' AND "success" = false) as "failedLoginsLastHour";
- 3108: 
+ 3108: -- ----------------------------------------------------------------------------
- 3109: 
+ 3109: -- View: Monthly Revenue Report
- 3110: 
+ 3110: -- ----------------------------------------------------------------------------
- 3111: 
+ 3111: CREATE OR REPLACE VIEW "vw_MonthlyRevenue" AS
- 3112: 
+ 3112: SELECT
- 3113: 
+ 3113:   DATE_TRUNC('month', t."createdAt") as "month",
- 3114: 
+ 3114:   
- 3115: 
+ 3115:   -- Package Purchases
- 3116: 
+ 3116:   COALESCE(SUM(CASE WHEN t."type" = 'PACKAGE_PURCHASE' THEN t."amount" ELSE 0 END), 0) as "packageRevenue",
- 3117: 
+ 3117:   
- 3118: 
+ 3118:   -- Bot Activation Fees
- 3119: 
+ 3119:   COALESCE(SUM(CASE WHEN t."type" = 'BOT_ACTIVATION' THEN t."amount" ELSE 0 END), 0) as "botFeeRevenue",
- 3120: 
+ 3120:   
- 3121: 
+ 3121:   -- Withdrawal Fees
- 3122: 
+ 3122:   COALESCE(SUM(CASE WHEN t."type" = 'WITHDRAWAL' THEN t."fee" ELSE 0 END), 0) as "withdrawalFeeRevenue",
- 3123: 
+ 3123:   
- 3124: 
+ 3124:   -- Total Revenue
- 3125: 
+ 3125:   COALESCE(SUM(CASE WHEN t."type" IN ('PACKAGE_PURCHASE', 'BOT_ACTIVATION') THEN t."amount" ELSE 0 END), 0) +
- 3126: 
+ 3126:   COALESCE(SUM(CASE WHEN t."type" = 'WITHDRAWAL' THEN t."fee" ELSE 0 END), 0) as "totalRevenue",
- 3127: 
+ 3127:   
- 3128: 
+ 3128:   -- Counts
- 3129: 
+ 3129:   COUNT(DISTINCT CASE WHEN t."type" = 'PACKAGE_PURCHASE' THEN t."userId" END) as "uniqueInvestors",
- 3130: 
+ 3130:   COUNT(CASE WHEN t."type" = 'PACKAGE_PURCHASE' THEN 1 END) as "packageCount"
- 3131: 
+ 3131:   
- 3132: 
+ 3132: FROM "Transaction" t
- 3133: 
+ 3133: WHERE t."status" = 'COMPLETED'
- 3134: 
+ 3134: GROUP BY DATE_TRUNC('month', t."createdAt")
- 3135: 
+ 3135: ORDER BY "month" DESC;
- 3137: 
+ 3137: -- ----------------------------------------------------------------------------
- 3138: 
+ 3138: -- Materialized View: User Earnings Summary (for performance)
- 3139: 
+ 3139: -- ----------------------------------------------------------------------------
- 3140: 
+ 3140: CREATE MATERIALIZED VIEW IF NOT EXISTS "mv_UserEarningsSummary" AS
- 3141: 
+ 3141: SELECT
- 3142: 
+ 3142:   u."id" as "userId",
- 3143: 
+ 3143:   u."email",
- 3144: 
+ 3144:   u."referralCode",
- 3145: 
+ 3145:   
- 3146: 
+ 3146:   -- ROI Earnings
- 3147: 
+ 3147:   COALESCE((SELECT SUM(rp."amount") FROM "RoiPayment" rp WHERE rp."userId" = u."id" AND rp."status" = 'COMPLETED'), 0) as "totalRoiEarnings",
- 3148: 
+ 3148:   
- 3149: 
+ 3149:   -- Referral Earnings
- 3150: 
+ 3150:   COALESCE((SELECT SUM(e."amount") FROM "Earning" e WHERE e."userId" = u."id" AND e."earningType" = 'DIRECT_REFERRAL'::"EarningType"), 0) as "totalDirectReferralEarnings",
- 3151: 
+ 3151:   COALESCE((SELECT SUM(e."amount") FROM "Earning" e WHERE e."userId" = u."id" AND e."earningType" = 'LEVEL_INCOME'::"EarningType"), 0) as "totalLevelIncomeEarnings",
- 3152: 
+ 3152:   
- 3153: 
+ 3153:   -- Total
- 3154: 
+ 3154:   COALESCE((SELECT SUM(rp."amount") FROM "RoiPayment" rp WHERE rp."userId" = u."id" AND rp."status" = 'COMPLETED'), 0) +
- 3155: 
+ 3155:   COALESCE((SELECT SUM(e."amount") FROM "Earning" e WHERE e."userId" = u."id"), 0) as "totalEarnings",
- 3156: 
+ 3156:   
- 3157: 
+ 3157:   -- Investment
- 3158: 
+ 3158:   COALESCE((SELECT SUM(p."amount") FROM "Package" p WHERE p."userId" = u."id" AND p."status" IN ('ACTIVE', 'EXPIRED', 'COMPLETED')), 0) as "totalInvested",
- 3159: 
+ 3159:   
- 3160: 
+ 3160:   -- Withdrawals
- 3161: 
+ 3161:   COALESCE((SELECT SUM(w."amount") FROM "Withdrawal" w WHERE w."userId" = u."id" AND w."status" = 'COMPLETED'), 0) as "totalWithdrawn",
- 3162: 
+ 3162:   
- 3163: 
+ 3163:   NOW() as "lastUpdated"
- 3164: 
+ 3164: FROM "User" u
- 3165: 
+ 3165: WHERE u."isActive" = true;
- 3167: 
+ 3167: CREATE UNIQUE INDEX ON "mv_UserEarningsSummary" ("userId");
- 3169: 
+ 3169: -- Refresh function for materialized view
- 3170: 
+ 3170: CREATE OR REPLACE FUNCTION refresh_user_earnings_summary()
- 3171: 
+ 3171: RETURNS void AS $$
- 3172: 
+ 3172: BEGIN
- 3173: 
+ 3173:   REFRESH MATERIALIZED VIEW CONCURRENTLY "mv_UserEarningsSummary";
- 3174: 
+ 3174: END;
- 3175: 
+ 3175: $$ LANGUAGE plpgsql;
- 3178: 
+ 3178: -- End included: 07_views.sql
- 3181: 
+ 3181: -- Begin included: 08_initial_data.sql
- 3182: 
+ 3182: -- ============================================================================
- 3183: 
+ 3183: -- INITIAL DATA - Seed data for system configuration
- 3184: 
+ 3184: -- ============================================================================
- 3186: 
+ 3186: -- ----------------------------------------------------------------------------
- 3187: 
+ 3187: -- System Settings - Platform Configuration
- 3188: 
+ 3188: -- ----------------------------------------------------------------------------
- 3189: 
+ 3189: INSERT INTO "SystemSetting" ("id", "key", "value", "description", "type", "category") VALUES
- 3190: 
+ 3190:   -- Financial Settings
- 3191: 
+ 3191:   (gen_random_uuid()::text, 'MIN_WITHDRAWAL', '20', 'Minimum withdrawal amount in USDT', 'NUMBER', 'FINANCIAL'),
- 3192: 
+ 3192:   (gen_random_uuid()::text, 'MAX_WITHDRAWAL', '10000', 'Maximum withdrawal amount in USDT', 'NUMBER', 'FINANCIAL'),
- 3193: 
+ 3193:   (gen_random_uuid()::text, 'WITHDRAWAL_FEE', '10', 'Withdrawal fee percentage', 'NUMBER', 'FINANCIAL'),
- 3194: 
+ 3194:   (gen_random_uuid()::text, 'WITHDRAWAL_COOLDOWN', '30', 'Days between withdrawals', 'NUMBER', 'FINANCIAL'),
- 3195: 
+ 3195:   
- 3196: 
+ 3196:   -- Referral Commission Rates
- 3197: 
+ 3197:   (gen_random_uuid()::text, 'DIRECT_REFERRAL_BONUS', '2', 'Direct referral bonus percentage', 'NUMBER', 'REFERRAL'),
- 3198: 
+ 3198:   (gen_random_uuid()::text, 'LEVEL_1_INCOME', '1', 'Level 1 income percentage', 'NUMBER', 'REFERRAL'),
- 3199: 
+ 3199:   (gen_random_uuid()::text, 'LEVEL_2_INCOME', '0.5', 'Level 2 income percentage', 'NUMBER', 'REFERRAL'),
- 3200: 
+ 3200:   (gen_random_uuid()::text, 'LEVEL_3_INCOME', '0.3', 'Level 3 income percentage', 'NUMBER', 'REFERRAL'),
- 3201: 
+ 3201:   (gen_random_uuid()::text, 'LEVEL_4_INCOME', '0.2', 'Level 4 income percentage', 'NUMBER', 'REFERRAL'),
- 3202: 
+ 3202:   (gen_random_uuid()::text, 'LEVEL_5_INCOME', '0.1', 'Level 5 income percentage', 'NUMBER', 'REFERRAL'),
- 3203: 
+ 3203:   (gen_random_uuid()::text, 'LEVEL_6_INCOME', '0.05', 'Level 6 income percentage', 'NUMBER', 'REFERRAL'),
- 3204: 
+ 3204:   
- 3205: 
+ 3205:   -- Package Settings
- 3206: 
+ 3206:   (gen_random_uuid()::text, 'MIN_PACKAGE_AMOUNT', '100', 'Minimum package investment amount', 'NUMBER', 'PACKAGE'),
- 3207: 
+ 3207:   (gen_random_uuid()::text, 'MAX_PACKAGE_AMOUNT', '100000', 'Maximum package investment amount', 'NUMBER', 'PACKAGE'),
- 3208: 
+ 3208:   (gen_random_uuid()::text, 'MAX_PACKAGE_COUNT', '1', 'Maximum active packages per user', 'NUMBER', 'PACKAGE'),
- 3209: 
+ 3209:   (gen_random_uuid()::text, 'PACKAGE_DURATION_MONTHS', '12', 'Package duration in months', 'NUMBER', 'PACKAGE'),
- 3210: 
+ 3210:   
- 3211: 
+ 3211:   -- Package Types - NEO
- 3212: 
+ 3212:   (gen_random_uuid()::text, 'NEO_MIN_AMOUNT', '100', 'NEO package minimum amount', 'NUMBER', 'PACKAGE'),
- 3213: 
+ 3213:   (gen_random_uuid()::text, 'NEO_MAX_AMOUNT', '999', 'NEO package maximum amount', 'NUMBER', 'PACKAGE'),
- 3214: 
+ 3214:   (gen_random_uuid()::text, 'NEO_ROI_PERCENTAGE', '3', 'NEO monthly ROI percentage', 'NUMBER', 'PACKAGE'),
- 3215: 
+ 3215:   (gen_random_uuid()::text, 'NEO_BOT_FEE', '10', 'NEO bot activation fee', 'NUMBER', 'PACKAGE'),
- 3216: 
+ 3216:   
- 3217: 
+ 3217:   -- Package Types - NEURAL
- 3218: 
+ 3218:   (gen_random_uuid()::text, 'NEURAL_MIN_AMOUNT', '1000', 'NEURAL package minimum amount', 'NUMBER', 'PACKAGE'),
- 3219: 
+ 3219:   (gen_random_uuid()::text, 'NEURAL_MAX_AMOUNT', '4999', 'NEURAL package maximum amount', 'NUMBER', 'PACKAGE'),
- 3220: 
+ 3220:   (gen_random_uuid()::text, 'NEURAL_ROI_PERCENTAGE', '4', 'NEURAL monthly ROI percentage', 'NUMBER', 'PACKAGE'),
- 3221: 
+ 3221:   (gen_random_uuid()::text, 'NEURAL_BOT_FEE', '50', 'NEURAL bot activation fee', 'NUMBER', 'PACKAGE'),
- 3222: 
+ 3222:   
- 3223: 
+ 3223:   -- Package Types - ORACLE
- 3224: 
+ 3224:   (gen_random_uuid()::text, 'ORACLE_MIN_AMOUNT', '5000', 'ORACLE package minimum amount', 'NUMBER', 'PACKAGE'),
- 3225: 
+ 3225:   (gen_random_uuid()::text, 'ORACLE_MAX_AMOUNT', '100000', 'ORACLE package maximum amount', 'NUMBER', 'PACKAGE'),
- 3226: 
+ 3226:   (gen_random_uuid()::text, 'ORACLE_ROI_PERCENTAGE', '5', 'ORACLE monthly ROI percentage', 'NUMBER', 'PACKAGE'),
- 3227: 
+ 3227:   (gen_random_uuid()::text, 'ORACLE_BOT_FEE', '100', 'ORACLE bot activation fee', 'NUMBER', 'PACKAGE'),
- 3228: 
+ 3228:   
- 3229: 
+ 3229:   -- Security Settings
- 3230: 
+ 3230:   (gen_random_uuid()::text, 'MAX_LOGIN_ATTEMPTS', '5', 'Maximum failed login attempts before lock', 'NUMBER', 'SECURITY'),
- 3231: 
+ 3231:   (gen_random_uuid()::text, 'LOGIN_LOCK_DURATION', '15', 'Account lock duration in minutes', 'NUMBER', 'SECURITY'),
- 3232: 
+ 3232:   (gen_random_uuid()::text, 'PASSWORD_MIN_LENGTH', '8', 'Minimum password length', 'NUMBER', 'SECURITY'),
- 3233: 
+ 3233:   (gen_random_uuid()::text, 'SESSION_TIMEOUT', '24', 'Session timeout in hours', 'NUMBER', 'SECURITY'),
- 3234: 
+ 3234:   (gen_random_uuid()::text, 'REFRESH_TOKEN_EXPIRY', '168', 'Refresh token expiry in hours (7 days)', 'NUMBER', 'SECURITY'),
- 3235: 
+ 3235:   
- 3236: 
+ 3236:   -- KYC Settings
- 3237: 
+ 3237:   (gen_random_uuid()::text, 'KYC_REQUIRED_FOR_WITHDRAWAL', 'true', 'Require KYC verification for withdrawals', 'BOOLEAN', 'KYC'),
- 3238: 
+ 3238:   (gen_random_uuid()::text, 'KYC_REQUIRED_AMOUNT', '1000', 'Amount threshold requiring KYC', 'NUMBER', 'KYC'),
- 3239: 
+ 3239:   (gen_random_uuid()::text, 'KYC_AUTO_APPROVE', 'false', 'Auto-approve KYC (for testing)', 'BOOLEAN', 'KYC'),
- 3240: 
+ 3240:   
- 3241: 
+ 3241:   -- Platform Settings
- 3242: 
+ 3242:   (gen_random_uuid()::text, 'PLATFORM_STATUS', 'active', 'Platform operational status (active/maintenance)', 'STRING', 'PLATFORM'),
- 3243: 
+ 3243:   (gen_random_uuid()::text, 'PLATFORM_NAME', 'NSC Bot Platform', 'Platform display name', 'STRING', 'PLATFORM'),
- 3244: 
+ 3244:   (gen_random_uuid()::text, 'PLATFORM_CURRENCY', 'USDT', 'Platform base currency', 'STRING', 'PLATFORM'),
- 3245: 
+ 3245:   (gen_random_uuid()::text, 'REGISTRATION_ENABLED', 'true', 'Allow new user registrations', 'BOOLEAN', 'PLATFORM'),
- 3246: 
+ 3246:   (gen_random_uuid()::text, 'MAINTENANCE_MODE', 'false', 'Enable maintenance mode', 'BOOLEAN', 'PLATFORM'),
- 3247: 
+ 3247:   (gen_random_uuid()::text, 'MAINTENANCE_MESSAGE', 'Platform under maintenance', 'Maintenance message', 'STRING', 'PLATFORM'),
- 3248: 
+ 3248:   
- 3249: 
+ 3249:   -- Payment Settings
- 3250: 
+ 3250:   (gen_random_uuid()::text, 'PAYMENT_CONFIRMATION_REQUIRED', '3', 'Required blockchain confirmations', 'NUMBER', 'PAYMENT'),
- 3251: 
+ 3251:   (gen_random_uuid()::text, 'PAYMENT_TIMEOUT_MINUTES', '30', 'Payment request timeout', 'NUMBER', 'PAYMENT'),
- 3252: 
+ 3252:   (gen_random_uuid()::text, 'AUTO_APPROVE_PAYMENTS', 'false', 'Auto-approve payments after confirmation', 'BOOLEAN', 'PAYMENT'),
- 3253: 
+ 3253:   
- 3254: 
+ 3254:   -- Withdrawal Settings
- 3255: 
+ 3255:   (gen_random_uuid()::text, 'AUTO_APPROVE_WITHDRAWALS', 'true', 'Auto-approve all withdrawal requests', 'BOOLEAN', 'WITHDRAWAL'),
- 3256: 
+ 3256:   (gen_random_uuid()::text, 'AUTO_APPROVE_WITHDRAWALS_MAX_AMOUNT', '1000', 'Maximum amount for auto-approval (0 = no limit)', 'NUMBER', 'WITHDRAWAL'),
- 3257: 
+ 3257:   (gen_random_uuid()::text, 'AUTO_APPROVE_WITHDRAWALS_KYC_REQUIRED', 'false', 'Require KYC for auto-approval', 'BOOLEAN', 'WITHDRAWAL'),
- 3258: 
+ 3258:   (gen_random_uuid()::text, 'WITHDRAWAL_PROCESSING_DELAY', '0', 'Delay in minutes before auto-processing (0 = instant)', 'NUMBER', 'WITHDRAWAL'),
- 3259: 
+ 3259:   
- 3260: 
+ 3260:   -- Blockchain Settings
- 3261: 
+ 3261:   (gen_random_uuid()::text, 'BEP20_ENABLED', 'true', 'Enable BEP20 network', 'BOOLEAN', 'BLOCKCHAIN'),
- 3262: 
+ 3262:   (gen_random_uuid()::text, 'TRC20_ENABLED', 'true', 'Enable TRC20 network', 'BOOLEAN', 'BLOCKCHAIN'),
- 3263: 
+ 3263:   (gen_random_uuid()::text, 'ERC20_ENABLED', 'false', 'Enable ERC20 network', 'BOOLEAN', 'BLOCKCHAIN'),
- 3264: 
+ 3264:   (gen_random_uuid()::text, 'POLYGON_ENABLED', 'false', 'Enable Polygon network', 'BOOLEAN', 'BLOCKCHAIN'),
- 3265: 
+ 3265:   
- 3266: 
+ 3266:   -- Email Settings
- 3267: 
+ 3267:   (gen_random_uuid()::text, 'EMAIL_NOTIFICATIONS_ENABLED', 'true', 'Enable email notifications', 'BOOLEAN', 'EMAIL'),
- 3268: 
+ 3268:   (gen_random_uuid()::text, 'EMAIL_VERIFICATION_REQUIRED', 'true', 'Require email verification', 'BOOLEAN', 'EMAIL'),
- 3269: 
+ 3269:   (gen_random_uuid()::text, 'ADMIN_EMAIL', 'admin@admin.com', 'Admin contact email', 'STRING', 'EMAIL'),
- 3270: 
+ 3270:   (gen_random_uuid()::text, 'SUPPORT_EMAIL', 'support@nscbot.com', 'Support email address', 'STRING', 'EMAIL'),
- 3271: 
+ 3271:   
- 3272: 
+ 3272:   -- ROI Cron Settings
- 3273: 
+ 3273:   (gen_random_uuid()::text, 'ROI_CRON_ENABLED', 'true', 'Enable automated ROI payments', 'BOOLEAN', 'CRON'),
- 3274: 
+ 3274:   (gen_random_uuid()::text, 'ROI_CRON_SCHEDULE', '0 0 * * *', 'ROI cron schedule (daily at midnight)', 'STRING', 'CRON'),
- 3275: 
+ 3275:   (gen_random_uuid()::text, 'EXPIRATION_CRON_ENABLED', 'true', 'Enable package expiration checks', 'BOOLEAN', 'CRON'),
- 3276: 
+ 3276:   (gen_random_uuid()::text, 'EXPIRATION_CRON_SCHEDULE', '0 1 * * *', 'Expiration cron schedule', 'STRING', 'CRON'),
- 3277: 
+ 3277:   
- 3278: 
+ 3278:   -- API Settings
- 3279: 
+ 3279:   (gen_random_uuid()::text, 'API_RATE_LIMIT', '100', 'API requests per minute', 'NUMBER', 'API'),
- 3280: 
+ 3280:   (gen_random_uuid()::text, 'API_RATE_LIMIT_WINDOW', '60', 'Rate limit window in seconds', 'NUMBER', 'API'),
- 3281: 
+ 3281:   (gen_random_uuid()::text, 'ADMIN_RATE_LIMIT', '1000', 'Admin API requests per minute', 'NUMBER', 'API'),
- 3282: 
+ 3282:   
- 3283: 
+ 3283:   -- Feature Flags
- 3284: 
+ 3284:   (gen_random_uuid()::text, 'FEATURE_BOT_ACTIVATION', 'true', 'Enable bot activation feature', 'BOOLEAN', 'FEATURES'),
- 3285: 
+ 3285:   (gen_random_uuid()::text, 'FEATURE_REFERRAL_SYSTEM', 'true', 'Enable referral system', 'BOOLEAN', 'FEATURES'),
- 3286: 
+ 3286:   (gen_random_uuid()::text, 'FEATURE_TWO_FACTOR', 'true', 'Enable 2FA authentication', 'BOOLEAN', 'FEATURES'),
- 3287: 
+ 3287:   (gen_random_uuid()::text, 'FEATURE_KYC', 'true', 'Enable KYC verification', 'BOOLEAN', 'FEATURES'),
- 3288: 
+ 3288:   
- 3289: 
+ 3289:   -- Support Settings
- 3290: 
+ 3290:   (gen_random_uuid()::text, 'SUPPORT_ENABLED', 'true', 'Enable support ticket system', 'BOOLEAN', 'SUPPORT'),
- 3291: 
+ 3291:   (gen_random_uuid()::text, 'SUPPORT_AUTO_RESPONSE', 'true', 'Send auto-response for tickets', 'BOOLEAN', 'SUPPORT'),
- 3292: 
+ 3292:   
- 3293: 
+ 3293:   -- Legal Settings
- 3294: 
+ 3294:   (gen_random_uuid()::text, 'TERMS_VERSION', '1.0', 'Current terms of service version', 'STRING', 'LEGAL'),
- 3295: 
+ 3295:   (gen_random_uuid()::text, 'PRIVACY_VERSION', '1.0', 'Current privacy policy version', 'STRING', 'LEGAL'),
- 3296: 
+ 3296:   (gen_random_uuid()::text, 'REQUIRE_TERMS_ACCEPTANCE', 'true', 'Require terms acceptance', 'BOOLEAN', 'LEGAL')
- 3297: 
+ 3297: ON CONFLICT ("key") DO NOTHING;
- 3299: 
+ 3299: -- ----------------------------------------------------------------------------
- 3300: 
+ 3300: -- Platform Wallet Addresses (PLACEHOLDER - Update with real addresses)
- 3301: 
+ 3301: -- ----------------------------------------------------------------------------
- 3302: 
+ 3302: INSERT INTO "PlatformWallet" ("id", "network", "address", "label", "isActive") VALUES
- 3303: 
+ 3303:   (gen_random_uuid()::text, 'BEP20', '0x0000000000000000000000000000000000000000', 'Main BEP20 Wallet', true),
- 3304: 
+ 3304:   (gen_random_uuid()::text, 'TRC20', 'T000000000000000000000000000000000', 'Main TRC20 Wallet', true),
- 3305: 
+ 3305:   (gen_random_uuid()::text, 'ERC20', '0x0000000000000000000000000000000000000000', 'Main ERC20 Wallet', false),
- 3306: 
+ 3306:   (gen_random_uuid()::text, 'POLYGON', '0x0000000000000000000000000000000000000000', 'Main Polygon Wallet', false)
- 3307: 
+ 3307: ON CONFLICT ("network") DO NOTHING;
- 3309: 
+ 3309: -- ----------------------------------------------------------------------------
- 3310: 
+ 3310: -- Cron Job Initialization
- 3311: 
+ 3311: -- ----------------------------------------------------------------------------
- 3312: 
+ 3312: INSERT INTO "CronJob" ("id", "name", "description", "schedule", "status", "enabled") VALUES
- 3313: 
+ 3313:   (gen_random_uuid()::text, 'ROI_PAYOUT', 'Process monthly ROI payments', '0 0 * * *', 'IDLE', true),
- 3314: 
+ 3314:   (gen_random_uuid()::text, 'PACKAGE_EXPIRATION', 'Check and process package expirations', '0 1 * * *', 'IDLE', true),
- 3315: 
+ 3315:   (gen_random_uuid()::text, 'BOT_EXPIRATION', 'Check and process bot expirations', '0 2 * * *', 'IDLE', true),
- 3316: 
+ 3316:   (gen_random_uuid()::text, 'SESSION_CLEANUP', 'Cleanup expired sessions', '0 3 * * *', 'IDLE', true),
- 3317: 
+ 3317:   (gen_random_uuid()::text, 'OLD_RECORDS_CLEANUP', 'Cleanup old logs and records', '0 4 * * 0', 'IDLE', true),
- 3318: 
+ 3318:   (gen_random_uuid()::text, 'BLOCKCHAIN_SCAN', 'Scan blockchain for pending transactions', '*/5 * * * *', 'IDLE', true),
- 3319: 
+ 3319:   (gen_random_uuid()::text, 'PAYMENT_VERIFICATION', 'Verify pending payment confirmations', '*/10 * * * *', 'IDLE', true),
- 3320: 
+ 3320:   (gen_random_uuid()::text, 'STATS_REFRESH', 'Refresh materialized views', '0 */6 * * *', 'IDLE', true)
- 3321: 
+ 3321: ON CONFLICT ("name") DO NOTHING;
- 3323: 
+ 3323: -- ----------------------------------------------------------------------------
- 3324: 
+ 3324: -- Create Default Admin User (CHANGE PASSWORD IMMEDIATELY!)
- 3325: 
+ 3325: -- ----------------------------------------------------------------------------
- 3326: 
+ 3326: -- Password: WtsWts@@688688 (bcrypt hashed)
- 3327: 
+ 3327: -- Email: admin@admin.com
- 3328: 
+ 3328: INSERT INTO "User" (
- 3329: 
+ 3329:   "id", 
- 3330: 
+ 3330:   "email", 
- 3331: 
+ 3331:   "password", 
- 3332: 
+ 3332:   "username",
- 3333: 
+ 3333:   "fullName",
- 3334: 
+ 3334:   "referralCode",
- 3335: 
+ 3335:   "isEmailVerified",
- 3336: 
+ 3336:   "kycStatus",
- 3337: 
+ 3337:   "isAdmin",
- 3338: 
+ 3338:   "isActive",
- 3339: 
+ 3339:   "role",
- 3340: 
+ 3340:   "createdAt"
- 3341: 
+ 3341: ) VALUES (
- 3342: 
+ 3342:   gen_random_uuid()::text,
- 3343: 
+ 3343:   'admin@admin.com',
- 3344: 
+ 3344:   '$2b$10$VsDey6Mp38OYo8IZPL5v8OLjk9xZGZSq0BD3aDCTBWc6wcRk9VdhW',
- 3345: 
+ 3345:   'admin',
- 3346: 
+ 3346:   'System Administrator',
- 3347: 
+ 3347:   'ADMIN001',
- 3348: 
+ 3348:   true,
- 3349: 
+ 3349:   'APPROVED',
- 3350: 
+ 3350:   true,
- 3351: 
+ 3351:   true,
- 3352: 
+ 3352:   'SUPER_ADMIN',
- 3353: 
+ 3353:   NOW()
- 3354: 
+ 3354: ) ON CONFLICT ("email") DO NOTHING;
- 3356: 
+ 3356: -- Add admin to referral counter so it doesn't interfere
- 3357: 
+ 3357: UPDATE "ReferralCounter" SET "currentValue" = 1001 WHERE "counterType" = 'NSCREF';
- 3359: 
+ 3359: -- ----------------------------------------------------------------------------
- 3360: 
+ 3360: -- Sample Package Types Documentation (for reference)
- 3361: 
+ 3361: -- ----------------------------------------------------------------------------
- 3362: 
+ 3362: -- NEO Package:    $100 - $999    | 3% monthly ROI  | $10 bot fee
- 3363: 
+ 3363: -- NEURAL Package: $1000 - $4999  | 4% monthly ROI  | $50 bot fee
- 3364: 
+ 3364: -- ORACLE Package: $5000 - $50000 | 5% monthly ROI  | $100 bot fee
- 3366: 
+ 3366: -- ----------------------------------------------------------------------------
- 3367: 
+ 3367: -- Create notification for admin
- 3368: 
+ 3368: -- ----------------------------------------------------------------------------
- 3369: 
+ 3369: INSERT INTO "Notification" (
- 3370: 
+ 3370:   "id",
- 3371: 
+ 3371:   "userId",
- 3372: 
+ 3372:   "title",
- 3373: 
+ 3373:   "message",
- 3374: 
+ 3374:   "type",
- 3375: 
+ 3375:   "read"
- 3376: 
+ 3376: ) SELECT
- 3377: 
+ 3377:   gen_random_uuid()::text,
- 3378: 
+ 3378:   "id",
- 3379: 
+ 3379:   'Welcome to NSC Bot Platform',
- 3380: 
+ 3380:   'Database schema has been successfully initialized. Please review system settings and update platform wallet addresses.',
- 3381: 
+ 3381:   'INFO',
- 3382: 
+ 3382:   false
- 3383: 
+ 3383: FROM "User" WHERE "email" = 'admin@admin.com';
- 3385: 
+ 3385: -- ----------------------------------------------------------------------------
- 3386: 
+ 3386: -- Initialize blockchain scan state
- 3387: 
+ 3387: -- ----------------------------------------------------------------------------
- 3388: 
+ 3388: -- Already done in 03_financial_tables.sql, but ensuring here
- 3389: 
+ 3389: INSERT INTO "BlockchainScanState" ("id", "network", "lastScannedBlock", "lastScanTime")
- 3390: 
+ 3390: VALUES
- 3391: 
+ 3391:   (gen_random_uuid()::text, 'BEP20', 0, CURRENT_TIMESTAMP),
- 3392: 
+ 3392:   (gen_random_uuid()::text, 'TRC20', 0, CURRENT_TIMESTAMP),
- 3393: 
+ 3393:   (gen_random_uuid()::text, 'ERC20', 0, CURRENT_TIMESTAMP),
- 3394: 
+ 3394:   (gen_random_uuid()::text, 'POLYGON', 0, CURRENT_TIMESTAMP)
- 3395: 
+ 3395: ON CONFLICT ("network") DO NOTHING;
- 3397: 
+ 3397: -- ----------------------------------------------------------------------------
- 3398: 
+ 3398: -- Grant necessary permissions (if needed)
- 3399: 
+ 3399: -- ----------------------------------------------------------------------------
- 3400: 
+ 3400: -- GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO your_database_user;
- 3401: 
+ 3401: -- GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO your_database_user;
- 3402: 
+ 3402: -- GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA public TO your_database_user;
- 3404: 
+ 3404: -- ----------------------------------------------------------------------------
- 3405: 
+ 3405: -- Success Message
- 3406: 
+ 3406: -- ----------------------------------------------------------------------------
- 3407: 
+ 3407: DO $$
- 3408: 
+ 3408: BEGIN
- 3409: 
+ 3409:   RAISE NOTICE '========================================';
- 3410: 
+ 3410:   RAISE NOTICE 'Database Setup Complete!';
- 3411: 
+ 3411:   RAISE NOTICE '========================================';
- 3412: 
+ 3412:   RAISE NOTICE 'Default Admin Credentials:';
- 3413: 
+ 3413:   RAISE NOTICE '  Email: admin@admin.com';
- 3414: 
+ 3414:   RAISE NOTICE '  Password: WtsWts@@688688';
- 3415: 
+ 3415:   RAISE NOTICE '========================================';
- 3416: 
+ 3416:   RAISE NOTICE 'IMPORTANT: Change password after first login!';
- 3417: 
+ 3417:   RAISE NOTICE '========================================';
- 3418: 
+ 3418: END $$;
- 3421: 
+ 3421: -- End included: 08_initial_data.sql
- 3424: 
+ 3424: -- Begin included: 09_indexes_optimization.sql
- 3425: 
+ 3425: -- ============================================================================
- 3426: 
+ 3426: -- OPTIMIZATION INDEXES - Additional indexes for query performance
- 3427: 
+ 3427: -- ============================================================================
- 3429: 
+ 3429: -- ----------------------------------------------------------------------------
- 3430: 
+ 3430: -- Composite Indexes for Common Query Patterns
- 3431: 
+ 3431: -- ----------------------------------------------------------------------------
- 3433: 
+ 3433: -- User queries with status filters
- 3434: 
+ 3434: CREATE INDEX IF NOT EXISTS "idx_user_active_kyc" ON "User"("isActive", "kycStatus") WHERE "isActive" = true;
- 3435: 
+ 3435: CREATE INDEX IF NOT EXISTS "idx_user_blocked_created" ON "User"("isBlocked", "createdAt") WHERE "isBlocked" = false;
- 3436: 
+ 3436: CREATE INDEX IF NOT EXISTS "idx_user_role_active" ON "User"("role", "isActive") WHERE "isActive" = true;
- 3438: 
+ 3438: -- Package queries with multiple filters
- 3439: 
+ 3439: CREATE INDEX IF NOT EXISTS "idx_package_user_status" ON "Package"("userId", "status");
- 3440: 
+ 3440: CREATE INDEX IF NOT EXISTS "idx_package_status_type" ON "Package"("status", "packageType");
- 3441: 
+ 3441: CREATE INDEX IF NOT EXISTS "idx_package_active_nextpayment" ON "Package"("status", "nextRoiDate") WHERE "status" = 'ACTIVE';
- 3442: 
+ 3442: CREATE INDEX IF NOT EXISTS "idx_package_expired_flag" ON "Package"("isExpired", "expiryDate") WHERE "isExpired" = false;
- 3443: 
+ 3443: CREATE INDEX IF NOT EXISTS "idx_package_user_active" ON "Package"("userId", "status") WHERE "status" = 'ACTIVE';
- 3445: 
+ 3445: -- Bot activation queries
- 3446: 
+ 3446: CREATE INDEX IF NOT EXISTS "idx_bot_user_status" ON "BotActivation"("userId", "status");
- 3447: 
+ 3447: CREATE INDEX IF NOT EXISTS "idx_bot_active_expiry" ON "BotActivation"("status", "expiryDate") WHERE "status" = 'ACTIVE';
- 3448: 
+ 3448: CREATE INDEX IF NOT EXISTS "idx_bot_expired_flag" ON "BotActivation"("isExpired", "expiryDate");
- 3450: 
+ 3450: -- Transaction queries with multiple columns
- 3451: 
+ 3451: CREATE INDEX IF NOT EXISTS "idx_transaction_user_type_status" ON "Transaction"("userId", "type", "status");
- 3452: 
+ 3452: CREATE INDEX IF NOT EXISTS "idx_transaction_type_created" ON "Transaction"("type", "createdAt" DESC);
- 3453: 
+ 3453: CREATE INDEX IF NOT EXISTS "idx_transaction_status_created" ON "Transaction"("status", "createdAt" DESC);
- 3454: 
+ 3454: CREATE INDEX IF NOT EXISTS "idx_transaction_user_created" ON "Transaction"("userId", "createdAt" DESC);
- 3455: 
+ 3455: CREATE INDEX IF NOT EXISTS "idx_transaction_reference" ON "Transaction"("referenceType", "referenceId");
- 3457: 
+ 3457: -- ROI payment queries
- 3458: 
+ 3458: CREATE INDEX IF NOT EXISTS "idx_roi_package_month" ON "RoiPayment"("packageId", "monthNumber");
- 3459: 
+ 3459: CREATE INDEX IF NOT EXISTS "idx_roi_user_status" ON "RoiPayment"("userId", "status");
- 3460: 
+ 3460: CREATE INDEX IF NOT EXISTS "idx_roi_scheduled_pending" ON "RoiPayment"("scheduledDate") WHERE "status" = 'PENDING';
- 3461: 
+ 3461: CREATE INDEX IF NOT EXISTS "idx_roi_payment_date" ON "RoiPayment"("paymentDate" DESC);
- 3463: 
+ 3463: -- Earning queries
- 3464: 
+ 3464: CREATE INDEX IF NOT EXISTS "idx_earning_user_type" ON "Earning"("userId", "earningType");
- 3465: 
+ 3465: CREATE INDEX IF NOT EXISTS "idx_earning_from_type" ON "Earning"("fromUserId", "earningType");
- 3466: 
+ 3466: CREATE INDEX IF NOT EXISTS "idx_earning_user_created" ON "Earning"("userId", "createdAt" DESC);
- 3467: 
+ 3467: CREATE INDEX IF NOT EXISTS "idx_earning_level_created" ON "Earning"("level", "createdAt" DESC) WHERE "level" IS NOT NULL;
- 3469: 
+ 3469: -- Withdrawal queries
- 3470: 
+ 3470: CREATE INDEX IF NOT EXISTS "idx_withdrawal_user_status" ON "Withdrawal"("userId", "status");
- 3471: 
+ 3471: CREATE INDEX IF NOT EXISTS "idx_withdrawal_status_created" ON "Withdrawal"("status", "createdAt" DESC);
- 3472: 
+ 3472: CREATE INDEX IF NOT EXISTS "idx_withdrawal_pending_date" ON "Withdrawal"("requestDate") WHERE "status" = 'PENDING';
- 3473: 
+ 3473: CREATE INDEX IF NOT EXISTS "idx_withdrawal_network_status" ON "Withdrawal"("network", "status");
- 3474: 
+ 3474: CREATE INDEX IF NOT EXISTS "idx_withdrawal_approved_user" ON "Withdrawal"("approvedBy", "approvedAt") WHERE "approvedBy" IS NOT NULL;
- 3476: 
+ 3476: -- Payment request queries
- 3477: 
+ 3477: CREATE INDEX IF NOT EXISTS "idx_payment_user_status" ON "PaymentRequest"("userId", "status");
- 3478: 
+ 3478: CREATE INDEX IF NOT EXISTS "idx_payment_status_created" ON "PaymentRequest"("status", "createdAt" DESC);
- 3479: 
+ 3479: CREATE INDEX IF NOT EXISTS "idx_payment_pending_expires" ON "PaymentRequest"("expiresAt") WHERE "status" = 'PENDING';
- 3480: 
+ 3480: CREATE INDEX IF NOT EXISTS "idx_payment_purpose_status" ON "PaymentRequest"("purpose", "status");
- 3481: 
+ 3481: CREATE INDEX IF NOT EXISTS "idx_payment_network_status" ON "PaymentRequest"("network", "status");
- 3483: 
+ 3483: -- Payment confirmation queries
- 3484: 
+ 3484: CREATE INDEX IF NOT EXISTS "idx_paymentconf_pending" ON "PaymentConfirmation"("isConfirmed", "nextCheckAt") WHERE "isConfirmed" = false;
- 3485: 
+ 3485: CREATE INDEX IF NOT EXISTS "idx_paymentconf_network_status" ON "PaymentConfirmation"("network", "status");
- 3487: 
+ 3487: -- Session queries
- 3488: 
+ 3488: CREATE INDEX IF NOT EXISTS "idx_session_user_active" ON "Session"("userId", "isActive") WHERE "isActive" = true;
- 3489: 
+ 3489: CREATE INDEX IF NOT EXISTS "idx_session_expires_active" ON "Session"("expiresAt", "isActive");
- 3490: 
+ 3490: CREATE INDEX IF NOT EXISTS "idx_session_status_expires" ON "Session"("status", "expiresAt");
- 3492: 
+ 3492: -- Added 2025-11-11: Additional performance indexes
- 3493: 
+ 3493: CREATE INDEX IF NOT EXISTS "Package_userId_idx" ON "Package"("userId");
- 3494: 
+ 3494: CREATE INDEX IF NOT EXISTS "Transaction_userId_idx" ON "Transaction"("userId");
- 3495: 
+ 3495: CREATE INDEX IF NOT EXISTS "Withdrawal_userId_idx" ON "Withdrawal"("userId");
- 3496: 
+ 3496: CREATE INDEX IF NOT EXISTS "Session_userId_idx" ON "Session"("userId");
- 3497: 
+ 3497: CREATE INDEX IF NOT EXISTS "Earning_userId_idx" ON "Earning"("userId");
- 3498: 
+ 3498: CREATE INDEX IF NOT EXISTS "RoiPayment_packageId_idx" ON "RoiPayment"("packageId");
- 3499: 
+ 3499: CREATE INDEX IF NOT EXISTS "RoiPayment_userId_idx" ON "RoiPayment"("userId");
- 3500: 
+ 3500: CREATE INDEX IF NOT EXISTS "Package_status_idx" ON "Package"("status");
- 3501: 
+ 3501: CREATE INDEX IF NOT EXISTS "Transaction_status_idx" ON "Transaction"("status");
- 3502: 
+ 3502: CREATE INDEX IF NOT EXISTS "Withdrawal_status_idx" ON "Withdrawal"("status");
- 3504: 
+ 3504: -- Login attempt queries
- 3505: 
+ 3505: CREATE INDEX IF NOT EXISTS "idx_loginattempt_email_created" ON "LoginAttempt"("email", "createdAt" DESC);
- 3506: 
+ 3506: CREATE INDEX IF NOT EXISTS "idx_loginattempt_email_success" ON "LoginAttempt"("email", "success", "createdAt" DESC);
- 3507: 
+ 3507: CREATE INDEX IF NOT EXISTS "idx_loginattempt_ip_created" ON "LoginAttempt"("ipAddress", "createdAt" DESC);
- 3509: 
+ 3509: -- Notification queries
- 3510: 
+ 3510: CREATE INDEX IF NOT EXISTS "idx_notification_user_read" ON "Notification"("userId", "read", "createdAt" DESC);
- 3511: 
+ 3511: CREATE INDEX IF NOT EXISTS "idx_notification_user_type" ON "Notification"("userId", "type") WHERE "read" = false;
- 3512: 
+ 3512: CREATE INDEX IF NOT EXISTS "idx_notification_unread" ON "Notification"("userId") WHERE "read" = false;
- 3514: 
+ 3514: -- KYC submission queries
- 3515: 
+ 3515: CREATE INDEX IF NOT EXISTS "idx_kyc_user_status" ON "KYCSubmission"("userId", "status");
- 3516: 
+ 3516: CREATE INDEX IF NOT EXISTS "idx_kyc_pending_submitted" ON "KYCSubmission"("submittedAt") WHERE "status" = 'PENDING';
- 3518: 
+ 3518: -- Support ticket queries
- 3519: 
+ 3519: CREATE INDEX IF NOT EXISTS "idx_ticket_user_status" ON "SupportTicket"("userId", "status");
- 3520: 
+ 3520: CREATE INDEX IF NOT EXISTS "idx_ticket_status_priority" ON "SupportTicket"("status", "priority");
- 3521: 
+ 3521: CREATE INDEX IF NOT EXISTS "idx_ticket_assigned_status" ON "SupportTicket"("assignedTo", "status") WHERE "assignedTo" IS NOT NULL;
- 3522: 
+ 3522: CREATE INDEX IF NOT EXISTS "idx_ticket_open_created" ON "SupportTicket"("createdAt" DESC) WHERE "status" IN ('OPEN', 'IN_PROGRESS');
- 3524: 
+ 3524: -- Admin log queries
- 3525: 
+ 3525: CREATE INDEX IF NOT EXISTS "idx_adminlog_admin_created" ON "AdminLog"("adminId", "createdAt" DESC);
- 3526: 
+ 3526: CREATE INDEX IF NOT EXISTS "idx_adminlog_target" ON "AdminLog"("targetType", "targetId");
- 3527: 
+ 3527: CREATE INDEX IF NOT EXISTS "idx_adminlog_action_created" ON "AdminLog"("action", "createdAt" DESC);
- 3529: 
+ 3529: -- Audit log queries
- 3530: 
+ 3530: CREATE INDEX IF NOT EXISTS "idx_auditlog_user_action" ON "AuditLog"("userId", "action", "createdAt" DESC);
- 3531: 
+ 3531: CREATE INDEX IF NOT EXISTS "idx_auditlog_entity" ON "AuditLog"("entityType", "entityId");
- 3533: 
+ 3533: -- Email log queries
- 3534: 
+ 3534: CREATE INDEX IF NOT EXISTS "idx_emaillog_user_status" ON "EmailLog"("userId", "status");
- 3535: 
+ 3535: CREATE INDEX IF NOT EXISTS "idx_emaillog_status_created" ON "EmailLog"("status", "createdAt" DESC);
- 3536: 
+ 3536: CREATE INDEX IF NOT EXISTS "idx_emaillog_to_created" ON "EmailLog"("to", "createdAt" DESC);
- 3538: 
+ 3538: -- API log queries (with partial index for better performance)
- 3539: 
+ 3539: CREATE INDEX IF NOT EXISTS "idx_apilog_user_path" ON "ApiLog"("userId", "path", "createdAt" DESC) WHERE "userId" IS NOT NULL;
- 3540: 
+ 3540: CREATE INDEX IF NOT EXISTS "idx_apilog_error" ON "ApiLog"("createdAt" DESC) WHERE "error" IS NOT NULL;
- 3541: 
+ 3541: CREATE INDEX IF NOT EXISTS "idx_apilog_slow_requests" ON "ApiLog"("createdAt" DESC) WHERE "responseTime" > 1000;
- 3543: 
+ 3543: -- Error log queries
- 3544: 
+ 3544: CREATE INDEX IF NOT EXISTS "idx_errorlog_unresolved" ON "ErrorLog"("createdAt" DESC) WHERE "resolved" = false;
- 3545: 
+ 3545: CREATE INDEX IF NOT EXISTS "idx_errorlog_severity" ON "ErrorLog"("severity", "createdAt" DESC);
- 3547: 
+ 3547: -- Cron job queries
- 3548: 
+ 3548: CREATE INDEX IF NOT EXISTS "idx_cronjob_enabled_next" ON "CronJob"("enabled", "nextRunAt") WHERE "enabled" = true;
- 3549: 
+ 3549: CREATE INDEX IF NOT EXISTS "idx_cronjob_status_name" ON "CronJob"("status", "name");
- 3551: 
+ 3551: -- Cron job execution queries
- 3552: 
+ 3552: CREATE INDEX IF NOT EXISTS "idx_cronjobexec_job_started" ON "CronJobExecution"("cronJobId", "startedAt" DESC);
- 3553: 
+ 3553: CREATE INDEX IF NOT EXISTS "idx_cronjobexec_failed" ON "CronJobExecution"("cronJobId", "startedAt" DESC) WHERE "success" = false;
- 3555: 
+ 3555: -- ----------------------------------------------------------------------------
- 3556: 
+ 3556: -- Partial Indexes for Specific Use Cases
- 3557: 
+ 3557: -- ----------------------------------------------------------------------------
- 3559: 
+ 3559: -- Active users only
- 3560: 
+ 3560: CREATE INDEX IF NOT EXISTS "idx_active_users_only" ON "User"("createdAt" DESC) WHERE "isActive" = true AND "isBlocked" = false;
- 3562: 
+ 3562: -- KYC approved users
- 3563: 
+ 3563: CREATE INDEX IF NOT EXISTS "idx_kyc_approved_users" ON "User"("createdAt" DESC) WHERE "kycStatus" = 'APPROVED';
- 3565: 
+ 3565: -- Active packages needing ROI
- 3566: 
+ 3566: CREATE INDEX IF NOT EXISTS "idx_active_packages_roi_due" ON "Package"("nextRoiDate") 
- 3567: 
+ 3567:   WHERE "status" = 'ACTIVE' AND "isExpired" = false AND "nextRoiDate" IS NOT NULL;
- 3569: 
+ 3569: -- Packages nearing expiry (within 30 days)
- 3570: 
+ 3570: -- Note: Removed NOW() as it's not immutable for index predicates
- 3571: 
+ 3571: -- Use query-time filtering instead: WHERE "expiryDate" < NOW() + INTERVAL '30 days'
- 3572: 
+ 3572: CREATE INDEX IF NOT EXISTS "idx_packages_expiring_soon" ON "Package"("expiryDate") 
- 3573: 
+ 3573:   WHERE "status" = 'ACTIVE';
- 3575: 
+ 3575: -- Pending withdrawals (admin queue)
- 3576: 
+ 3576: CREATE INDEX IF NOT EXISTS "idx_pending_withdrawals_queue" ON "Withdrawal"("requestDate") 
- 3577: 
+ 3577:   WHERE "status" = 'PENDING';
- 3579: 
+ 3579: -- Failed transactions needing review
- 3580: 
+ 3580: CREATE INDEX IF NOT EXISTS "idx_failed_transactions" ON "Transaction"("createdAt" DESC) 
- 3581: 
+ 3581:   WHERE "status" = 'FAILED';
- 3583: 
+ 3583: -- Unconfirmed payments
- 3584: 
+ 3584: CREATE INDEX IF NOT EXISTS "idx_unconfirmed_payments" ON "PaymentConfirmation"("lastCheckedAt") 
- 3585: 
+ 3585:   WHERE "isConfirmed" = false AND "errorCount" < 10;
- 3587: 
+ 3587: -- Active sessions
- 3588: 
+ 3588: -- Note: Removed NOW() as it's not immutable for index predicates
- 3589: 
+ 3589: -- Use query-time filtering instead: WHERE "expiresAt" > NOW()
- 3590: 
+ 3590: CREATE INDEX IF NOT EXISTS "idx_active_sessions_only" ON "Session"("lastUsedAt" DESC) 
- 3591: 
+ 3591:   WHERE "isActive" = true;
- 3593: 
+ 3593: -- Unread notifications
- 3594: 
+ 3594: CREATE INDEX IF NOT EXISTS "idx_unread_notifications_only" ON "Notification"("createdAt" DESC) 
- 3595: 
+ 3595:   WHERE "read" = false;
- 3597: 
+ 3597: -- ----------------------------------------------------------------------------
- 3598: 
+ 3598: -- GIN Indexes for JSONB Columns (for faster JSON queries)
- 3599: 
+ 3599: -- ----------------------------------------------------------------------------
- 3601: 
+ 3601: CREATE INDEX IF NOT EXISTS "idx_transaction_metadata_gin" ON "Transaction" USING GIN ("metadata");
- 3602: 
+ 3602: CREATE INDEX IF NOT EXISTS "idx_package_metadata_gin" ON "Package" USING GIN ("metadata");
- 3603: 
+ 3603: CREATE INDEX IF NOT EXISTS "idx_paymentrequest_metadata_gin" ON "PaymentRequest" USING GIN ("metadata");
- 3604: 
+ 3604: CREATE INDEX IF NOT EXISTS "idx_adminlog_details_gin" ON "AdminLog" USING GIN ("details");
- 3605: 
+ 3605: CREATE INDEX IF NOT EXISTS "idx_auditlog_changes_gin" ON "AuditLog" USING GIN ("changes");
- 3607: 
+ 3607: -- ----------------------------------------------------------------------------
- 3608: 
+ 3608: -- Full Text Search Indexes (for search functionality)
- 3609: 
+ 3609: -- ----------------------------------------------------------------------------
- 3611: 
+ 3611: -- User search by name and email
- 3612: 
+ 3612: CREATE INDEX IF NOT EXISTS "idx_user_fulltext" ON "User" USING GIN (
- 3613: 
+ 3613:   to_tsvector('english', COALESCE("fullName", '') || ' ' || COALESCE("email", ''))
- 3614: 
+ 3614: );
- 3616: 
+ 3616: -- Support ticket search
- 3617: 
+ 3617: CREATE INDEX IF NOT EXISTS "idx_ticket_fulltext" ON "SupportTicket" USING GIN (
- 3618: 
+ 3618:   to_tsvector('english', COALESCE("subject", '') || ' ' || COALESCE("message", ''))
- 3619: 
+ 3619: );
- 3621: 
+ 3621: -- ----------------------------------------------------------------------------
- 3622: 
+ 3622: -- Expression Indexes (for computed values)
- 3623: 
+ 3623: -- ----------------------------------------------------------------------------
- 3625: 
+ 3625: -- Date-based queries
- 3626: 
+ 3626: CREATE INDEX IF NOT EXISTS "idx_user_created_date" ON "User"(DATE("createdAt"));
- 3627: 
+ 3627: CREATE INDEX IF NOT EXISTS "idx_package_created_date" ON "Package"(DATE("createdAt"));
- 3628: 
+ 3628: CREATE INDEX IF NOT EXISTS "idx_transaction_created_date" ON "Transaction"(DATE("createdAt"));
- 3629: 
+ 3629: CREATE INDEX IF NOT EXISTS "idx_withdrawal_created_date" ON "Withdrawal"(DATE("createdAt"));
- 3631: 
+ 3631: -- Month-based reporting
- 3632: 
+ 3632: CREATE INDEX IF NOT EXISTS "idx_transaction_month" ON "Transaction"(DATE_TRUNC('month', "createdAt"));
- 3633: 
+ 3633: CREATE INDEX IF NOT EXISTS "idx_package_month" ON "Package"(DATE_TRUNC('month', "createdAt"));
- 3635: 
+ 3635: -- Email domain queries (for analytics)
- 3636: 
+ 3636: CREATE INDEX IF NOT EXISTS "idx_user_email_domain" ON "User"(LOWER(SPLIT_PART("email", '@', 2)));
- 3638: 
+ 3638: -- ----------------------------------------------------------------------------
- 3639: 
+ 3639: -- Covering Indexes (include frequently accessed columns)
- 3640: 
+ 3640: -- ----------------------------------------------------------------------------
- 3642: 
+ 3642: -- User lookup with basic info
- 3643: 
+ 3643: CREATE INDEX IF NOT EXISTS "idx_user_lookup_covering" ON "User"("email") 
- 3644: 
+ 3644:   INCLUDE ("id", "fullName", "isActive", "kycStatus");
- 3646: 
+ 3646: -- Package summary queries
- 3647: 
+ 3647: CREATE INDEX IF NOT EXISTS "idx_package_summary_covering" ON "Package"("userId", "status") 
- 3648: 
+ 3648:   INCLUDE ("amount", "packageType", "roiPercentage", "investmentDate");
- 3650: 
+ 3650: -- Transaction history queries
- 3651: 
+ 3651: CREATE INDEX IF NOT EXISTS "idx_transaction_history_covering" ON "Transaction"("userId", "createdAt" DESC) 
- 3652: 
+ 3652:   INCLUDE ("type", "amount", "status", "description");
- 3654: 
+ 3654: -- ----------------------------------------------------------------------------
- 3655: 
+ 3655: -- Analyze Tables for Query Planner
- 3656: 
+ 3656: -- ----------------------------------------------------------------------------
- 3658: 
+ 3658: ANALYZE "User";
- 3659: 
+ 3659: ANALYZE "Package";
- 3660: 
+ 3660: ANALYZE "BotActivation";
- 3661: 
+ 3661: ANALYZE "Transaction";
- 3662: 
+ 3662: ANALYZE "RoiPayment";
- 3663: 
+ 3663: ANALYZE "Earning";
- 3664: 
+ 3664: ANALYZE "Withdrawal";
- 3665: 
+ 3665: ANALYZE "PaymentRequest";
- 3666: 
+ 3666: ANALYZE "PaymentConfirmation";
- 3667: 
+ 3667: ANALYZE "Session";
- 3668: 
+ 3668: ANALYZE "LoginAttempt";
- 3669: 
+ 3669: ANALYZE "Notification";
- 3670: 
+ 3670: ANALYZE "KYCSubmission";
- 3671: 
+ 3671: ANALYZE "SupportTicket";
- 3672: 
+ 3672: ANALYZE "AdminLog";
- 3673: 
+ 3673: ANALYZE "SystemSetting";
- 3675: 
+ 3675: -- ----------------------------------------------------------------------------
- 3676: 
+ 3676: -- Vacuum Tables (optional - for maintenance)
- 3677: 
+ 3677: -- ----------------------------------------------------------------------------
- 3679: 
+ 3679: -- VACUUM ANALYZE "User";
- 3680: 
+ 3680: -- VACUUM ANALYZE "Package";
- 3681: 
+ 3681: -- VACUUM ANALYZE "Transaction";
- 3683: 
+ 3683: -- ----------------------------------------------------------------------------
- 3684: 
+ 3684: -- Performance Recommendations
- 3685: 
+ 3685: -- ----------------------------------------------------------------------------
- 3687: 
+ 3687: DO $$
- 3688: 
+ 3688: BEGIN
- 3689: 
+ 3689:   RAISE NOTICE '========================================';
- 3690: 
+ 3690:   RAISE NOTICE 'Optimization indexes created successfully!';
- 3691: 
+ 3691:   RAISE NOTICE '========================================';
- 3692: 
+ 3692:   RAISE NOTICE 'Performance Tips:';
- 3693: 
+ 3693:   RAISE NOTICE '1. Run ANALYZE regularly (daily recommended)';
- 3694: 
+ 3694:   RAISE NOTICE '2. Monitor slow queries with pg_stat_statements';
- 3695: 
+ 3695:   RAISE NOTICE '3. Use EXPLAIN ANALYZE for query optimization';
- 3696: 
+ 3696:   RAISE NOTICE '4. Consider partitioning large tables (Transaction, LoginAttempt)';
- 3697: 
+ 3697:   RAISE NOTICE '5. Set up connection pooling (PgBouncer recommended)';
- 3698: 
+ 3698:   RAISE NOTICE '6. Configure shared_buffers to 25%% of RAM';
- 3699: 
+ 3699:   RAISE NOTICE '7. Enable query result caching in application layer';
- 3700: 
+ 3700:   RAISE NOTICE '8. Monitor index usage with pg_stat_user_indexes';
- 3701: 
+ 3701:   RAISE NOTICE '9. Regular VACUUM FULL on heavily updated tables';
- 3702: 
+ 3702:   RAISE NOTICE '10. Use materialized views for complex aggregations';
- 3703: 
+ 3703:   RAISE NOTICE '========================================';
- 3704: 
+ 3704: END $$;
- 3707: 
+ 3707: -- End included: 09_indexes_optimization.sql
- 3710: 
+ 3710: -- Run verification queries
- 3711: 
+ 3711: SELECT 
- 3712: 
+ 3712:   'Tables' as object_type,
- 3713: 
+ 3713:   COUNT(*) as count
- 3714: 
+ 3714: FROM information_schema.tables 
- 3715: 
+ 3715: WHERE table_schema = 'public'
- 3716: 
+ 3716: UNION ALL
- 3717: 
+ 3717: SELECT 
- 3718: 
+ 3718:   'Functions',
- 3719: 
+ 3719:   COUNT(*)
- 3720: 
+ 3720: FROM information_schema.routines
- 3721: 
+ 3721: WHERE routine_schema = 'public'
- 3722: 
+ 3722: UNION ALL
- 3723: 
+ 3723: SELECT
- 3724: 
+ 3724:   'Indexes',
- 3725: 
+ 3725:   COUNT(*)
- 3726: 
+ 3726: FROM pg_indexes
- 3727: 
+ 3727: WHERE schemaname = 'public';
