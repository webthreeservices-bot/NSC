const fs=require('fs'); const path=require('path'); const dirArg = process.argv[2] || 'database-schema/neon'; const dirPath = dirArg; const files=fs.readdirSync(dirPath).filter(f=>f.endsWith('.sql')).sort(); function split(s){ const blocks=[]; let out=''; let i=0; let inSingle=false; let inDouble=false; while(i<s.length){ const ch=s[i]; if(ch=="'" && !inDouble){ inSingle=!inSingle; out+=ch; i++; continue } if(ch=='"' && !inSingle){ inDouble=!inDouble; out+=ch; i++; continue } if(!inSingle && !inDouble && ch=='$'){ const m=s.slice(i).match(/^\$([A-Za-z0-9_]*)\$/); if(m){ const tag=m[1]; const open='$'+tag+'$'; const close=open; let j=i+open.length; let inS=false; let inD=false; let found=-1; while(j<s.length){ const ch2=s[j]; if(ch2=="'" && !inD){ inS=!inS; j++; continue } if(ch2=='"' && !inS){ inD=!inD; j++; continue } if(!inS && !inD && s.slice(j,j+close.length)===close){ found=j; break } j++ } if(found!=-1){ const token='__DOLLAR_'+blocks.length+'__'; blocks.push(s.slice(i, found+close.length)); out+=token; i=found+close.length; continue } } } out+=ch; i++ } const stmts=[]; let cur=''; inSingle=false; inDouble=false; for(let j=0;j<out.length;j++){ const ch=out[j]; if(ch=="'" && !inDouble){ inSingle=!inSingle; cur+=ch; continue } if(ch=='"' && !inSingle){ inDouble=!inDouble; cur+=ch; continue } if(ch==';' && !inSingle && !inDouble){ cur=cur.trim(); if(cur.length>0) stmts.push(cur+';'); cur=''; continue } cur+=ch } const last=cur.trim(); if(last.length>0) stmts.push(last); return stmts.map(s=>{ let o=s; blocks.forEach((b,idx)=>{ o=o.split('__DOLLAR_'+idx+'__').join(b); });return o }) } const issues=[]; for(const f of files){ const file=path.join(dirPath,f); const content=fs.readFileSync(file,'utf8'); const st=split(content); for(let i=0;i<st.length;i++){ const s=st[i]; if(s.includes('AS $$') && s.indexOf('BEGIN')===-1){ issues.push({file:f,index:i, snippet:s.slice(0,200)}) } } } console.log('checked', files.length, 'files'); if(issues.length>0){ console.log('issues',issues.length); for(const it of issues) console.log(it) }else console.log('no issues found')