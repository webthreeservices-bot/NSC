#!/usr/bin/env tsx  /**  * Admin Dashboard Database Check & Optimization Script  * Verifies database setup and performance for NeonDB admin dashboard  */  import { config } from 'dotenv' import { query, queryOne, queryScalar, execute, transaction } from '../lib/db' import pool from '../lib/db-connection'  config({ path: '.env.local' })  async function checkDatabaseSetup() {   console.log('üîç Checking Admin Dashboard Database Setup...\n')    try {     // 1. Check admin user     console.log('1Ô∏è‚É£ Checking Admin User...')     const adminUsers = await query({       where: { isAdmin: true },       select: {          id: true,          username: true,          email: true,          isAdmin: true,         createdAt: true,         lastLogin: true       },       take: 1     })     const adminUser = adminUsers[0]      if (adminUser) {       console.log('‚úÖ Admin user found:')       console.log(`   Email: ${adminUser.email}`)       console.log(`   Username: ${adminUser.username}`)       console.log(`   Last Login: ${adminUser.lastLogin || 'Never'}`)     } else {       console.log('‚ùå No admin user found!')       return     }      // 2. Check database indexes     console.log('\n2Ô∏è‚É£ Checking Database Indexes...')     const indexQuery = `       SELECT          schemaname,         tablename,         indexname,         indexdef       FROM pg_indexes        WHERE schemaname = 'public'       AND (         indexname LIKE '%_userId_%'          OR indexname LIKE '%_referralCode_%'         OR indexname LIKE '%_email_%'         OR indexname LIKE '%_status_%'         OR indexname LIKE '%_createdAt_%'       )       ORDER BY tablename, indexname;     `          const indexResult = await pool.query(indexQuery)     console.log(`‚úÖ Found ${indexResult.rows.length} performance indexes`)          if (indexResult.rows.length > 0) {       indexResult.rows.forEach(row => {         console.log(`   ${row.tablename}: ${row.indexname}`)       })     }      // 3. Check user statistics for admin dashboard     console.log('\n3Ô∏è‚É£ Checking User Statistics...')     const userStats = await Promise.all([       queryScalar(),       queryScalar({ where: { isActive: true } }),       queryScalar({ where: { isBlocked: true } }),       queryScalar({ where: { isEmailVerified: true } }),       queryScalar(),       queryScalar({ where: { status: 'ACTIVE' } }),       queryScalar(),       queryScalar({ where: { status: 'PENDING' } })     ])      console.log('‚úÖ User Statistics:')     console.log(`   Total Users: ${userStats[0]}`)     console.log(`   Active Users: ${userStats[1]}`)     console.log(`   Blocked Users: ${userStats[2]}`)     console.log(`   Verified Users: ${userStats[3]}`)     console.log(`   Total Packages: ${userStats[4]}`)     console.log(`   Active Packages: ${userStats[5]}`)     console.log(`   Total Withdrawals: ${userStats[6]}`)     console.log(`   Pending Withdrawals: ${userStats[7]}`)      // 4. Check admin logs table     console.log('\n4Ô∏è‚É£ Checking Admin Logs...')     const adminLogsExist = await pool.query(`       SELECT EXISTS (         SELECT FROM information_schema.tables          WHERE table_schema = 'public'          AND table_name = 'AdminLog'       );     `)      if (adminLogsExist.rows[0].exists) {       const logResults = await query({ take: 1 })       console.log(`‚úÖ AdminLog table exists with records available`)     } else {       console.log('‚ùå AdminLog table not found')     }      // 5. Check connection pool settings     console.log('\n5Ô∏è‚É£ Checking NeonDB Connection...')     const connectionInfo = await pool.query(`       SELECT          count(*) as total_connections       FROM pg_stat_activity       WHERE state = 'active';     `)      const maxConnections = await pool.query(`       SELECT setting as max_connections FROM pg_settings WHERE name = 'max_connections';     `)      console.log('‚úÖ Connection Info:')     console.log(`   Active Connections: ${connectionInfo.rows[0].total_connections}`)     console.log(`   Max Connections: ${maxConnections.rows[0].max_connections}`)      // 6. Check for missing critical indexes     console.log('\n6Ô∏è‚É£ Checking for Missing Critical Indexes...')     const criticalIndexes = [       { table: 'User', column: 'email', name: 'User_email_key' },       { table: 'User', column: 'referralCode', name: 'User_referralCode_key' },       { table: 'Package', column: 'userId', name: 'Package_userId_idx' },       { table: 'Withdrawal', column: 'userId', name: 'Withdrawal_userId_idx' },       { table: 'Withdrawal', column: 'status', name: 'Withdrawal_status_idx' }     ]      for (const index of criticalIndexes) {       const indexExists = await pool.query(`         SELECT EXISTS (           SELECT 1 FROM pg_indexes            WHERE schemaname = 'public'            AND tablename = $1            AND indexname = $2         );       `, [index.table, index.name])        if (indexExists.rows[0].exists) {         console.log(`‚úÖ ${index.name} exists`)       } else {         console.log(`‚ùå Missing index: ${index.name} on ${index.table}.${index.column}`)       }     }      // 7. Performance test query     console.log('\n7Ô∏è‚É£ Testing Admin Dashboard Query Performance...')     const startTime = Date.now()          await query({       take: 10,       orderBy: { createdAt: 'desc' },       include: {         _count: {           select: { packages: true }         }       }     })          const queryTime = Date.now() - startTime     console.log(`‚úÖ User query completed in ${queryTime}ms`)      console.log('\nüéâ Admin Dashboard Database Check Complete!')    } catch (error) {     console.error('‚ùå Database check failed:', error)     process.exit(1)   } finally {     await pool.end()   } }  // Run the check checkDatabaseSetup()